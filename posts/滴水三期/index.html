<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>PE - Notes</title><meta name="author" content="cjt">
<meta name="author-link" content="">
<meta name="description" content="1. PE头字段解析 PE(Portable Executable)文件，是windows上的可移植的可执行文件，常见的 .exe .dll .sys 等都是PE文件。那么PE文件和计算机网络的" /><meta name="keywords" content='PE' /><meta itemprop="name" content="PE">
<meta itemprop="description" content="1. PE头字段解析 PE(Portable Executable)文件，是windows上的可移植的可执行文件，常见的 .exe .dll .sys 等都是PE文件。那么PE文件和计算机网络的"><meta itemprop="datePublished" content="2023-02-07T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-04-25T00:00:00+00:00" />
<meta itemprop="wordCount" content="77779">
<meta itemprop="keywords" content="PE," /><meta property="og:title" content="PE" />
<meta property="og:description" content="1. PE头字段解析 PE(Portable Executable)文件，是windows上的可移植的可执行文件，常见的 .exe .dll .sys 等都是PE文件。那么PE文件和计算机网络的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cui-jiang-tao.github.io/posts/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PE"/>
<meta name="twitter:description" content="1. PE头字段解析 PE(Portable Executable)文件，是windows上的可移植的可执行文件，常见的 .exe .dll .sys 等都是PE文件。那么PE文件和计算机网络的"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://cui-jiang-tao.github.io/posts/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F/" /><link rel="prev" href="https://cui-jiang-tao.github.io/posts/bash%E8%84%9A%E6%9C%AC%E5%85%A5%E9%97%A8/" /><link rel="next" href="https://cui-jiang-tao.github.io/posts/c&#43;&#43;%E5%8F%8D%E6%B1%87%E7%BC%96%E6%8F%AD%E7%A7%98/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "PE",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/cui-jiang-tao.github.io\/posts\/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F\/"
    },"genre": "posts","keywords": "PE","wordcount":  77779 ,
    "url": "https:\/\/cui-jiang-tao.github.io\/posts\/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F\/","datePublished": "2023-02-07T00:00:00+00:00","dateModified": "2023-04-25T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "cjt"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Notes"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span><span id="typeit-header-desktop" class="typeit"></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Notes"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span><span id="typeit-header-title-mobile" class="typeit"></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>PE</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      cjt</span></span>
          <span class="post-category">included in <a href="/categories/%E9%80%86%E5%90%91/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 逆向</a></span></div>
      <div class="post-meta-line"><span title="published on 2023-02-07 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-07">2023-02-07</time></span>&nbsp;<span title="Updated on 2023-04-25 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-25">2023-04-25</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>77779 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>156 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-pe头字段解析">1. PE头字段解析</a>
      <ul>
        <li><a href="#11-dos头64个字节">1.1 DOS头(64个字节)</a></li>
        <li><a href="#12-pe文件头nt头">1.2 PE文件头(NT头)</a></li>
        <li><a href="#13-标准pe头20字节">1.3 标准PE头(20字节)</a></li>
        <li><a href="#14-可选pe头大小是不确定的">1.4 可选PE头(大小是不确定的)</a></li>
        <li><a href="#15-节表40字节">1.5 节表(40字节)</a>
          <ul>
            <li><a href="#151-联合体">1.5.1 联合体</a></li>
            <li><a href="#152-节表">1.5.2 节表</a></li>
          </ul>
        </li>
        <li><a href="#16-打印pe头信息">1.6 打印PE头信息</a></li>
      </ul>
    </li>
    <li><a href="#2-pe加载过程">2. PE加载过程</a>
      <ul>
        <li><a href="#21-filebuffer到imagebuffer常见的误区">2.1 FileBuffer到ImageBuffer常见的误区</a>
          <ul>
            <li><a href="#211-文件执行的总过程">2.1.1 文件执行的总过程</a></li>
            <li><a href="#212-sizeofrawdata一定大于miscvirtualsize">2.1.2 SizeOfRawData一定大于Misc.VirtualSize？</a></li>
          </ul>
        </li>
        <li><a href="#22-模拟pe加载过程">2.2 模拟PE加载过程</a></li>
      </ul>
    </li>
    <li><a href="#3-在代码空白区添加代码手动">3. 在代码空白区添加代码(手动)</a>
      <ul>
        <li><a href="#31-messagebox函数">3.1 MessageBox函数</a></li>
        <li><a href="#32-call与jmp指令的硬编码">3.2 call与jmp指令的硬编码</a></li>
        <li><a href="#33-效果说明">3.3 效果说明</a></li>
        <li><a href="#34-思路">3.4 思路</a></li>
        <li><a href="#35-实现">3.5 实现</a></li>
      </ul>
    </li>
    <li><a href="#4-在代码空白区添加代码编码">4. 在代码空白区添加代码(编码)</a></li>
    <li><a href="#5-新增节扩大节-添加代码">5. 新增节、扩大节-添加代码</a>
      <ul>
        <li><a href="#51-新增节思路">5.1 新增节思路</a>
          <ul>
            <li><a href="#511-满足新增节条件">5.1.1 满足新增节条件</a></li>
            <li><a href="#512-如果节表后面有编译器添加的数据">5.1.2 如果节表后面有编译器添加的数据</a></li>
            <li><a href="#513-整体上移后空间还不够大">5.1.3 整体上移后空间还不够大</a></li>
            <li><a href="#514-注意事项">5.1.4 注意事项</a></li>
          </ul>
        </li>
        <li><a href="#52-手动新增节添加代码">5.2 手动新增节添加代码</a></li>
        <li><a href="#53-代码实现">5.3 代码实现</a>
          <ul>
            <li><a href="#531-编程实现新增一个节并添加代码">5.3.1 编程实现：新增一个节，并添加代码</a></li>
            <li><a href="#532-编程实现扩大最后一个节并添加代码">5.3.2 编程实现：扩大最后一个节，并添加代码</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#6-扩大节合并节">6. 扩大节、合并节</a>
      <ul>
        <li><a href="#61-添加代码的方式">6.1 添加代码的方式</a></li>
        <li><a href="#62-合并节思路">6.2 合并节思路</a></li>
        <li><a href="#64-编码实现合并节">6.4 编码实现合并节</a></li>
      </ul>
    </li>
    <li><a href="#7-数据目录">7. 数据目录</a>
      <ul>
        <li><a href="#71-数据目录概述">7.1 数据目录概述</a>
          <ul>
            <li><a href="#711-数据目录的引入">7.1.1 数据目录的引入</a></li>
            <li><a href="#712-数据目录的作用">7.1.2 数据目录的作用</a></li>
            <li><a href="#713-数据目录有哪些">7.1.3 数据目录有哪些</a></li>
            <li><a href="#714-数据目录结构">7.1.4 数据目录结构</a></li>
            <li><a href="#715-数据目录和16种表的关系">7.1.5 数据目录和16种表的关系</a></li>
          </ul>
        </li>
        <li><a href="#72-编程输出全部目录项">7.2 编程输出全部目录项</a></li>
      </ul>
    </li>
    <li><a href="#8-导出表">8. 导出表</a>
      <ul>
        <li><a href="#81-导出表概述">8.1 导出表概述</a>
          <ul>
            <li><a href="#811-引入导出表">8.1.1 引入导出表</a></li>
            <li><a href="#812-常见误区">8.1.2 常见误区</a></li>
          </ul>
        </li>
        <li><a href="#82-导出表位置">8.2 导出表位置</a></li>
        <li><a href="#83-导出表的结构">8.3 导出表的结构</a></li>
        <li><a href="#84-由导出表获取函数地址">8.4 由导出表获取函数地址</a>
          <ul>
            <li><a href="#841-按名字找函数地址">8.4.1 按名字找函数地址</a></li>
            <li><a href="#842-按序号找函数地址">8.4.2 按序号找函数地址</a></li>
          </ul>
        </li>
        <li><a href="#85-编写程序打印导出表的信息">8.5 编写程序打印导出表的信息</a>
          <ul>
            <li><a href="#方式1">方式1</a></li>
            <li><a href="#方式2推荐">方式2(推荐)</a></li>
          </ul>
        </li>
        <li><a href="#86-编写按名字序号找导出函数地址信息">8.6 编写按名字、序号找导出函数地址信息</a>
          <ul>
            <li><a href="#861-按名字查找">8.6.1 按名字查找</a></li>
            <li><a href="#862-按序号查找函数">8.6.2 按序号查找函数</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#9-重定位表">9. 重定位表</a>
      <ul>
        <li><a href="#91-引入重定位表">9.1 引入重定位表</a></li>
        <li><a href="#92-引发的问题">9.2 引发的问题</a></li>
        <li><a href="#921-dll装载地址冲突">9.2.1 DLL装载地址冲突</a>
          <ul>
            <li><a href="#922-编译后的绝对地址">9.2.2 编译后的绝对地址</a></li>
          </ul>
        </li>
        <li><a href="#93-引入">9.3 引入</a></li>
        <li><a href="#94-重定位表">9.4 重定位表</a>
          <ul>
            <li><a href="#941-重定位表位置">9.4.1 重定位表位置</a></li>
            <li><a href="#942-重定位表结构">9.4.2 重定位表结构</a></li>
          </ul>
        </li>
        <li><a href="#95-页块节的关系">9.5 页、块、节的关系</a></li>
        <li><a href="#96-为什么学重定位表">9.6 为什么学重定位表</a></li>
        <li><a href="#97-打印重定位表信息">9.7 打印重定位表信息</a></li>
      </ul>
    </li>
    <li><a href="#10-移动导出表和重定位表">10. 移动导出表和重定位表</a>
      <ul>
        <li><a href="#101-移动导出表">10.1 移动导出表</a></li>
        <li><a href="#102-移动重定位表">10.2 移动重定位表</a></li>
        <li><a href="#103-修复重定位表">10.3 修复重定位表</a></li>
      </ul>
    </li>
    <li><a href="#11-iat表和导入表">11. IAT表和导入表</a>
      <ul>
        <li><a href="#111-iat表">11.1 IAT表</a></li>
        <li><a href="#112-导入表">11.2 导入表</a>
          <ul>
            <li><a href="#1121-导入表是什么">11.2.1 导入表是什么</a></li>
            <li><a href="#1122-定位导入表">11.2.2 定位导入表</a></li>
            <li><a href="#1123-导入表结构">11.2.3 导入表结构</a></li>
            <li><a href="#1124-iat表和int表">11.2.4 IAT表和INT表</a></li>
          </ul>
        </li>
        <li><a href="#113-打印程序运行前的导入表">11.3 打印程序运行前的导入表</a></li>
      </ul>
    </li>
    <li><a href="#12-绑定导入表">12. 绑定导入表</a>
      <ul>
        <li><a href="#121-引入绑定导入表">12.1 引入绑定导入表</a></li>
        <li><a href="#122-绑定导入表">12.2 绑定导入表</a></li>
        <li><a href="#123-打印绑定导入表">12.3 打印绑定导入表</a></li>
      </ul>
    </li>
    <li><a href="#13-导入表注入">13. 导入表注入</a>
      <ul>
        <li><a href="#131-注入">13.1 注入</a></li>
        <li><a href="#132-移动导入表">13.2 移动导入表</a></li>
        <li><a href="#133-设计要注入的dll">13.3 设计要注入的DLL</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="1-pe头字段解析">1. PE头字段解析</h2>
<p>PE(Portable Executable)文件，是windows上的可移植的可执行文件，常见的 <code>.exe</code>  <code>.dll</code>   <code>.sys</code> 等都是PE文件。那么PE文件和计算机网络的各种包头一样，都有自己独特的格式。</p>
<p>首先PE文件开头就是DOS头 <code>DOS_HEADER</code>，DOS头只需要看第一个字段<code>magic</code>和最后一个字段<code>lfanew</code>；<code>magic</code>字段为一个<code>WORD</code>即两字节，若为MZ则属于PE文件；<code>lfanew</code>是指向NT头<code>NT_HEADER</code>的相对偏移，即文件起始位置(magic字段所在位置)+ <code>lfanew</code> 即为NT头的位置。</p>
<p>可以用十六进制查看器查看会有更直观的印象。<code>lfanew</code>字段到NT头之间会有一段说明字符串或者垃圾数据称为<code>DOS stub</code></p>
<p>接下来NT头分为一个字段和两大部分，<code>Signature</code>字段，一大部分是<code>FILE_HEADER</code>(即COFF头或称文件头/标准PE头)，另一大部分是<code>OPTIONAL_HEADER</code> 可选头。注意<code>FILE_HEADER</code>一共有0x14的长度，可以看成一个大的结构体，结构体内容就是图中<code>_IMAGE_FILE_HEADER</code>的部分。<code>OPTIONAL_HEADER</code> 可选头。</p>
<p>同理过了NT头，就是节表<code>SECTION_HEADER</code> 了。节表类似于结构体数组的形式，图所示会有多个同样结构的<code>SECTION_HEADER</code>重复。</p>
<p><img loading="lazy" src="../../imgs/pe/PE.png" srcset="../../imgs/pe/PE.png, ../../imgs/pe/PE.png 1.5x, ../../imgs/pe/PE.png 2x" sizes="auto" data-title="&amp;ldquo;PE结构&amp;rdquo;" data-alt="&amp;ldquo;PE结构&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="11-dos头64个字节">1.1 DOS头(64个字节)</h3>
<table>
<thead>
<tr>
<th style="text-align:center">宽度</th>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">重要</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">e_magic</td>
<td style="text-align:center">*</td>
<td style="text-align:center">&ldquo;MZ标记&rdquo; 用于判断是否为可执行文件</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">e_lfanew</td>
<td style="text-align:center">*</td>
<td style="text-align:center">PE头相对于文件的偏移，用于定位PE文件</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>      <span class="c1">// DOS .EXE header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_magic</span><span class="p">;</span>                     <span class="c1">// Magic number  DOS头的标识，为4Dh和5Ah。分别为字母MZ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cblp</span><span class="p">;</span>                      <span class="c1">// Bytes on last page of file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cp</span><span class="p">;</span>                        <span class="c1">// Pages in file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_crlc</span><span class="p">;</span>                      <span class="c1">// Relocations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cparhdr</span><span class="p">;</span>                   <span class="c1">// Size of header in paragraphs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_minalloc</span><span class="p">;</span>                  <span class="c1">// Minimum extra paragraphs needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_maxalloc</span><span class="p">;</span>                  <span class="c1">// Maximum extra paragraphs needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ss</span><span class="p">;</span>                        <span class="c1">// Initial (relative) SS value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_sp</span><span class="p">;</span>                        <span class="c1">// Initial SP value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_csum</span><span class="p">;</span>                      <span class="c1">// Checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ip</span><span class="p">;</span>                        <span class="c1">// Initial IP value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cs</span><span class="p">;</span>                        <span class="c1">// Initial (relative) CS value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_lfarlc</span><span class="p">;</span>                    <span class="c1">// File address of relocation table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ovno</span><span class="p">;</span>                      <span class="c1">// Overlay number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>                    <span class="c1">// Reserved words
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_oemid</span><span class="p">;</span>                     <span class="c1">// OEM identifier (for e_oeminfo)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_oeminfo</span><span class="p">;</span>                   <span class="c1">// OEM information; e_oemid specific
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>                  <span class="c1">// Reserved words
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span>   <span class="n">e_lfanew</span><span class="p">;</span>                    <span class="c1">// File address of new exe header   指向IMAGE_NT_HEADERS的所在(PE头相对于文件的偏移，用于定位PE文件)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="n">IMAGE_DOS_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="mh">0x00</span> <span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>      <span class="c1">//5A4D * MZ标记用于判断是否为可执行文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x02</span> <span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>       <span class="c1">//0090
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x04</span> <span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>         <span class="c1">//0003
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x06</span> <span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>       <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x08</span> <span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>    <span class="c1">//0004
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x0a</span> <span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>   <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x0c</span> <span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>   <span class="c1">//FFFF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x0e</span> <span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>         <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x10</span> <span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>         <span class="c1">//00B8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x12</span> <span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>       <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x14</span> <span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>         <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x16</span> <span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>         <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18</span> <span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>     <span class="c1">//0040
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x1a</span> <span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>       <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x1c</span> <span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>     <span class="c1">//0000000000000000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x24</span> <span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>      <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x26</span> <span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>    <span class="c1">//0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x28</span> <span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>   <span class="c1">//20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x3c</span> <span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>    <span class="c1">//00000080 * PE头相对于文件的偏移，用于定位PE文件
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="12-pe文件头nt头">1.2 PE文件头(NT头)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">IMAGE_NT_HEADERS</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x00</span>      <span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>                         <span class="c1">//PE标识
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x04</span>      <span class="n">IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>            <span class="c1">//标准PE头(20字节)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18</span>      <span class="n">IMAGE_OPTIONAL_HEADER32</span> <span class="n">OptionalHeader</span><span class="p">;</span>  <span class="c1">//扩展PE头(大小不确定)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="n">IMAGE_NT_HEADERS</span><span class="p">,</span><span class="o">*</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-标准pe头20字节">1.3 标准PE头(20字节)</h3>
<table>
<thead>
<tr>
<th style="text-align:center">宽度</th>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">重要</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">Machine</td>
<td style="text-align:center">*</td>
<td style="text-align:center">程序运行的CPU型号：0x0 任何处理器/0x14C 386及后续处理器</td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">NumberOfSections</td>
<td style="text-align:center">*</td>
<td style="text-align:center">文件中存在的节的总数,如果要新增节或者合并节 就要修改这个值</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">TimeDateStamp</td>
<td style="text-align:center">*</td>
<td style="text-align:center">时间戳：文件的创建时间(和操作系统的创建时间无关)，编译器填写的</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">PointerToSymbolTable</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">NumberOfSymbols</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">SizeOfOptionalHeader</td>
<td style="text-align:center">*</td>
<td style="text-align:center">可选PE头的大小，32位PE文件默认E0h，64位PE文件默认为F0h，大小可以自定义</td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">Characteristics</td>
<td style="text-align:center">*</td>
<td style="text-align:center">每个位有不同的含义，可执行文件值为10F 即0 1 2 3 8位置1</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x00</span> <span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>              <span class="c1">//014C * 程序运行的CPU型号，0x0任何处理器/0x14C Intel 386及后续处理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x02</span> <span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>     <span class="c1">//0008 * 文件中存在的节的总数，除了头，还有几节数据，如果要新增节或者合并节就要修改这个值.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x04</span> <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>       <span class="c1">//3E22F0DF * 时间戳:文件的创建时间(和操作系统的创建时间无关)，编译器填写的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x08</span> <span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span><span class="c1">//00000000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x0c</span> <span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>     <span class="c1">//00000000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x10</span> <span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span> <span class="c1">//00E0 * 可选PE头的大小，32位PE文件默认E0h=16*14，64位PE文件默认为F0h，大小可以自定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x12</span> <span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>      <span class="c1">//010E * 每个位有不同的含义，可执行文件值为10F 即0 1 2 3 8位置1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_FILE_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="14-可选pe头大小是不确定的">1.4 可选PE头(大小是不确定的)</h3>
<p>程序入口 + 内存镜像基址 才是真正的地址</p>
<table>
<thead>
<tr>
<th style="text-align:center">宽度</th>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">重要</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">Magic</td>
<td style="text-align:center">**</td>
<td style="text-align:center">说明文件类型：10B 32位下的PE文件，20B 64位下的PE文件</td>
</tr>
<tr>
<td style="text-align:center">BYTE</td>
<td style="text-align:center">MajorLinkerVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">BYTE</td>
<td style="text-align:center">MinorLinkerVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfCode</td>
<td style="text-align:center">*</td>
<td style="text-align:center">所有代码节的和，必须是FileAlignment的整数倍，编译器填的。 没用</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfInitializedData</td>
<td style="text-align:center">*</td>
<td style="text-align:center">已初始化数据大小的和,必须是FileAlignment的整数倍 编译器填的  没用</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfUninitializedData</td>
<td style="text-align:center">*</td>
<td style="text-align:center">未初始化数据大小的和,必须是FileAlignment的整数倍 编译器填的  没用</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">AddressOfEntryPoint</td>
<td style="text-align:center">**</td>
<td style="text-align:center">程序入口</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">BaseOfCode</td>
<td style="text-align:center">*</td>
<td style="text-align:center">代码开始的基址，编译器填的   没用</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">BaseOfData</td>
<td style="text-align:center">*</td>
<td style="text-align:center">数据开始的基址，编译器填的   没用</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">ImageBase</td>
<td style="text-align:center">**</td>
<td style="text-align:center">内存镜像基址</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SectionAlignment</td>
<td style="text-align:center">**</td>
<td style="text-align:center">内存对齐</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">FileAlignment</td>
<td style="text-align:center">**</td>
<td style="text-align:center">文件对齐</td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MajorOperatingSystemVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MinorOperatingSystemVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MajorImageVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MinorImageVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MajorSubsystemVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">MinorSubsystemVersion</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">Win32VersionValue</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfImage</td>
<td style="text-align:center">**</td>
<td style="text-align:center">内存中整个PE文件的映射的尺寸，可以比实际的值大，但必须是SectionAlignment的整数倍</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfHeaders</td>
<td style="text-align:center">**</td>
<td style="text-align:center">所有头+节表按照文件对齐后的大小，否则加载会出错</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">CheckSum</td>
<td style="text-align:center">*</td>
<td style="text-align:center">校验和，一些系统文件有要求.用来判断文件是否被修改</td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">Subsystem</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">WORD</td>
<td style="text-align:center">DllCharacteristics</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfStackReserve</td>
<td style="text-align:center">*</td>
<td style="text-align:center">初始化时保留的堆栈大小</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfStackCommit</td>
<td style="text-align:center">*</td>
<td style="text-align:center">初始化时实际提交的大小</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfHeapReserve</td>
<td style="text-align:center">*</td>
<td style="text-align:center">初始化时保留的堆大小</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">SizeOfHeapCommit</td>
<td style="text-align:center">*</td>
<td style="text-align:center">初始化时实践提交的大小</td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">LoaderFlags</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DWORD</td>
<td style="text-align:center">NumberOfRvaAndSizes</td>
<td style="text-align:center">*</td>
<td style="text-align:center">目录项数目</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="mh">0x00</span> <span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span> <span class="c1">// 说明文件类型：10B-&gt;32位下的PE文件 20B-&gt;64位下的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x02</span> <span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x03</span> <span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x04</span> <span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span> <span class="c1">// 代码大小/所有代码节的和，必须是FileAlignment的整数倍 编译器填的 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x08</span> <span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span> <span class="c1">// 已初始化数据大小的和，必须是 FileAlignment的整数倍 编译器填的 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x0c</span> <span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span> <span class="c1">// 未初始化数据大小的和，必须是 FileAlignment的整数倍 编译器填的 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x10</span> <span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span> <span class="c1">// 程序入口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x14</span> <span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span> <span class="c1">// 代码开始的基址，编译器填的 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18</span> <span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span> <span class="c1">// 数据开始的基址，编译器填的 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x1c</span> <span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span> <span class="c1">// 内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x20</span> <span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span> <span class="c1">// 内存对齐，区段对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x24</span> <span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span> <span class="c1">// 文件对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x28</span> <span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x2a</span> <span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x2c</span> <span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x2e</span> <span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x30</span> <span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x32</span> <span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x34</span> <span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x38</span> <span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//镜像大小/ 内存中整个PE文件的映射的尺寸，可以比实际的值大，但必须是SectionAlignment的整数倍，是拉伸之后的大小，，，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x3c</span> <span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span> <span class="c1">// 所有头+节表，技照‘文件对齐 FileAlignment’后的大小，否则加载会出错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x40</span> <span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span> <span class="c1">// 校验和，一些系统文件有要求，用来判断文件是否被修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x44</span> <span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x46</span> <span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x48</span> <span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span> <span class="c1">// 初始化时保留的堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x4c</span> <span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span> <span class="c1">// 初始化时实际提交的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x50</span> <span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span> <span class="c1">// 初始化时保留的堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x54</span> <span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span> <span class="c1">// 初始化时实践提交的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x58</span> <span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x5c</span> <span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span> <span class="c1">// 目录项数目，RVA数目和大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x60</span> <span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//16个结构体，每个结构体是8个字节
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="15-节表40字节">1.5 节表(40字节)</h3>
<h4 id="151-联合体">1.5.1 联合体</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">union</span> <span class="nc">TestUnion</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>TestUnion联合体的占用的内存空间为：<code>max(sizeof(int), sizeof(char))</code> = <code>sizeof(int)</code></p>
<p>特点:</p>
<ol>
<li>联合体的成员是共享内存空间的</li>
<li>联合体的内存空间大小是联合体成员中对内存空间大小要求最大的空间大小</li>
<li>联合体最多只有一个成员有效</li>
</ol>
<h4 id="152-节表">1.5.2 节表</h4>
<p>一个PE文件有多少个节，就有多少个节表！每一个节表的大小是确定的，40字节。</p>
<p>如何确定有多少个节：可以通过标准PE头中的<code>NumberOfsections</code>字段的值来确定；确定了有多少个节，就确定了有多少一个节表，一个节表记录管理一个节的信息</p>
<p>一个PE文件从哪里开始是节表(硬盘上的地址)：DOS头大小 + 垃圾空位 + PE签名大小 + 标准PE头大小 + 可选PE头大小(需要查)；我们知道DOS头大小固定为64字节；PE签名大小为4字节；标准PE头大小固定为20字节；可选PE头大小可以通过标准PE头中的<code>SizeOfOptionalHeader</code>字段的值来确定：<code>e_lfanew + 4(Signature) + 20(标准PE头) + SizeOfOptionalHeader = 节表开始地址</code></p>
<p><strong>如果文件运行装载到内存中节表在4GB内存中的地址要加上imagebase的值，才是节表真正在内存中的起始地址。</strong></p>
<p>每一个节表的结构是一个结构体类型的，长度固定为0x28，即40字节。如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME              8						
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>						
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span>    <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>						<span class="c1">//8个字节 一般情况下是以&#34;\0&#34;结尾的ASCII码字符串来标识的名称，内容可以自定义.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span> <span class="p">{</span>						
</span></span><span class="line"><span class="cl">            <span class="n">DWORD</span>   <span class="n">PhysicalAddress</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">            <span class="n">DWORD</span>   <span class="n">VirtualSize</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">Misc</span><span class="p">;</span>						                                <span class="c1">//该节在没有对齐前的真实尺寸,该值可以不准确。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span>   <span class="n">VirtualAddress</span><span class="p">;</span>						                <span class="c1">//节区在内存中的偏移地址。加上ImageBase才是在内存中的真正地址.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span>   <span class="n">SizeOfRawData</span><span class="p">;</span>						                <span class="c1">//节在文件中对齐后的尺寸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span>   <span class="n">PointerToRawData</span><span class="p">;</span>						        	<span class="c1">//节区在文件中的偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span>   <span class="n">PointerToRelocations</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span>   <span class="n">PointerToLinenumbers</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span>    <span class="n">NumberOfRelocations</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span>    <span class="n">NumberOfLinenumbers</span><span class="p">;</span>						
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span>   <span class="n">Characteristics</span><span class="p">;</span>						            <span class="c1">//节的属性  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_SECTION_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">;</span>						
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Name	8个字节 一般情况下是以&quot;\0&quot;结尾的ASCII吗字符串来标识的名称，内容可以自定义.</li>
</ol>
<blockquote>
<p>注意：该名称并不遵守必须以&quot;\0&quot;结尾的规律，如果不是以&quot;\0&quot;结尾，系统会截取8个字节的长度进行处理.</p>
</blockquote>
<ol start="2">
<li>Misc  双字 是该节在没有对齐前的真实尺寸,该值可以不准确。</li>
<li>VirtualAddress 节区在内存中的偏移地址。加上ImageBase才是在内存中的真正地址.</li>
<li>SizeOfRawData  节在文件中对齐后的尺寸.</li>
<li>PointerToRawData 节区在文件中的偏移.</li>
<li><em>PointerToRelocations 在obj文件中使用 对exe无意义</em></li>
<li><em>PointerToLinenumbers 行号表的位置 调试的时候使用</em></li>
<li><em>NumberOfRelocations 在obj文件中使用  对exe无意义</em></li>
<li><em>NumberOfLinenumbers 行号表中行号的数量 调试的时候使用</em></li>
<li>Characteristics 节的属性</li>
</ol>
<p><img loading="lazy" src="../../imgs/pe/SECTION_HEADER.png" srcset="../../imgs/pe/SECTION_HEADER.png, ../../imgs/pe/SECTION_HEADER.png 1.5x, ../../imgs/pe/SECTION_HEADER.png 2x" sizes="auto" data-title="&amp;ldquo;节表&amp;rdquo;" data-alt="&amp;ldquo;节表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol>
<li>Name 该节的名字 可以随便改 只取前8个字节</li>
<li>Misc 下图中从A 到 B一共有多少个字节</li>
<li>VirtualAddress 在内存中的偏移 相对于ImageBase偏移</li>
<li>SizeOfRawData 下图中绿色块的大小</li>
<li>PointerToRawData 在文件中的偏移 下图中绿色块的开始地址</li>
<li>Characteristics 节的属性(可读、可写、可执行)</li>
</ol>
<p><img loading="lazy" src="../../imgs/pe/Buffer.png" srcset="../../imgs/pe/Buffer.png, ../../imgs/pe/Buffer.png 1.5x, ../../imgs/pe/Buffer.png 2x" sizes="auto" data-title="&amp;ldquo;Buffer&amp;rdquo;" data-alt="&amp;ldquo;Buffer&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="16-打印pe头信息">1.6 打印PE头信息</h3>
<p>使用<code>window.h</code> 都有相匹配的结构体，直接.或者-&gt;都能找到需要的字段，在VS中会识别出比这里更多的高亮，比如<code>DWORD</code> 、 <code>PIMAGE_DOS_HEADER</code> 之类的windows.h 才有的宏定义。</p>
<p>说明：一位16进制数占一个字节大小；在32位系统中，指针占用4字节空间，即指向的地址大小占用4字节，所以对地址的操作都要转换为<code>DWORD</code></p>
<p>方式1(推荐)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable:4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FILE_PATH &#34;CRACKME.EXE&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">analysis_PE_head</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">File_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 实例化PE文件头几个结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDosHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>			<span class="c1">// DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pNTHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>				<span class="c1">// NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_FILE_HEADER</span> <span class="n">pPEHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>			<span class="c1">// 标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_OPTIONAL_HEADER32</span> <span class="n">pOptionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="c1">// 可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pSectionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="c1">// SECTION(节)头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// PIMAGE_DOS_HEADER结构体类型转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">File_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 判断是不是有效的MZ标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PWORD</span><span class="p">)</span><span class="n">pDosHeader</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;不是有效的MZ标志!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================DOS头信息如下=============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;MZ标志：</span><span class="se">\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;PE偏移：</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 判断是不是有效的PE标志  =》 说明：一位16进制数占一个字节大小；在32位系统中，指针占用4字节空间，即指向的地址大小占用4字节。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">))</span> <span class="o">!=</span> <span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;不是有效的PE标志!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 类型转换 PIMAGE_NT_HEADERS结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pNTHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================NT头信息如下===============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NT:</span><span class="se">\t\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pNTHeader</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 类型转换 PIMAGE_FILE_HEADER结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pPEHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pNTHeader</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印标准PE文件头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================标准PE头信息如下============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Machine:</span><span class="se">\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">Machine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfSections:</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TimeDateStamp:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfOptionalHeader：</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Characteristics：</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 可选PE头的位置 = 标准PE的位置 + 标准PE头的大小(IMAGE_SIZEOF_FILE_HEADER)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pOptionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pPEHeader</span> <span class="o">+</span> <span class="n">IMAGE_SIZEOF_FILE_HEADER</span><span class="p">);</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 打印可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;==============================可选PE头信息如下==============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Magic：</span><span class="se">\t\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">Magic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfEntryPoint:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ImageBase:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SectionAlignment:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;FileAlignment:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfImage:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfHeaders:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 节表的位置 = 可选PE头的位置 + 可选PE头的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pSectionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pOptionHeader</span> <span class="o">+</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;==============================节表信息如下===============================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//printf(&#34;name:0x%s\n&#34;,pSectionHeader-&gt;Misc);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">dwNumberOfSection</span> <span class="o">=</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表的数量：%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwNumberOfSection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;0x%x\n&#34;,pPEHeader-&gt;NumberOfSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;IMAGE_SIZEOF_SHORT_NAME:0x%x\n&#34;,IMAGE_SIZEOF_SHORT_NAME);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;option_add:0x%x\n&#34;,pOptionHeader);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;psection_add:0x%x\n&#34;,pSectionHeader);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;==============================================================\n&#34;);*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwNumberOfSection</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;========================第%d个节信息：===============================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;section_name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Misc:</span><span class="se">\t\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;VirtualAddress:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfRawData:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;PointerToRawData:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Characteristics:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">printNTHeaders</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">input</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;文件打开失败&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算文件长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">input</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">end</span><span class="p">);</span>	<span class="c1">// 设置到文件的末尾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="kt">int</span> <span class="n">file_size</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">input</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span><span class="c1">// 重新设置到文件的开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 分配内存，并置零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">file_buffer</span><span class="p">(</span><span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//memset(file_buffer.data(), 0, file_size);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件写入file_buffer中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">input</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印PE头部信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">analysis_PE_head</span><span class="p">(</span><span class="n">file_buffer</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printNTHeaders</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>方式2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable:4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;malloc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define F_PATH &#34;CRACKME.EXE&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">FILE</span><span class="o">*</span> <span class="nf">open_file</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">file_path</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">open_mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">allocate_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">readfile2memory</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">file_buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">analysis_PE_head</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">File_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PrintNTHeaders</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//char file_path[] = &#34;C:\\Windows\\System32\\notepad.exe&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span> <span class="n">file_path</span><span class="p">[]</span> <span class="o">=</span> <span class="n">F_PATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">open_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;rb&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 打开文件,返回文件指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span> <span class="o">=</span> <span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算文件长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">file_size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 分配内存，并置零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">File_buffer</span> <span class="o">=</span> <span class="n">allocate_buffer</span><span class="p">(</span><span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件写入内存,并返回内存首地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">File_buffer</span> <span class="o">=</span> <span class="n">readfile2memory</span><span class="p">(</span><span class="n">File_buffer</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印PE头部信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">analysis_PE_head</span><span class="p">(</span><span class="n">File_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 释放内存、关闭文件流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">free</span><span class="p">(</span><span class="n">File_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FILE</span><span class="o">*</span> <span class="nf">open_file</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">file_path</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">open_mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">);</span>  <span class="c1">// fopen() 参数是字符串也就是常量指针类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">file_address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 计算文件的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">file_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">file_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">allocate_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">file_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">file_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;申请内存失败!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">file_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">file_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">readfile2memory</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">file_buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">FILE</span><span class="o">*</span> <span class="n">file_address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">file_buffer</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">file_address</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;从文件向内存中读取数据失败!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">file_buffer</span><span class="p">;</span> <span class="c1">// 如果写入内存成功，则返回内地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">analysis_PE_head</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">File_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 实例化PE文件头几个结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDosHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>			<span class="c1">// DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pNTHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>				<span class="c1">// NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_FILE_HEADER</span> <span class="n">pPEHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>			<span class="c1">// 标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_OPTIONAL_HEADER32</span> <span class="n">pOptionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="c1">// 可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pSectionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="c1">// SECTION(节)头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 强制类型转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">File_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 判断是不是有效的MZ标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PWORD</span><span class="p">)</span><span class="n">pDosHeader</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;不是有效的MZ标志!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">File_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 强制类型转换 PIMAGE_DOS_HEADER结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">File_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================DOS头信息如下=============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;MZ标志：</span><span class="se">\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;PE偏移：</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 判断是不是有效的PE标志  =》 说明：一位16进制数占一个字节大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">))</span> <span class="o">!=</span> <span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;不是有效的PE标志!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">File_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 强制类型转换 PIMAGE_NT_HEADERS结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pNTHeader</span> <span class="o">=</span> <span class="n">PIMAGE_NT_HEADERS</span><span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">File_buffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================NT头信息如下===============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NT:</span><span class="se">\t\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pNTHeader</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 强制类型转换 PIMAGE_FILE_HEADER结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pPEHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pNTHeader</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 打印标准PE文件头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;=============================标准PE头信息如下============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Machine:</span><span class="se">\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">Machine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfSections:</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TimeDateStamp:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfOptionalHeader：</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Characteristics：</span><span class="se">\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 可选PE头的位置 = 标准PE的位置 + 标准PE头的大小(IMAGE_SIZEOF_FILE_HEADER)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pOptionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pPEHeader</span> <span class="o">+</span> <span class="n">IMAGE_SIZEOF_FILE_HEADER</span><span class="p">);</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 打印可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;==============================可选PE头信息如下==============================</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Magic：</span><span class="se">\t\t\t\t</span><span class="s">0x%04X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">Magic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfEntryPoint:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ImageBase:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfImage:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfHeaders:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SectionAlignment:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;FileAlignment:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 节表的位置 = 可选PE头的位置 + 可选PE头的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pSectionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pOptionHeader</span> <span class="o">+</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;==============================节表信息如下===============================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//printf(&#34;name:0x%s\n&#34;,pSectionHeader-&gt;Misc);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">dwNumberOfSection</span> <span class="o">=</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表的数量：%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwNumberOfSection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;0x%x\n&#34;,pPEHeader-&gt;NumberOfSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;IMAGE_SIZEOF_SHORT_NAME:0x%x\n&#34;,IMAGE_SIZEOF_SHORT_NAME);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;option_add:0x%x\n&#34;,pOptionHeader);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;psection_add:0x%x\n&#34;,pSectionHeader);
</span></span></span><span class="line"><span class="cl"><span class="cm">	printf(&#34;==============================================================\n&#34;);*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwNumberOfSection</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;========================第%d个节信息：===============================</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;section_name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Misc:</span><span class="se">\t\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;VirtualAddress:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;SizeOfRawData:</span><span class="se">\t\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;PointerToRawData:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Characteristics:</span><span class="se">\t\t</span><span class="s">0x%08X</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PrintNTHeaders</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-pe加载过程">2. PE加载过程</h2>
<h3 id="21-filebuffer到imagebuffer常见的误区">2.1 FileBuffer到ImageBuffer常见的误区</h3>
<h4 id="211-文件执行的总过程">2.1.1 文件执行的总过程</h4>
<ul>
<li>我们知道一个硬盘上的文件读入到内存中(FileBuffer)，是原封不动的将硬盘上的文件数据复制一份放到内存中</li>
<li>接着如果文件要运行，需要先将FileBuffer中的文件数据&quot;拉伸&quot;，重载到每一个可执行文件的4GB虚拟内存中！此时称文件印象或者内存印象，即ImageBuffer</li>
<li>但是ImageBuffer就是文件运行时真正在内存中状态吗？或者说文件在ImageBuffer中就是表示文件被执行了吗？不！！！！！！</li>
<li><strong>在ImageBuffer中的文件数据由于按照一定的规则被&quot;拉伸&quot;，只是已经无线接近于可被windows执行的文件格式了！但是此时还不代表文件已经被执行了，因为此时文件也只是处在4GB的虚拟内存中，如果文件被执行操作系统还需要做一些事情，将文件真正的装入内存中，等待CPU的分配执行</strong></li>
<li>所以不要理解为ImageBuffer中的状态就是文件正在被执行，后面操作系统还要做很多事情才能让ImageBuffer中的文件真正执行起来的</li>
</ul>
<h4 id="212-sizeofrawdata一定大于miscvirtualsize">2.1.2 SizeOfRawData一定大于Misc.VirtualSize？</h4>
<ul>
<li>SizeOfRawData表示此节在硬盘上经过文件对齐后的大小；Misc.VirtualSize表示此节没有经过对齐的在内存中的大小。那么是不是说SizeOfRawData一定大于Misc.VirtualSize呢？不一定！！！！！！！</li>
<li>我们写C语言的时候知道如果你定义一个数组已经初始化，比如<code>int arr[1000] = {0};</code>，此时编译成.exe文件存放在硬盘上时，这1000个int类型的0肯定会存放在某一个节中，并且分配1000个0的空间，这个空间大小是多少，最后重载到ImageBuffer时还是多少，即Misc.VirtualSize不管文件在硬盘上还是内存中的值都是一致的。所以，SizeOfRawData一般都是大于Misc.VirtualSize的</li>
<li>但是如果我们定义成<code>int arr[1000];</code>，表示<strong>数据还未初始化</strong>，并且如果程序中没有使用过或初始化过这块内存空间，那么我们平时看汇编会发现其实编译器还没有做任何事情，这就只是告诉编译器需要留出1000个int宽度大小的内存空间。所以如果某一个节中存在已经被定义过但还未初始化的数据，那么文件在硬盘上不会显式的留出空间，即<strong>SizeOfRawData中不会算上未初始化数据的空间</strong>；但是此节的<strong>Misc.VirtualSize为加载到内存中时节的未对齐的大小，那么这个值就需要算上给未初始化留出来空间后的整个节的大小</strong>，故在内存中的节本身的总大小可能会大于硬盘中的此节文件对齐后的大小。</li>
</ul>
<h3 id="22-模拟pe加载过程">2.2 模拟PE加载过程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;malloc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define test 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">ToLoaderPE</span><span class="p">(</span><span class="n">LPSTR</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">CopyFileBufferToImageBuffer</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pFileBuffer</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pImageBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">CopyImageBufferToNewFileBuffer</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pImageBuffer</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pNewFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">MemoryToFile</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pMemBuffer</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">,</span> <span class="n">LPSTR</span> <span class="n">lpszFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//char file_path[] = &#34;C:\\Windows\\System32\\notepad.exe&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">file_path</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;notepad.exe&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">imageBuffer_file_path</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;imageBuffer.exe&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">fileBuffer_file_path</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;fileBuffer.exe&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//返回PE文件大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="nf">ToLoaderPE</span><span class="p">(</span><span class="n">LPSTR</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">pFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">FileSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">pFileBufferTemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pFile</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(ToLoaderPE)Can&#39;t open file!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">pFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">FileSize</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;FileBuffer: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">FileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">pFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pFileBufferTemp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">FileSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pFileBufferTemp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(ToLoaderPE)Allocate dynamic memory failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">n</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">pFileBufferTemp</span><span class="p">,</span> <span class="n">FileSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(ToLoaderPE)Read file failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">pFileBufferTemp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">pFileBuffer</span> <span class="o">=</span> <span class="n">pFileBufferTemp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pFileBufferTemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">FileSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">CopyFileBufferToImageBuffer</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pFileBuffer</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pImageBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDosHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pNTHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_FILE_HEADER</span> <span class="n">pPEHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_OPTIONAL_HEADER32</span> <span class="n">pOptionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pSectionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">pImageTemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyFileBufferToImageBuffer)Can&#39;t open file!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PWORD</span><span class="p">)</span><span class="n">pFileBuffer</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyFileBufferToImageBuffer)No MZ flag, not exe file!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">pFileBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">LPDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">))</span> <span class="o">!=</span>
</span></span><span class="line"><span class="cl">		<span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyFileBufferToImageBuffer)Not a valid PE flag!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pNTHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pPEHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">)(((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pNTHeader</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pOptionHeader</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pPEHeader</span> <span class="o">+</span> <span class="n">IMAGE_SIZEOF_FILE_HEADER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pSectionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pOptionHeader</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 分配内存中整个PE文件的映射的尺寸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pImageTemp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pImageTemp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyFileBufferToImageBuffer)Allocate dynamic memory failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">pImageTemp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">pImageTemp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// pOptionHeader-&gt;SizeOfHeaders：所有头+节表按照文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 填充所有头+节表(按照文件对齐的方式)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">pImageTemp</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pSectionHeaderTemp</span> <span class="o">=</span> <span class="n">pSectionHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">,</span> <span class="n">pSectionHeaderTemp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * VirtualAddress：节区在内存中的偏移地址。加上ImageBase才是在内存中的真正地址.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * PointerToRawData：节区在文件中的偏移
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * SizeOfRawData：节在文件中对齐后的尺寸
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pImageTemp</span> <span class="o">+</span> <span class="n">pSectionHeaderTemp</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeaderTemp</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="n">pSectionHeaderTemp</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;VirtualAddress%d: %#10x         PointerToRawData%d: %#10x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pImageTemp</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pFileBuffer</span> <span class="o">+</span> <span class="n">pSectionHeader</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">pImageBuffer</span> <span class="o">=</span> <span class="n">pImageTemp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pImageTemp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//内存中整个PE文件的映射的尺寸，可以比实际的值大，但必须是SectionAlignment的整数倍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">CopyImageBufferToNewFileBuffer</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pImageBuffer</span><span class="p">,</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pNewFileBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDosHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pNTHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_FILE_HEADER</span> <span class="n">pPEHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_OPTIONAL_HEADER32</span> <span class="n">pOptionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pSectionHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">pTempNewbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pImageBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyImageBufferToNewBuffer)Can&#39;t open file!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PWORD</span><span class="p">)</span><span class="n">pImageBuffer</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyImageBufferToNewBuffer)No MZ flag, not exe file!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">pImageBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pImageBuffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">))</span> <span class="o">!=</span>
</span></span><span class="line"><span class="cl">		<span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyImageBufferToNewBuffer)Not a valid PE flag!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pNTHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pImageBuffer</span> <span class="o">+</span> <span class="n">pDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pPEHeader</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pNTHeader</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 这里必须强制类型转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pOptionHeader</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pPEHeader</span> <span class="o">+</span> <span class="n">IMAGE_SIZEOF_FILE_HEADER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pSectionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pOptionHeader</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 计算ImageBuffer =&gt; FileBuffer的大小
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *		SizeOfHeaders：所有头+节表按照文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *		SizeOfRawData：节在文件中对齐后的尺寸
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">new_buffer_size</span> <span class="o">=</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">new_buffer_size</span> <span class="o">+=</span> <span class="n">pSectionHeader</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 分配内存(newbuffer)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pTempNewbuffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">new_buffer_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pTempNewbuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(CopyImageBufferToNewBuffer)Allocate dynamic memory failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 拷贝所有头+节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memset</span><span class="p">(</span><span class="n">pTempNewbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_buffer_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">pTempNewbuffer</span><span class="p">,</span> <span class="n">pDosHeader</span><span class="p">,</span> <span class="n">pOptionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 循环拷贝节区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * PointerToRawData：节区在文件中的偏移.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * VirtualAddress：节区在内存中的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * SizeOfRawData：节在文件中对齐后的尺寸
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pTempSectionHeader</span> <span class="o">=</span> <span class="n">pSectionHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pPEHeader</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">pTempSectionHeader</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pTempNewbuffer</span> <span class="o">+</span> <span class="n">pTempSectionHeader</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pImageBuffer</span> <span class="o">+</span> <span class="n">pTempSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="n">pTempSectionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//返回数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="n">pNewFileBuffer</span> <span class="o">=</span> <span class="n">pTempNewbuffer</span><span class="p">;</span> <span class="c1">//暂存的数据传给参数后释放
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pTempNewbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">new_buffer_size</span><span class="p">;</span> <span class="c1">// 返回计算得到的分配内存的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">MemoryToFile</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pMemBuffer</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">,</span> <span class="n">LPSTR</span> <span class="n">lpszFile</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">lpszFile</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fwrite</span><span class="p">(</span><span class="n">pMemBuffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">operate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">pFileBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">pNewFileBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">pImageBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">ret1</span> <span class="o">=</span> <span class="n">ToLoaderPE</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">file_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="n">pFileBuffer</span><span class="p">);</span> <span class="c1">// &amp;pFileBuffer(void**类型) 传递地址对其值可以进行修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;exe-&gt;filebuffer  返回值为计算所得文件大小：%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">ret2</span> <span class="o">=</span> <span class="n">CopyFileBufferToImageBuffer</span><span class="p">(</span><span class="n">pFileBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pImageBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;filebuffer -&gt; imagebuffer返回值为计算所得文件大小：%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MemoryToFile</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">,</span> <span class="n">ret2</span><span class="p">,</span> <span class="n">imageBuffer_file_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">ret3</span> <span class="o">=</span> <span class="n">CopyImageBufferToNewFileBuffer</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pNewFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;imagebuffer -&gt; newfilebuffer返回值为计算所得文件大小：%#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MemoryToFile</span><span class="p">(</span><span class="n">pNewFileBuffer</span><span class="p">,</span> <span class="n">ret3</span><span class="p">,</span> <span class="n">fileBuffer_file_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">pFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">pNewFileBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">pImageBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">operate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-在代码空白区添加代码手动">3. 在代码空白区添加代码(手动)</h2>
<h3 id="31-messagebox函数">3.1 MessageBox函数</h3>
<p>API函数–-MessageBoxA。包含在头文件windows.h；如果一个程序中包含user32.dll，则此程序就有MessageBoxA API函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">MessageBox</span><span class="p">(</span> <span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span><span class="n">LPCTSTR</span> <span class="n">lpText</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">lpCaption</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">nType</span> <span class="o">=</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>hWnd：表示窗口句柄，指定该对话框的所有者窗口；如果该参数为空(0/NULL)，则该对话框不属于任何窗口。</li>
<li>lpText：字符串，指显示在对话框中的内容。</li>
<li>lpCaption：字符串，指对话框的标题；如果此参数为空，则默认使用“错误”作为标题。</li>
<li>nType：指定显示按钮的数目及形式，表名使用的图标样式、缺省按钮是什么、以及消息框的强制回应等。</li>
</ul>
<h3 id="32-call与jmp指令的硬编码">3.2 call与jmp指令的硬编码</h3>
<ul>
<li>call指令的硬编码：E8 后面跟了4个字节(转换后的地址)</li>
<li>jmp指令的硬编码：E9 后面跟了4个字节(转换后的地址)</li>
<li>push指令的硬编码：6A 参数的值(传入函数参数的值是什么对应的参数硬编码就是什么)</li>
</ul>
<p>E8 和 E9 后面4字节地址X的转换公式：<strong>X = 真正要跳转的地址 - E8这条指令的下一行地址</strong>，因为call 地址的硬编码固定一共占5字节，所以E8指令的下一行地址 = E8当前地址 + 5；</p>
<p>所以公式最终为：<strong>X = 要跳转的地址 - (E8的地址 + 该指令长度)</strong></p>
<blockquote>
<p>注意：这些公式中所用到的地址值全部是可执行文件在虚拟内存中的地址值，不是文件地址！</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Function</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">vs2019_project_test.exe</span><span class="p">!</span><span class="no">main</span><span class="p">(</span><span class="no">int</span><span class="p">,</span> <span class="no">char</span> <span class="p">*</span> <span class="p">*):</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">E817A0</span> <span class="mi">55</span>                   <span class="no">push</span>        <span class="no">ebp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817A1</span> <span class="mi">8</span><span class="no">B</span> <span class="no">EC</span>                <span class="no">mov</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817A3</span> <span class="mi">81</span> <span class="no">EC</span> <span class="no">C0</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="no">sub</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">C0h</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817A9</span> <span class="mi">53</span>                   <span class="no">push</span>        <span class="no">ebx</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817AA</span> <span class="mi">56</span>                   <span class="no">push</span>        <span class="no">esi</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817AB</span> <span class="mi">57</span>                   <span class="no">push</span>        <span class="no">edi</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817AC</span> <span class="mi">8</span><span class="no">B</span> <span class="no">FD</span>                <span class="no">mov</span>         <span class="no">edi</span><span class="p">,</span><span class="no">ebp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817AE</span> <span class="mi">33</span> <span class="no">C9</span>                <span class="no">xor</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">ecx</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817B0</span> <span class="no">B8</span> <span class="no">CC</span> <span class="no">CC</span> <span class="no">CC</span> <span class="no">CC</span>       <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">CCCCCCCCh</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817B5</span> <span class="no">F3</span> <span class="no">AB</span>                <span class="no">rep</span> <span class="no">stos</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="no">es</span><span class="p">:[</span><span class="no">edi</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817B7</span> <span class="no">B9</span> <span class="mi">00</span> <span class="no">C0</span> <span class="no">E8</span> <span class="mi">00</span>       <span class="no">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">offset</span> <span class="no">_E4C34A80_main@cpp</span> <span class="p">(</span><span class="mi">0</span><span class="no">E8C000h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817BC</span> <span class="no">E8</span> <span class="mi">4</span><span class="no">B</span> <span class="no">FB</span> <span class="no">FF</span> <span class="no">FF</span>       <span class="no">call</span>        <span class="err">@</span><span class="no">__CheckForDebuggerJustMyCode@4</span> <span class="p">(</span><span class="mi">0</span><span class="no">E8130Ch</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817C1</span> <span class="mi">6</span><span class="no">A</span> <span class="mi">04</span>                <span class="no">push</span>        <span class="mi">4</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817C3</span> <span class="mi">6</span><span class="no">A</span> <span class="mi">03</span>                <span class="no">push</span>        <span class="mi">3</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817C5</span> <span class="mi">6</span><span class="no">A</span> <span class="mi">02</span>                <span class="no">push</span>        <span class="mi">2</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817C7</span> <span class="mi">6</span><span class="no">A</span> <span class="mi">01</span>                <span class="no">push</span>        <span class="mi">1</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817C9</span> <span class="no">E8</span> <span class="mi">95</span> <span class="no">F9</span> <span class="no">FF</span> <span class="no">FF</span>       <span class="no">call</span>        <span class="no">Function</span> <span class="p">(</span><span class="mi">0</span><span class="no">E81163h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817CE</span> <span class="mi">83</span> <span class="no">C4</span> <span class="mi">10</span>             <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">10</span><span class="no">h</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817D1</span> <span class="mi">33</span> <span class="no">C0</span>                <span class="no">xor</span>         <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817D3</span> <span class="mi">5</span><span class="no">F</span>                   <span class="no">pop</span>         <span class="no">edi</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817D4</span> <span class="mi">5</span><span class="no">E</span>                   <span class="no">pop</span>         <span class="no">esi</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817D5</span> <span class="mi">5</span><span class="no">B</span>                   <span class="no">pop</span>         <span class="no">ebx</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817D6</span> <span class="mi">81</span> <span class="no">C4</span> <span class="no">C0</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">C0h</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817DC</span> <span class="mi">3</span><span class="no">B</span> <span class="no">EC</span>                <span class="no">cmp</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817DE</span> <span class="no">E8</span> <span class="mi">52</span> <span class="no">FA</span> <span class="no">FF</span> <span class="no">FF</span>       <span class="no">call</span>        <span class="no">__RTC_CheckEsp</span> <span class="p">(</span><span class="mi">0</span><span class="no">E81235h</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817E3</span> <span class="mi">8</span><span class="no">B</span> <span class="no">E5</span>                <span class="no">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">ebp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817E5</span> <span class="mi">5</span><span class="no">D</span>                   <span class="no">pop</span>         <span class="no">ebp</span>  
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">E817E6</span> <span class="no">C3</span>                   <span class="no">ret</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p>计算E8后面跟的4字节地址:</p>
<p>因为E8的当前地址为0x00E817C9，真正要跳转的Function函数的地址为0x0E81163，所有根据公式：X = 要跳转的地址 - (E8的地址 + 该指令长度) = 0x0E81163 - (0x00E817C9 + 5)= 0xFFFFF995，由于内存是低地址向高地址存储，所以为95 F9 FF FF，所以最后call指令的硬编码为E8 95 F9 FF FF</p>
<h3 id="33-效果说明">3.3 效果说明</h3>
<p>我们将一段MessageBox函数添加到一个可执行文件中，当我们双击此文件时先弹出我们写的弹框窗口，点击确定按钮后再重新正常执行文件。所以我们的目的就是将此可执行文件的入口改成我们添加的代码位置，执行完代码后再jmp到此文件的原来的入口地址。</p>
<blockquote>
<p>注意在代码节空白区添加代码相当于给在硬盘上的文件中添加数据，添加完后再运行文件，所以这个过程可以理解为文件注入；但是我们平时说的注入，则是文件在运行时我把代码添加进去，这个过程可以理解为内存注入。</p>
</blockquote>
<h3 id="34-思路">3.4 思路</h3>
<p>程序其实就是一堆二进制数据组成的，所以我们不可能直接将MessageBox函数加到一个可执行文件中，而是要想办法得到这个函数<strong>对应的二进制数据</strong>，将这些数据添加到文件中。</p>
<p>但是我们没必要去自己再去写一个MessageBox函数的二进制，因为只要是user32的可执行文件中都会调用系统API函数–-MessageBoxA，所以我们只要找到此文件中的MessageBox函数的地址，使用call 这个地址，在call之前先push需要的4个参数就等于使用了弹框的功能。因为最终我们要添加的是二进制数据，所以我们要知道传入4个参数的指令硬编码和<code>call MessageBox</code>地址指令对应的硬编码，最后再加上一个<strong>jmp 程序原来的入口地址对应的硬编码</strong>即可。</p>
<blockquote>
<p>但是这个思路有一个小问题，换一个机器就用不了了，后面学习会知道原因。</p>
</blockquote>
<p>获取运行时MessageBoxAPI函数的地址：</p>
<ul>
<li>使用OD打开可执行文件，在左下角的命令栏输入：<code>bp MessageBoxA</code> 回车，表示在此函数起始位置设置断点，接着我们点击上方栏中的B按钮，表示查看断点，接着双击我们刚设置的断点会跳转到断点所在位置，这个地址就是MessageBoxA函数的起始地址。</li>
</ul>
<p>记下来此程序本来的入口地址：通过可选PE头中的AddressOfEntryPoint字段值可以知道程序入口地址的偏移量，再通过可选PE头中的ImageBase字段知道文件装载到内存中的起始地址，根据ImageBase + AddressOfEntryPoint可以得出来程序在虚拟内存中的真正的入口地址。</p>
<p>按照要求，我们只需要构造这样一个功能的代码：</p>
<ol>
<li>push MessageBox函数需要的4个参数；</li>
<li>call MessageBox函数地址；</li>
<li>jmp 程序原来的入口地址。</li>
</ol>
<p><strong>先初步判断空白区的长度是否能存放得下添加的硬编码(使用节对应的节表中的 SizeOfRawData - Misc.VirtualSize 计算空白区的大小)</strong>。因为push4个参数，一个push硬编码长度为2字节；call和jmp硬编码长度为5字节；加起来一共是18字节。</p>
<p>接着将这个功能的代码转换成对应的硬编码：其中需要计算E8 和 E9后面的地址，所以要用公式X = 要跳转的地址 - (E8的地址 + 5)进行计算，如果我们使用UE编辑器打开可执行文件进行编辑修改，由于UE编辑器打开的文件是在硬盘上的状态，即我们如果在UE或者winhex中改数据是改的FileBuffer中的数据，不是ImageBuffer中的，则公式的地址都是需要从文件地址转换成内存地址后再计算的！</p>
<blockquote>
<p>如果是ipmsg.exe，由于在文件对齐和内存对齐是一样的，所以文件在硬盘上的数据格式和加载到内存中的格式是一样的，那使用UE打开上面显式的地址是什么就用就行，因为文件地址此时等于内存地址。但是如果是notepad.exe等，文件对齐和内存对齐不一样，从硬盘加载到内存是需要&quot;拉伸&quot;的，所以如果此时用UE添加硬编码计算E8 E9后面的地址值时需要使用内存地址，所以多了一个FOA转化成RVA的过程。</p>
</blockquote>
<p>定位到任意一个节后面的空白区，将这段硬编码加到任意节的空白区中，但是最好是代码节中(节的名字一般默认为.text)，因为代码区的属性一般是可执行的，所以加到代码节中不用修改节的characteristic属性。记下来这段添加的硬编码的起始偏移地址。</p>
<p>我们如果写程序来模拟这个过程，添加硬编码在&quot;拉伸&quot;后的文件中添加。</p>
<blockquote>
<p>为什么要在拉伸后的文件中添加：因为我们添加的硬编码中有call和jmp指令后面的地址，这个地址是要转化能得到的—X = 要跳转的地址 - (E8的地址 + 5)，转换完才得到了添加的代码的完整硬编码，而地址转化公式中使用的E8当前的地址 + 5，这个E8当前的地址值为文件运行时装入4GB内存(拉伸后)后的值；而且公式中要跳转的地址也是文件装入内存后的MessageBoxA函数的地址。综上我们应该将要添加的硬编码添加到拉伸后的文件任意节的空白区中，这样更方便计算E8 和 E9后面跟的地址值。如果我们想在文件在硬盘上的状态中添加也可以，但是计算E8 和 E9 后面跟的地址值使用公式前，还要自己先把文件地址转换成内存地址，就比较麻烦。</p>
</blockquote>
<p>最后找到程序的AddressOfEntryPoint字段所在地址，将此字段的值改为添加的硬编码的偏移地址。</p>
<h3 id="35-实现">3.5 实现</h3>
<p>开始在FileBuffer中添加代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">bp MessageBoxA：0x77D507EA  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AddressOfEntryPoint程序入口：0x0000739D
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ImageBase装载地址：0x01000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.txt 
</span></span><span class="line"><span class="cl">	VirtualAddress内存中的偏移地址: 0x1000
</span></span><span class="line"><span class="cl">	VirtualSize该节在没有对齐前的真实尺寸: 0x7748
</span></span><span class="line"><span class="cl">	PointerToRawData节区在文件中的偏移:0x400
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">加入代码的地方 0x7B48 = PointerToRawData + VirtualSize = 0x7748 + 0x400
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">通过下一个节表的PointerToRawData字段值为0x7c00，综合0x7172可以判断出.text节的空白区大小为0x7c00 - 0x7B48 = 0xB8。空间还很大，所以我们可以将代码添加在这个空白区的任意大小合适的位置。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">接着就是构造ShellCode：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">从0x7B48处填充：6A 00 6A 00 6A 00 6A 00 E8 00 00 00 00 E9 00 00 00 00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">由于现在加的位置是文件在硬盘上的地址，不是加载到ImageBuffer中的地址，所以要做地址转换。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.text节在内存中的起始地址 VirtualAddress + ImageBase：0x1000 + 0x01000000 = 0x1001000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">E8的文件地址: 0x7B50   相对于.txt的偏移位置：0x7750 = 0x7B50 - PointerToRawData = 0x7B50 - 0x400
</span></span><span class="line"><span class="cl">E8的内存地址：0x7750 + 0x1001000 = 0x1008750
</span></span><span class="line"><span class="cl">E8后面的 MessageBoxA - (E8的内存地址+5): 0x77D507EA - 0x1008750 - 5 = 0x76D48095
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">E9的文件地址: 0x7B55   相对于.txt的偏移位置：0x7755 = 0x7B55 - PointerToRawData = 0x7B55 - 0x400
</span></span><span class="line"><span class="cl">E9的内存地址：0x7755 + 0x1001000 = 0x1008755
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">实际程序加载到内存的入口：运行入口AddressOfEntryPoint + ImageBase：0x0000739D + 0x01000000 = 0x100739D
</span></span><span class="line"><span class="cl">E9后面的 运行入口 - (E9的内存地址+5): 0x100739D - 0x1008755- 5 = 0x76D48090 = 0xFFFFEC43
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">E9相当于最终调转到实际程序加载到内存的入口的地方。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">最终0x7B48处填充：6A 00 6A 00 6A 00 6A 00 E8 95 80 D4 76 E9 43 EC FF FF
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">加入代码的地方的内存入口 VirtualSize + VirtualAddress：0x7748 + 0x1000 = 0x8748
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">重新设置AddressOfEntryPoint程序入口 = 0x8748
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-在代码空白区添加代码编码">4. 在代码空白区添加代码(编码)</h2>
<p>我们用OD打开一个文件，模拟的是文件真正运行时的状态，所以此时左侧栏显示的所有地址都是内存地址，文件的起始地址就是ImageBase</p>
<p>我们使用UE和winhex打开一个文件，起始就是一个将文件在硬盘上时的数据复制一份存到FileBuffer内存中，所以此时左侧栏显示的地址是文件地址，文件的起始地址是逻辑地址地址为0x0</p>
<p>我们使用winhex–tools–open ram打开一个正在运行时的文件，此时左侧栏显示的地址就是文件真正运行时的内存地址，文件的起始地址就是ImageBase</p>
<p>我们如果使用C语言来模拟FileBuffer-&gt;ImageBuffer-&gt;NewBuffer的过程：</p>
<ul>
<li>由于我们使用malloc开辟一块内存空间模拟FileBuffer，这块内存的起始地址就不在是我们说的文件在硬盘上的起始逻辑地址0x0，而是随机动态分配的一个起始地址，所以我们在计算FileBuffer中的地址时，就要注意偏移量加的不是0x0了，而是要用偏移量加上动态分配的起始地址才是在FileBuffer中地址。</li>
<li>接着如果我们再模拟拉伸的过程，即FileBuffer到ImageBuffer的过程时，由于也使用malloc动态给ImageBuffer分配内存，所以此时ImageBuffer中文件起始地址不再是ImageBase，而也是一个随机分配的地址，所以我们使用动态分配的起始地址加偏移量的方式计算ImageBuffer中的地址时，就不是加ImageBase！而且我们计算call和jmp等硬编码E8、E9后面的4字节值时，需要用到的E8、E9当前的内存地址不是现在在ImageBuffer中的值，因为这也只是我们模拟出来的文件运行状态的ImageBuffer，而不是最后程序在操作系统上真正装入内存时的状态，所以我们此时计算E8当前的内存地址还要想象一下文件真正被执行的状态，那么起始地址就要用ImageBase了，用这个值来计算E8、E9后面要跟的4字节值。</li>
<li>包括最后ImageBuffer到NewBuffer的过程也是同样如此</li>
</ul>
<p>文件双击真正运行时的起始地址就为ImageBase的值了</p>
<p><img loading="lazy" src="../../imgs/pe/FileBufferToImageBuffer.png" srcset="../../imgs/pe/FileBufferToImageBuffer.png, ../../imgs/pe/FileBufferToImageBuffer.png 1.5x, ../../imgs/pe/FileBufferToImageBuffer.png 2x" sizes="auto" data-title="&amp;quot;&amp;quot;" data-alt="&amp;quot;&amp;quot;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MessageBox_Address 0x754034B0 </span><span class="c1">//宏定义的MessageBox内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;CRACKME.EXE&#34;</span><span class="p">;</span>  <span class="c1">//你要打开的PE文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;new_CRACKME.exe&#34;</span><span class="p">;</span> <span class="c1">//保存路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//shellcode：定义要添加的硬编码全局变量，确定的写好，不确定的先用0x00填充，后面计算完再改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BYTE</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE9</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//_IMAGE_DATA_DIRECTORY DataDirectory[16];  //这个先不管
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*FileBuffer到ImageBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;动态申请ImageBuffer内存失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 复制所有头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件中的节表复制到内存上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*ImageBuffer到NewBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//重新计算newBuffer需要大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/*方法一:SizeOfHEADER + 所有节的SizeOfRawData之和
</span></span></span><span class="line"><span class="cl"><span class="cm">	int sizeofSections = 0;
</span></span></span><span class="line"><span class="cl"><span class="cm">	_IMAGE_SECTION_HEADER* _image_section_header_temp = _image_section_header;
</span></span></span><span class="line"><span class="cl"><span class="cm">	for(DWORD int i = 0;i &lt; _image_file_header-&gt;NumberOfSections;i++){
</span></span></span><span class="line"><span class="cl"><span class="cm">		sizeofSections += _image_section_header_temp-&gt;SizeOfRawData;
</span></span></span><span class="line"><span class="cl"><span class="cm">		_image_section_header_temp++;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}
</span></span></span><span class="line"><span class="cl"><span class="cm">	char* newBufferp = (char*)malloc(_image_optional_header-&gt;SizeOfHeaders + sizeofSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//方法二:使用最后一个节的文件偏移地址 + 最后一个节对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NewBuffer内存分配失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向第一个节.text中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0则注入失败，1则注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/** 
</span></span></span><span class="line"><span class="cl"><span class="cm">	*  用SizeofRawData - VirtualSize判断空白区是否存的下shellcode：这里要考虑到一个问题：我们使用的是secp-&gt;VirtualAddress + secp-&gt;Misc.VirtualSize来确定内存中此节的空白区的偏移起始地址，
</span></span></span><span class="line"><span class="cl"><span class="cm">	*  这个算法是没错的，但是还记得前面将FileBuffer装载到ImageBuffer时我们复制每个节的长度是按照SizeOfRawData复制的，而且ImageBuffer到NewBuffer也是每个节按照SizeOfRawData复制的。
</span></span></span><span class="line"><span class="cl"><span class="cm">	*  那么如果某一个节的VirtualSize&gt;SizeOfRawData，就会出现我们添加代码的地方确实在节装入内存时的空白区，
</span></span></span><span class="line"><span class="cl"><span class="cm">	*  但是最后ImageBuffer到NewBuffer时，复制的时候只复制了这个节开始的SizeOfRawData个字节，我们加的代码并没有复制进去，就可能出现问题，所以干脆直接要求SizeOfRawData &gt; VirtualSize才能注入
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此节空白区大小不够，添加失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到节空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcode_ptr</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">;</span>	<span class="c1">//计算插入代码的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcode_ptr</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcode_ptr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcode_ptr</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcode_ptr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">-</span> <span class="p">(</span><span class="n">shellcode_ptr</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcode_ptr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="n">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 注入提示框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_shellcode</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;shellcode注入失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="n">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-新增节扩大节-添加代码">5. 新增节、扩大节-添加代码</h2>
<h3 id="51-新增节思路">5.1 新增节思路</h3>
<h4 id="511-满足新增节条件">5.1.1 满足新增节条件</h4>
<p>为什么新增节来添加代码呢？因为有时所有节的空白区可能都不够存放我们要添加的代码，所以我们自己新增足够大的节来添加代码。</p>
<p>可以添加一个节表(新增节就要新增一个节表来记录此节信息)，首先判断是否有足够的空间；判断方法：SizeOfHeaders - (DOS + 垃圾数据 + PE标记 + 标准PE头 + 可选PE头 + 已存在节表) &gt;= 2个节表的大小</p>
<blockquote>
<p>为什么需要2个节表大小：有时windows会根据一个结构后面是否有多个0x00来判断这个结构是否结束，所以算是windows规定的格式吧。故最后一个节表后面还要补跟节表宽度一样的0；但是其实最后一个节表后面不是40个0或者跟了一些其他数据也是可行的，但由于没有满足规定的格式要求，不知道什么时候就不好使了，所以我们新增节表时还是按照标准规定来。</p>
</blockquote>
<p>如果满足添加节表的条件，此时我们可以将已有的一个节表的40字节信息复制一份紧挨着最后一个节表的末尾(节表之间必须要挨着！这是规定)，然后再往后的40字节全部补0，接下来就是根据新增节的信息，去修改对应节表的字段值即可。</p>
<p>需要修改的数据：</p>
<ul>
<li>
<p>修改标准PE头中NumberOfSections字段(节的数量)。</p>
</li>
<li>
<p>修改SizeOfImage的大小(原有值 + 新增节的大小，最后还要内存对齐)。</p>
</li>
<li>
<p>在文件的最后，新增节(添加时，节的大小如果设置为内存对齐的整数倍，后面就不用再担心对齐的事)。</p>
</li>
<li>
<p>修正新增节表的属性：</p>
<ul>
<li>Name，这个按照ASCII码随便取，最好长度限制在8字节内。</li>
<li>Misc.VirtualSize，如果此时我们还不知道添加的数据长度(没对齐前)，那么直接就按照对齐后的大小写即可，比如我们要新增节大小为0x1000(考虑了内存对齐)，那么不管里面要用多少字节数据，VirtualSize的值就按照0x1000写。</li>
<li>VirtualAddress(内存起始偏移地址)，我们通过上一个节表的VirtualAddress + VirtualSize内存对齐后，得到上一个节内存对齐后的结尾位置，所以新增节表的VirtualAddress就是这个值。</li>
</ul>
<blockquote>
<p>千万不能用SizeOfRawData来判断，因为这个节的VirtualSize可能大于SizeOfRawData，因为包含未初始化数据，那么此时在内存中应该按照VirtualAddress + VirtualSize内存对齐后的得到的值来存储。</p>
</blockquote>
<blockquote>
<p>我们发现有时候文件内存中未对齐的大小确实比文件中对齐的大小大(由于节中包含初始化数据的缘故)，比如notepad.exe文件的第二个节.data中，内存中的大小为0x1BA8，但是文件中对齐后的大小为0x600。此时我们可以发现，第三个节在文件中就按照上一个节在文件中对齐后的大小往后接着存放，即0x7200 + 0x600 = 0x7800，所以第三个节的PointerToRawData为0x7800，而第三个节在内存中就按照上一个节在内存中对齐后的大小往后接着存放(就不是再按照上一个节的文件中对齐大小挨着存放了，因为此时VirtualSize比SizeOfRawData大)，即0x8000 + 0x1BA8 = 0x9BA8，对齐后为0xA000，所以第三个节内存偏移为0xA000</p>
</blockquote>
<blockquote>
<p><img loading="lazy" src="../../imgs/pe/SectionTable.png" srcset="../../imgs/pe/SectionTable.png, ../../imgs/pe/SectionTable.png 1.5x, ../../imgs/pe/SectionTable.png 2x" sizes="auto" data-title="&amp;quot;&amp;quot;" data-alt="&amp;quot;&amp;quot;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
</blockquote>
</li>
<li>
<p>SizeOfRawData，根据文件对齐粒度来修正这个值，比如上面如果设定了VirtualSize的值为0x1000，说明这个节的这0x1000字节都是有用数据，那么此节在硬盘上时也应该有这0x1000字节的数据，所以此时根据文件对齐粒度来修正这个值，如果为0x200或者0x1000，就不用修改0x1000，因为已经满足是文件对齐的整数倍了</p>
</li>
<li>
<p>PointerToRawData，文件对齐后的文件地址，我们可以通过上一个节表的PointerToRawData + SizeOfRawData计算得到此值</p>
</li>
<li>
<p>Characteristics，按照我们想要的属性来修改即可(可读、可写、可执行等)</p>
</li>
<li>
<p>SizeOfHeaders的值不要随便改变，因为如果这个值变了，后面的节都要跟着往后或者往前跟着变，但是这些节当中凡是涉及到地址的计算相关的就会改变，比如说我们昨天加的E8和E9后面的值，是通过其他的地址计算出来的，如果SizeOfHeaders变了，节地址跟着变，那么这些值也要改变，所以代价很高，不建议修改</p>
</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/SizeOfHeader.png" srcset="../../imgs/pe/SizeOfHeader.png, ../../imgs/pe/SizeOfHeader.png 1.5x, ../../imgs/pe/SizeOfHeader.png 2x" sizes="auto" data-title="&amp;ldquo;SizeOfHeader&amp;rdquo;" data-alt="&amp;ldquo;SizeOfHeader&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="512-如果节表后面有编译器添加的数据">5.1.2 如果节表后面有编译器添加的数据</h4>
<p>有些程序会在节表到节的空白区之间添加一些信息，由于添加的新节表一定要与原来的节表紧挨着，但是我们又不知道程序的这些信息是否有用、是否影响程序的正常运行，所以此时我们不能轻易修改覆盖这些内容，那么我们如果要添加新节表就需要想办法：我们知道程序的DOS头到PE签名之间有一处区域DOS Stub，不影响程序的运行，数据也是程序的一些说明信息，对我们来说就是垃圾数据，所以我们可以将NT头到节表末尾这一部分整体上移，把Dos Stub这块数据覆盖了，接着修改DOS头中的e_lfanew字段的值为上移后PE签名的地址即可，那么此时下面就会空出来一部分，我们就可以先将这部分全部修改成0x00，再往这片区域新增节表即可。</p>
<h4 id="513-整体上移后空间还不够大">5.1.3 整体上移后空间还不够大</h4>
<p>如果向上覆盖DOS Stub之后，还不够新增节表的大小，那么我们就采用扩大最后一个节的方式，将添加的代码加到最后一个节扩大的空间中，这样可以保证不影响上面的所有地址。</p>
<h4 id="514-注意事项">5.1.4 注意事项</h4>
<p>文件加载到内存中，最后一个节的VirtualAddress + VirtualSize对齐后的结尾一定就是一个文件在内存中的结束位置，即SizeOfImage；文件在硬盘上时，最后一个节的PointerToRawData + SizeOfRawData的值一定就是整个文件的结尾！</p>
<p>不管是往节的空白区中添加代码还是新增节、扩大节，如果用编程来实现，应该在ImageBuffer中操作更方便，即拉伸后来操作，不管是一些值的计算还是位置的选择上都要更方便一些。</p>
<p>加载到内存中，要看节之间怎么排的，应该根据VirtualAddress和VirtualSize以及内存对齐来判断；如果在硬盘上，节之间怎么排的，应该根据PointerToRawData和SizeOfRawData以及文件对齐来判断。</p>
<h3 id="52-手动新增节添加代码">5.2 手动新增节添加代码</h3>
<h3 id="53-代码实现">5.3 代码实现</h3>
<p><strong>定义函数，能够返回对齐后的大小：</strong></p>
<p>定义一个函数Align(int x,int y)，第一个参数为我们手动输入的字节大小，第二个参数为文件对齐大小或者内存对齐大小，现在功能是如果我们传入0x222字节，文件对齐大小为0x200，那么计算0x222文件对齐后的大小为多少；如果传入0x1222字节，内存对齐大小为0x1000，那么计算0x1222内存对齐后的大小是多少。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 计算最小公倍数函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="nf">alignment</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">num</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">align_num</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//用int也行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">align_num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;输入的数据不合法</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">%</span> <span class="n">align_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">align_num</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">align_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="n">alignment</span><span class="p">(</span><span class="mh">0x1222</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">));</span> <span class="c1">//0x2000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="531-编程实现新增一个节并添加代码">5.3.1 编程实现：新增一个节，并添加代码</h4>
<p>下面是最简单的新增节并添加代码，满足新增节的条件；注意问题：如果我们增加节或者扩大节，在ImageBuffer中操作更方便，而且<strong>一定要新申请一块内存NewImageBuffer来存储新增或扩大后的PE文件的数据</strong>，不能直接在原有的ImageBuffer的内存中操作，因为这块内存是动态分配的，大小是指定过的malloc(size)，不能修改或者新增。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MessageBox_Address 0x754034B0 </span><span class="c1">//宏定义的MessageBox内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;fg.exe&#34;</span><span class="p">;</span>  <span class="c1">//你要打开的PE文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;fg_new.exe&#34;</span><span class="p">;</span> <span class="c1">//保存路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//shellcode：定义要添加的硬编码全局变量，确定的写好，不确定的先用0x00填充，后面计算完再改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BYTE</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE9</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//_IMAGE_DATA_DIRECTORY DataDirectory[16];  //这个先不管
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*FileBuffer到ImageBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;动态申请ImageBuffer内存失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 复制所有头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件中的节表复制到内存上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*ImageBuffer到NewBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//重新计算newBuffer需要大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/*方法一:SizeOfHEADER + 所有节的SizeOfRawData之和
</span></span></span><span class="line"><span class="cl"><span class="cm">	int sizeofSections = 0;
</span></span></span><span class="line"><span class="cl"><span class="cm">	_IMAGE_SECTION_HEADER* _image_section_header_temp = _image_section_header;
</span></span></span><span class="line"><span class="cl"><span class="cm">	for(DWORD int i = 0;i &lt; _image_file_header-&gt;NumberOfSections;i++){
</span></span></span><span class="line"><span class="cl"><span class="cm">		sizeofSections += _image_section_header_temp-&gt;SizeOfRawData;
</span></span></span><span class="line"><span class="cl"><span class="cm">		_image_section_header_temp++;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}
</span></span></span><span class="line"><span class="cl"><span class="cm">	char* newBufferp = (char*)malloc(_image_optional_header-&gt;SizeOfHeaders + sizeofSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//方法二:使用最后一个节的文件偏移地址 + 最后一个节对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NewBuffer内存分配失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向新增节中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0为注入失败、1为注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode_to_new_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定位到新节表起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">target_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断新节是否存的下shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;新节大小不够，添加失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到新节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcodep</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcodep</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcodep</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算最小公倍数函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：传入要计算的两个数
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：两数的最小公倍数
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">least_common_multiple</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">%</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">%</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">max</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewImageBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 定义原来的ImageBuffer几个指针(因为要用到几个值用于创建新的NewImageBuffer内存)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 先计算添加新节后的NewImageBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span> <span class="c1">// 这里为了方便直接把新节大小设为文件对齐粒度和内存对齐粒度的最小公倍数即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newImageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x60000020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="n">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="n">add_one_section</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_shellcode_to_new_section</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;在新节中注入shellcode失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="n">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="532-编程实现扩大最后一个节并添加代码">5.3.2 编程实现：扩大最后一个节，并添加代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MessageBox_Address 0x754034B0 </span><span class="c1">//宏定义的MessageBox内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;fg.exe&#34;</span><span class="p">;</span>  <span class="c1">//你要打开的PE文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;fg_new.exe&#34;</span><span class="p">;</span> <span class="c1">//保存路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//shellcode：定义要添加的硬编码全局变量，确定的写好，不确定的先用0x00填充，后面计算完再改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BYTE</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE9</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//_IMAGE_DATA_DIRECTORY DataDirectory[16];  //这个先不管
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*FileBuffer到ImageBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;动态申请ImageBuffer内存失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 复制所有头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件中的节表复制到内存上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*ImageBuffer到NewBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//重新计算newBuffer需要大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/*方法一:SizeOfHEADER + 所有节的SizeOfRawData之和
</span></span></span><span class="line"><span class="cl"><span class="cm">	int sizeofSections = 0;
</span></span></span><span class="line"><span class="cl"><span class="cm">	_IMAGE_SECTION_HEADER* _image_section_header_temp = _image_section_header;
</span></span></span><span class="line"><span class="cl"><span class="cm">	for(DWORD int i = 0;i &lt; _image_file_header-&gt;NumberOfSections;i++){
</span></span></span><span class="line"><span class="cl"><span class="cm">		sizeofSections += _image_section_header_temp-&gt;SizeOfRawData;
</span></span></span><span class="line"><span class="cl"><span class="cm">		_image_section_header_temp++;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}
</span></span></span><span class="line"><span class="cl"><span class="cm">	char* newBufferp = (char*)malloc(_image_optional_header-&gt;SizeOfHeaders + sizeofSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//方法二:使用最后一个节的文件偏移地址 + 最后一个节对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NewBuffer内存分配失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向新增节中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0为注入失败、1为注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode_to_new_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定位到新节表起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">target_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断新节是否存的下shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;新节大小不够，添加失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到新节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcodep</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcodep</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcodep</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算最小公倍数函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：传入要计算的两个数
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：两数的最小公倍数
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">least_common_multiple</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">%</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">%</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">max</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewImageBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 定义原来的ImageBuffer几个指针(因为要用到几个值用于创建新的NewImageBuffer内存)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 先计算添加新节后的NewImageBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span> <span class="c1">// 这里为了方便直接把新节大小设为文件对齐粒度和内存对齐粒度的最小公倍数即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newImageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x60000020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*扩大最后一个节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要扩大节的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：扩大节后的NewImageBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">expand_last_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//计算扩大多少，并初始化NewImageBuffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span><span class="c1">//这里为了方便直接把需要扩大的大小设为文件对齐粒度和内存对齐粒度的最小公倍数即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span><span class="c1">//不改变指针哦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newImageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改SizeofImage：原来的SizeOfImage + Ex(因为原来的SizeOfImage是内存对齐的整数倍，Ex也是通过内存对齐和文件对齐的最小公倍数算出来的，所以相加一定还是内存对齐的整数倍)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改节表信息，使得节区的内存大小和文件大小一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_last</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span> <span class="o">-</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改节属性，保证可执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="mh">0x60000020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向扩大的节中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0表示注入失败，1表示注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode_to_expanded_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断是否存的下shellcode，这里直接在Ex区域内注入，不考虑原来的空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;新节大小不够，添加失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到Ex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcodep</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">-</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcodep</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcodep</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="n">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="n">expand_last_section</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_shellcode_to_expanded_section</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;在新节中注入shellcode失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="n">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-扩大节合并节">6. 扩大节、合并节</h2>
<h3 id="61-添加代码的方式">6.1 添加代码的方式</h3>
<ol>
<li>直接在任意节的空白区添加代码；</li>
<li>新增节添加代码；</li>
<li>扩大最后一个节添加代码</li>
<li>合并节并添加代码</li>
</ol>
<p>这节学习合并节并添加代码</p>
<h3 id="62-合并节思路">6.2 合并节思路</h3>
<p>使用拉伸后的合并更方便计算节合并后的大小，而且可以保证计算的正确性。如果用FileBuffer算，算地址或者大小时还要担心节中未初始化数据在拉伸后导致节变大等等情况。</p>
<p>合并节就是：把第一个节开始一直到最后一个节的结尾都当成第一个节。</p>
<p>但是可能会造成合并后文件变大，因为文件对齐粒度一般都要小于内存对齐粒度，所以虚拟内存中每个节的空白区一般比文件空白区要大一些，现在合并节是把虚拟内存中从第一个节开始到文件结束都当成一个节，最后再变成FileBuffer就会变大。</p>
<p>步骤：</p>
<ol>
<li>NumberOfSections改成1</li>
<li>修改第一个节表的字段
<ul>
<li>VirtualSize：
<ul>
<li>方法一：SizeOfImage - 第一个节VirtualAddress</li>
<li>方法二：还可以通过最后一个节的VirtualAddress + 最后一个节的VirtualSize内存对齐后的大小 - SizeOfHeader内存对齐后的大小</li>
</ul>
</li>
<li>SizeOfRawData：等于VirtualSize即可</li>
</ul>
</li>
<li>将第一个节的属性改为包含所有节的属性，即用第一个节的属性与其他的节的属性做或运算</li>
</ol>
<h3 id="64-编码实现合并节">6.4 编码实现合并节</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MessageBox_Address 0x754034B0 </span><span class="c1">//宏定义的MessageBox内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;fg.exe&#34;</span><span class="p">;</span>  <span class="c1">//你要打开的PE文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;fg_new.exe&#34;</span><span class="p">;</span> <span class="c1">//保存路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//shellcode：定义要添加的硬编码全局变量，确定的写好，不确定的先用0x00填充，后面计算完再改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BYTE</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="mh">0xE9</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//_IMAGE_DATA_DIRECTORY DataDirectory[16];  //这个先不管
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*FileBuffer到ImageBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;动态申请ImageBuffer内存失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeofImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 复制所有头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 将文件中的节表复制到内存上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*ImageBuffer到NewBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//重新计算newBuffer需要大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/*方法一:SizeOfHEADER + 所有节的SizeOfRawData之和
</span></span></span><span class="line"><span class="cl"><span class="cm">	int sizeofSections = 0;
</span></span></span><span class="line"><span class="cl"><span class="cm">	_IMAGE_SECTION_HEADER* _image_section_header_temp = _image_section_header;
</span></span></span><span class="line"><span class="cl"><span class="cm">	for(DWORD int i = 0;i &lt; _image_file_header-&gt;NumberOfSections;i++){
</span></span></span><span class="line"><span class="cl"><span class="cm">		sizeofSections += _image_section_header_temp-&gt;SizeOfRawData;
</span></span></span><span class="line"><span class="cl"><span class="cm">		_image_section_header_temp++;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}
</span></span></span><span class="line"><span class="cl"><span class="cm">	char* newBufferp = (char*)malloc(_image_optional_header-&gt;SizeOfHeaders + sizeofSections);
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//方法二:使用最后一个节的文件偏移地址 + 最后一个节对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NewBuffer内存分配失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PointerToRawData</span><span class="p">,</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向新增节中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0为注入失败、1为注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode_to_new_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定位到新节表起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">target_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断新节是否存的下shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;新节大小不够，添加失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到新节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcodep</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">target_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcodep</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcodep</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算最小公倍数函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：传入要计算的两个数
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：两数的最小公倍数
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">least_common_multiple</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">%</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">%</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">max</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewImageBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 定义原来的ImageBuffer几个指针(因为要用到几个值用于创建新的NewImageBuffer内存)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 先计算添加新节后的NewImageBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span> <span class="c1">// 这里为了方便直接把新节大小设为文件对齐粒度和内存对齐粒度的最小公倍数即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newImageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header_new</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x60000020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*扩大最后一个节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要扩大节的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：扩大节后的NewImageBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">expand_last_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//计算扩大多少，并初始化NewImageBuffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span><span class="c1">//这里为了方便直接把需要扩大的大小设为文件对齐粒度和内存对齐粒度的最小公倍数即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newImageBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newImageBufferp</span><span class="p">,</span> <span class="n">imageBufferp</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">);</span><span class="c1">//不改变指针哦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newImageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改SizeofImage：原来的SizeOfImage + Ex(因为原来的SizeOfImage是内存对齐的整数倍，Ex也是通过内存对齐和文件对齐的最小公倍数算出来的，所以相加一定还是内存对齐的整数倍)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改节表信息，使得节区的内存大小和文件大小一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_last</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span> <span class="o">-</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改节属性，保证可执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header_last</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="mh">0x60000020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newImageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*向扩大的节中注入shellcode函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要注入的可执行文件的ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：0表示注入失败，1表示注入成功
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add_shellcode_to_expanded_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断是否存的下shellcode，这里直接在Ex区域内注入，不考虑原来的空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;新节大小不够，添加失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将shellcode注入到Ex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">shellcodep</span> <span class="o">=</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">-</span> <span class="n">least_common_multiple</span><span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">FileAlignment</span><span class="p">,</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SectionAlignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newOEP</span> <span class="o">=</span> <span class="n">shellcodep</span><span class="p">;</span>  <span class="c1">//此shellcode注入起始地址即为新的OEP地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">shellcodep</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改call MessageBox的硬编码E8后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E8_fill_value</span> <span class="o">=</span> <span class="n">MessageBox_Address</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">E8_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改jmp 原OEP的硬编码E9后面的4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">E9_fill_value</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="p">((</span><span class="n">shellcodep</span> <span class="o">-</span> <span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">shellcodep</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">E9_fill_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改OEP指向shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">AddressOfEntryPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newOEP</span> <span class="o">-</span> <span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*合并节函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要合并节的可执行文件ImageBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：合并后的ImageBuffer起始地址(因为合并节后并不改变ImageBuffer内存大小，所以返回void也行)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">merge_section</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">imageBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改合并节的节表字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置节表末尾应该跟40个0x00
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memset</span><span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改NumberOfSections字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">imageBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">imageBufferp</span> <span class="o">=</span> <span class="n">fileBuffer_to_ImageBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">imageBufferp</span> <span class="o">=</span> <span class="n">merge_section</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span> <span class="o">=</span> <span class="n">imageBuffer_to_NewBuffer</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">imageBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7-数据目录">7. 数据目录</h2>
<h3 id="71-数据目录概述">7.1 数据目录概述</h3>
<h4 id="711-数据目录的引入">7.1.1 数据目录的引入</h4>
<p>我们当时解析可选PE头时，有一个字段为<code>DWORD NumberOfRvaAndSizes</code>，<code>NumberOfRvaAndSizes</code>的值为多少，说明<code>_IMAGE_DATA_DIRECTORY DataDirectory[16]</code>这种类型的结构体就有多少个。</p>
<p>Win32下，可执行文件的PE结构分节：有代码节，数据节等等节，但是不能理解成这些节中只有程序本身的数据等，编译器也会替我们往每一个节中加很多重要的内容：</p>
<ul>
<li>比如一个程序还会使用一些系统提供的函数，那么编译器就需要添加这些函数的相关信息，告诉程序需要去哪里找到这个函数并进行系统调用。</li>
<li>一个程序不仅可以使用别的函数，也可以提供函数给别的程序使用，所以此时编译器会添加此程序中供别人使用的函数相关信息。</li>
</ul>
<p>编译器添加的内容为什么重要？因为这些信息包含了诸如：PE程序的图标在哪里，用到了哪些系统提供的函数，为其他的程序提供哪些函数等，编译器不添加，程序就找不到这些东西的地址。</p>
<h4 id="712-数据目录的作用">7.1.2 数据目录的作用</h4>
<p>综上所述：<strong>一个PE文件中，除了有程序员自己添加的内容(程序自身的数据)，编译器也会向当中添加很多内容</strong>，编译器添加的内容有很多种类，各有各的目的和使用途径，那么这么多数据和内容肯定需要一个表格记录-–<strong>数据目录</strong>，而且要编译器在添加时要遵循某些规则，<strong>以至于程序在运行时，会很方便的找到需要的信息和数据在哪里</strong>。</p>
<p>所以可以这么理解：<strong>这16个数据目录分别记录了编译器往PE文件中写的16种不同的信息存在哪里</strong></p>
<h4 id="713-数据目录有哪些">7.1.3 数据目录有哪些</h4>
<p>可选PE头最后一个成员，就是数据目录，一共有16个。</p>
<p>分别是：导出表的数据目录、导入表的数据目录、资源表的数据目录、异常信息表的数据目录、安全证书表的数据目录、重定位表的数据目录、调试信息表的数据目录、版权所有表的数据目录、全局指针表的数据目录、TLS表的数据目录、加载配置表的数据目录、绑定导入表的数据目录、IAT表的数据目录、延迟导入表的数据目录、COM信息表的数据目录、最后一个保留未使用。</p>
<p>其中比较重要的就是<strong>导出表、导入表、重定位表、IAT表</strong>这四张表的数据目录，这四张表和程序的运行有直接关系，不管是加壳、脱壳、破解、病毒或反病毒，这些都是基础中的基础。</p>
<h4 id="714-数据目录结构">7.1.4 数据目录结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//内存偏移，必须有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>  <span class="c1">// 大小，破坏了也不会影响程序运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>16个数据目录的大小一样，都是8字节，一行16字节，所以一共占8行：</p>
<ol>
<li>可以从节表开始往上倒着推8行，就是数据目录开始</li>
<li>也可以从可选PE头开始，往后数第24个DWORD就是<code>NumberOfRvaAndSize</code>，第25个DWORD就是数据目录开始</li>
</ol>
<p><img loading="lazy" src="../../imgs/pe/DataDirectory.png" srcset="../../imgs/pe/DataDirectory.png, ../../imgs/pe/DataDirectory.png 1.5x, ../../imgs/pe/DataDirectory.png 2x" sizes="auto" data-title="&amp;ldquo;数据目录&amp;rdquo;" data-alt="&amp;ldquo;数据目录&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>上图中前8字节是导出表的数据目录：前4个字节为导出表的VirtualAddress为0x0，后4字节为导出表的Size为0x0，说明此可执行文件没有导出表。</li>
<li>再接着8字节为导入表的数据目录：前4字节导入表的VirtualAddres为0x6D20，后4字节导入表的Size为0xC8，此可执行文件的导入表在ImageBase + 0x6D20处开始，大小为0xC8。</li>
<li>后面的数据目录以此类推。</li>
</ul>
<h4 id="715-数据目录和16种表的关系">7.1.5 数据目录和16种表的关系</h4>
<p>数据目录只是记录了对应的表的内存偏移地址和大小。我们通过找到表的数据目录，得到表的内存偏移地址，接着找到这个内存偏移地址处才是表本身真正的所在位置！</p>
<p>比如我们找到了&quot;导出表的数据目录&quot;，就可以通过数据目录中的VirtualAddress + ImageBase得到&quot;导出表&quot;所在的地址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IMAGE_DIRECTORY_ENTRY_EXPORT</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../../imgs/pe/ExportTable.png" srcset="../../imgs/pe/ExportTable.png, ../../imgs/pe/ExportTable.png 1.5x, ../../imgs/pe/ExportTable.png 2x" sizes="auto" data-title="&amp;ldquo;数据目录与导出表的关系&amp;rdquo;" data-alt="&amp;ldquo;数据目录与导出表的关系&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="72-编程输出全部目录项">7.2 编程输出全部目录项</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;fg.exe&#34;</span><span class="p">;</span>  <span class="c1">//你要打开的PE文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*输出指定文件的数据目录函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：指定可执行文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">data_directory_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">tableNameArr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_EXPORT(导出表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_IMPORT(导入表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_RESOURCE(资源表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_EXCEPTION(异常信息表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_SECURITY(安全证书表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_BASERELOC(重定位表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_DEBUG(调试信息表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_COPYRIGHT(版权所有表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_GLOBALPTR(全局指针表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_TLS(TLS表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG(加载配置表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT(绑定导入表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_IAT(IAT表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT(延迟导入表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR(COM信息表)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;保留&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定位到数据目录结构起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">NumberOfRvaAndSizes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">VirtualSize:%08X  Size:%08X</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">tableNameArr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_data_directory</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">data_directory_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="8-导出表">8. 导出表</h2>
<h3 id="81-导出表概述">8.1 导出表概述</h3>
<h4 id="811-引入导出表">8.1.1 引入导出表</h4>
<p>一个Win32下的.exe文件，是由多个PE文件组成。比如通过OD打开一个Ipmsg.exe，查看模块<code>M</code>，会发现一个ipmsg.exe由多个.dll(即模块)构成。</p>
<p>这种以动态链接库.dll的方式导出函数时，如果此.exe需要用到某个.dll中的函数，那么.exe怎么知道：</p>
<ul>
<li>引入的.dll中有哪些函数可以供.exe使用？</li>
<li>.dll中的各种函数都存在哪里？</li>
</ul>
<p>所以.dll中应当有一个目录或者结构提供给.exe文件，来记录.dll中的函数有哪些，函数的起始地址等信息。所以如果.dll或者.exe文件想要给别的程序提供函数，就必须同时给别的程序一个“清单”，这个“清单”就是导出表。</p>
<h4 id="812-常见误区">8.1.2 常见误区</h4>
<ul>
<li>不是只有.dll才提供函数给别的程序使用，有些.exe也可以提供函数。</li>
<li>有些.exe的导出表数据目录不是全0，表示有此.exe程序有导出表，即可对外提供函数；有些没有导出表，就不对外提供函数。所以一个PE文件(如.dll/.exe/.sys)。如果对外提供函数，那么就需要有导出表，且需要遵守一定的格式。</li>
<li>一个安全的PE文件，是不会显示导出表的，但可以对外提供函数：正常情况下如果一个PE文件不提供导出表，别人是无法使用其函数的；但是逆向一个游戏时，如果知道了别人的导出表，就不用找call了(不现实)。所以游戏会做安全加固，我们不知道哪些函数是导出的，就算给我函数地址，我也没办法拿这个地址去调用，只能分析反汇编代码，分析程序入口是什么，分析函数的参数是什么。</li>
</ul>
<h3 id="82-导出表位置">8.2 导出表位置</h3>
<p>先定位到可选PE头，再找到可选PE头的最后一个成员：即一个<code>IMAGE_DATA_DIRECTORY</code>结构体数组，第一个结构体就是导出表数据目录，结构体的第一个成员是导出表的内存偏移地址RVA，第二个成员是导出表的大小。</p>
<p><img loading="lazy" src="../../imgs/pe/IMAGE_DIRECTORY_ENTRY_EXPORT.png" srcset="../../imgs/pe/IMAGE_DIRECTORY_ENTRY_EXPORT.png, ../../imgs/pe/IMAGE_DIRECTORY_ENTRY_EXPORT.png 1.5x, ../../imgs/pe/IMAGE_DIRECTORY_ENTRY_EXPORT.png 2x" sizes="auto" data-title="&amp;ldquo;导出表&amp;rdquo;" data-alt="&amp;ldquo;导出表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>通过导出表数据目录的RVA(内存位置)转FOA(文件位置)就可以找到导出表。</p>
<p>导出表其实就在这个PE文件的某个节中(后面要学的各种表也是在某个节中)。</p>
<blockquote>
<p>注意事项：在解析PE结构时就不用拉伸，用FileBuffer分析即可。因为拉伸只是有助于理解，如果直接在FileBuffer中做，只是需要多使用一个<strong>RVA–&gt;FOA</strong>的地址转换函数，每次遇到RVA地址时转换一下即可，就省去了将文件整个拉伸的过程，会减少很多代码量和多余操作，而且市面上关于PE的书籍几乎都是直接用FileBuffer讲解操作的，所以现在开始，我们就要学会不拉伸的情况下去分析。</p>
</blockquote>
<h3 id="83-导出表的结构">8.3 导出表的结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span><span class="p">{</span>   <span class="c1">//40字节		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>Name：指向该导出表文件名字符串的RVA，比如一个DBGHELP.dll的PE文件提供函数，那么这个PE文件的Name指向的字符串为为dbghelp.dll</p>
</li>
<li>
<p>Base：导出函数起始序号(最小的序号)</p>
<blockquote>
<p>比如有序号为14、6、10、8的导出函数，那么Base的值为6</p>
</blockquote>
</li>
<li>
<p>NumberOfFunctions：所有导出函数的个数</p>
<blockquote>
<p>注意：这个值是通过导出函数的最大序号 - 最小序号 + 1算出来的；正常来说这个值是多少，那么此PE文件中导出函数的个数就是多少。但是如果使用自定义序号，序号定义时不是连续的，而是中间有空缺的序号，那么此时NumberOfFunctions的值会比实际的定义的导出函数个数多</p>
</blockquote>
<blockquote>
<p>比如在.def中定义为Plus @12 、Sub @15 NONAME、 Mul @13 、Div @16
那么NumberOfFunctions值 = 16 - 12 + 1 = 5；而不是4！</p>
</blockquote>
</li>
<li>
<p>NumberOfNames</p>
<ul>
<li>以函数名字导出的函数个数：比如以动态链接库的方式导出(注意和只以序号导出函数区分)</li>
<li>如果导出时加了<code>NONAME</code>关键字，那么就不计数</li>
</ul>
</li>
<li>
<p>AddressOfFunctions</p>
<ul>
<li>导出函数地址表RVA，即这个地址指向一个表！这个表中记录了此PE文件的所有导出函数的地址</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/AddressOfFunctions.png" srcset="../../imgs/pe/AddressOfFunctions.png, ../../imgs/pe/AddressOfFunctions.png 1.5x, ../../imgs/pe/AddressOfFunctions.png 2x" sizes="auto" data-title="&amp;ldquo;导出函数地址表RVA&amp;rdquo;" data-alt="&amp;ldquo;导出函数地址表RVA&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>该表中元素宽度：4个字节</li>
<li>元素个数：由NumberOfFunctions决定</li>
</ul>
<blockquote>
<p>导出函数是有序号的，上图中的<strong>下标等于导出函数的相对序号</strong></p>
</blockquote>
<blockquote>
<p>(参考上图)比如使用自定义序号导出函数，即.def的方式导出，定义了序号13、14、16、17、19的导出函数，那么Base的值应为13，那么序号为13的函数相对相对下标就是0，序号14的导出函数相对下标就是1，序号为15的导出函数虽然没有，但是会把位置空出来，只是地址值为NULL，即0x00000000，序号16的导出函数相对下标就是3…以此类推</p>
</blockquote>
<p><img loading="lazy" src="../../imgs/pe/NumberOfFunctions.png" srcset="../../imgs/pe/NumberOfFunctions.png, ../../imgs/pe/NumberOfFunctions.png 1.5x, ../../imgs/pe/NumberOfFunctions.png 2x" sizes="auto" data-title="&amp;ldquo;导出函数地址表RVA&amp;rdquo;" data-alt="&amp;ldquo;导出函数地址表RVA&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
</li>
<li>
<p>AddressOfNames</p>
<ul>
<li>
<p><strong>导出函数名称表RVA</strong>(拉伸后的内存地址偏移，所以要先转成FOA)，即这个地址指向一个表，这个表中记录的是<strong>导出函数的名称字符串地址</strong>！！不是直接存储名称(且此字符串地址也是RVA)。</p>
<blockquote>
<p>就像C语言中的字符串char* name = &ldquo;abc&rdquo;;，name变量值为abc这个字符串的首地址。所以导出函数名称表中存储的是name值(即名称的地址)，而不是直接存储的abc这个名称</p>
</blockquote>
</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/AddressOfNames.png" srcset="../../imgs/pe/AddressOfNames.png, ../../imgs/pe/AddressOfNames.png 1.5x, ../../imgs/pe/AddressOfNames.png 2x" sizes="auto" data-title="&amp;ldquo;导出函数名称表RVA&amp;rdquo;" data-alt="&amp;ldquo;导出函数名称表RVA&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>该表中元素宽度：4个字节</li>
<li>表中元素的数量：由NumberOfNames决定</li>
<li>注意：如果函数导出时添加了<code>NONAME</code>，即函数没有名称，那么这个表中就不会出现这个函数名地址
<ul>
<li>所以AddressOfNames表中元素个数可能比AddressOfFunctions表中元素个数少！(AddressOfFunctions表中不管导出函数有没有名字，都会有地址)</li>
<li>也有可能AddressOfNames表中元素个数比AddressOfFunctions表中元素个数多！因为导出函数时可以让多个不同名字的函数指向同一个函数地址</li>
</ul>
</li>
<li>函数名称表中是按名字排序的(根据ASCII码排序)</li>
</ul>
</li>
<li>
<p>AddressOfNameOrdinals</p>
<ul>
<li>
<p>导出函数序号表RVA，即这个地址指向一个表，表中存的是导出函数的相对序号</p>
<p><img loading="lazy" src="../../imgs/pe/AddressOfNameOrdinals.png" srcset="../../imgs/pe/AddressOfNameOrdinals.png, ../../imgs/pe/AddressOfNameOrdinals.png 1.5x, ../../imgs/pe/AddressOfNameOrdinals.png 2x" sizes="auto" data-title="&amp;ldquo;出函数序号表RVA&amp;rdquo;" data-alt="&amp;ldquo;出函数序号表RVA&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
</li>
<li>
<p>即<strong>该表中存储的内容 + Base = 函数的导出序号</strong></p>
</li>
<li>
<p>表中元素个数：由NumberOfNames决定，且和AddressOfName表一一对应的</p>
</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/NumberOfNames.png" srcset="../../imgs/pe/NumberOfNames.png, ../../imgs/pe/NumberOfNames.png 1.5x, ../../imgs/pe/NumberOfNames.png 2x" sizes="auto" data-title="&amp;ldquo;表中元素个数&amp;rdquo;" data-alt="&amp;ldquo;表中元素个数&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<blockquote>
<p>比如：现在要找名字叫Sub的导出函数，经查找在AddressOfNames表的下标为1的位置，那么这个函数所对应的相对序号则在AddressOfNameOrdinals表中下标为1的位置，即由上图可知Sub函数对应的序号为0x0001 + Base</p>
</blockquote>
<ul>
<li>该表中元素宽度：2个字节</li>
</ul>
</li>
</ol>
<p><strong>NONAME导出函数注意事项：</strong></p>
<ul>
<li>如果导出时，定义的无名字函数，即<code>Div @13 NONAME</code>，那么函数名称表中就不会有指向Div函数名的元素，同样函数序号表中也不会有Div的相对序号，但是在函数地址表中会留出来一个元素位置存储Div函数地址。</li>
</ul>
<h3 id="84-由导出表获取函数地址">8.4 由导出表获取函数地址</h3>
<h4 id="841-按名字找函数地址">8.4.1 按名字找函数地址</h4>
<ul>
<li>
<p>找到导出表后，先根据AddressOfNames，将<code>RVA转成FOA</code>，即可定位到函数名称表，遍历<code>函数名称表</code>，用名字依次与函数名称表每个元素指向的字符串做比较，直到名字匹配，记录下此时元素在函数名称表的下标<code>i</code>。</p>
</li>
<li>
<p>再根据AddressOfNameOrdinals，将RVA转成FOA，即可定位到<code>函数序号表</code>，得到此表下标为<code>i</code>的元素值<code>n</code>。</p>
</li>
<li>
<p>最后根据AddressOfFunctions，将RVA转成FOA，即可定位到<code>函数地址表</code>，则此表下标为<code>n</code>的元素值就是该名字对应函数的RVA地址，将RVA转成FOA就得到了该导出函数在FileBuffer中的地址。</p>
<p><img loading="lazy" src="../../imgs/pe/RVA_to_FOA.png" srcset="../../imgs/pe/RVA_to_FOA.png, ../../imgs/pe/RVA_to_FOA.png 1.5x, ../../imgs/pe/RVA_to_FOA.png 2x" sizes="auto" data-title="&amp;ldquo;表中元素个数&amp;rdquo;" data-alt="&amp;ldquo;表中元素个数&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<blockquote>
<p>比如要根据名字查找导出函数mul()，假设在函数名称表中下标为2指向的位置找了&quot;mul&quot;字符串与函数名称匹配，所以再去查找函数序号表下标为2的元素为0x0004，最后再函数地址表中找下标为4的元素值，即为mul函数的RVA，转成FOA即可。</p>
</blockquote>
</li>
</ul>
<h4 id="842-按序号找函数地址">8.4.2 按序号找函数地址</h4>
<ul>
<li>
<p>找到导出表后，根据AddressOfFunctions，将<code>RVA转成FOA</code>，定位到函数地址表。</p>
</li>
<li>
<p>再用给定的序号 - Base = 相对序号<code>i</code>，得到相对序号<code>i</code>。</p>
</li>
<li>
<p>最后找函数地址表中下标为<code>i</code>的元素值即为该序号对应函数RVA地址，将RVA转成FOA就得到了该函数在FileBuffer中的地址。</p>
<p><img loading="lazy" src="../../imgs/pe/RVA_to_FOA_2.png" srcset="../../imgs/pe/RVA_to_FOA_2.png, ../../imgs/pe/RVA_to_FOA_2.png 1.5x, ../../imgs/pe/RVA_to_FOA_2.png 2x" sizes="auto" data-title="&amp;ldquo;表中元素个数&amp;rdquo;" data-alt="&amp;ldquo;表中元素个数&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>比如要根据序号找导出函数<code>mul()</code>，因为mul的序号为17，Base值为13，那么17 - 13 = 4，所以直接再函数地址表中找到下标为4的元素值，即为mul函数的RVA，最后转成FOA即可。</li>
<li>所以根据导出序号找，跟函数序号表没有关系！函数序号表的存在就是为了用于按名字查找。</li>
<li>上图可以发现，t_method函数用NONAME导出，所以函数名称表和函数序号表都没有t_method的信息，但是由于此函数序号为19，相对序号为19 - 13 = 6，所以会在函数地址表中下标为6的位置存储t_method函数的RVA。</li>
</ul>
</li>
</ul>
<h3 id="85-编写程序打印导出表的信息">8.5 编写程序打印导出表的信息</h3>
<h4 id="方式1">方式1</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;InjectDll.dll&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// RVA就在节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">RVA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*打印导出表函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：指定可执行文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">exportTable_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">_image_export_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有导出表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_export_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************ExportTable****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Name:%08X --&gt; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Base:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfFunctions:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfNames:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfFunctions:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfNames:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfNameOrdinals:%08X</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印函数地址表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionAddressTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************FunctionAddressTable****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionAddressTable</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印函数序号表(别忘了加Base)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span><span class="o">*</span> <span class="n">functionOrdinalsTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">***************FunctionOrdinalsTable****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%04X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionOrdinalsTable</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印函数名称表(别忘了转FOA)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionNameTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">***************FunctionNameTable****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08X --&gt; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionNameTable</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionNameTable</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">exportTable_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="方式2推荐">方式2(推荐)</h4>
<p>通过函数地址表确定序列表，再通过函数序号表找函数名。</p>
<blockquote>
<p>如果在序列表中找不到对于的序号，说明这个函数不是以名字导出的。</p>
</blockquote>
<p><img loading="lazy" src="../../imgs/pe/EXPORT_DIRECTORY_print.png" srcset="../../imgs/pe/EXPORT_DIRECTORY_print.png, ../../imgs/pe/EXPORT_DIRECTORY_print.png 1.5x, ../../imgs/pe/EXPORT_DIRECTORY_print.png 2x" sizes="auto" data-title="&amp;ldquo;导出表打印&amp;rdquo;" data-alt="&amp;ldquo;导出表打印&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;InjectDll.dll&#34;;  //选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;libpython2.7.dll&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*打印导出表函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：指定可执行文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">exportTable_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">_image_export_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有导出表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_export_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************ExportTable****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Name:%08X --&gt; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Base:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfFunctions:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfNames:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfFunctions:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfNames:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;AddressOfNameOrdinals:%08X</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 函数地址表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionAddressTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 函数序号表(别忘了加Base)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span><span class="o">*</span> <span class="n">functionOrdinalsTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//函数名称表(别忘了转FOA)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionNameTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************&amp;&amp;&amp;&amp;&amp;****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;函数地址(RVA)：%08X	&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionAddressTable</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 通过函数地址表确定序列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">functionOrdinalsTable</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;序数：%04d	&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionOrdinalsTable</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// 通过函数序号表找函数名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s(%08X(RAV)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">functionNameTable</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">functionNameTable</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 说明这个函数不是以名字导出的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;序数：%04d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">exportTable_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="86-编写按名字序号找导出函数地址信息">8.6 编写按名字、序号找导出函数地址信息</h3>
<p>说明：昨天用到的<code>GetProcAddress()</code>系统函数，也可以按照这两种方式获取DLL中导出函数的地址，今天要编写的两个函数和<code>GetProcAddress()</code>有相同的功能，只是没有系统函数写的那么好那么复杂。区别是<code>GetProcAddress()</code>第一个参数HMODULE是DLL的ImageBase，即PE文件拉伸后的起始地址；自定义函数的第一个参数FileBuffer指针是PE文件未拉伸时的起始地址，即FileBuffer首地址。</p>
<h4 id="861-按名字查找">8.6.1 按名字查找</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;libpython2.7.dll&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;InjectDll.dll&#34;;  //选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*按名字查找导出函数地址
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：PE文件的FileBuffer起始地址，函数名字符串指针
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：该导出函数的RVA（如果想返回FOA也可以，代码都在下面）
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">GetFunctionAddrByName</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">_image_export_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有导出表,没有函数导出&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_export_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//先遍历函数名称表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionNameTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span><span class="o">*</span> <span class="n">nameTemp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="o">*</span><span class="n">functionNameTable</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">nameTemp</span><span class="p">,</span> <span class="n">funcName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">functionNameTable</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;没有此导出函数</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//再找函数序号表对应下标index中的值funcIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span><span class="o">*</span> <span class="n">functionOrdinalsTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">funcIndex</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">functionOrdinalsTable</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//最后找函数地址表下标为funcIndex中的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionAddressTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//返回该导出函数RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">functionAddressTable</span> <span class="o">+</span> <span class="n">funcIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return RVA_to_FOA(fileBufferp,*(functionAddressTable + funcIndex));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcName</span> <span class="o">=</span> <span class="s">&#34;PyArg_ParseTuple&#34;</span><span class="p">;</span> <span class="c1">//使用LordPE看有哪些导出函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08X&#34;</span><span class="p">,</span> <span class="n">GetFunctionAddrByName</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">funcName</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="862-按序号查找函数">8.6.2 按序号查找函数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;libpython2.7.dll&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;InjectDll.dll&#34;;  //选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*按序号查找导出函数地址信息函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：PE文件的FileBuffer起始地址，函数名字符串指针
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：该导出函数的RVA（如果想返回FOA也可以，代码都在下面）
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">GetFunctionAddrByOrdinals</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">ordinal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">_image_export_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有导出表,没有函数导出</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_export_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断导出序号是否在范围内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">ordinal</span> <span class="o">-</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span> <span class="o">&gt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//因为ordinal用的WORD类型，所以&lt;0的情况不用考虑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;导出序号不合法</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定位到函数地址表起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span><span class="o">*</span> <span class="n">functionAddressTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//返回该序号导出函数的RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">functionAddressTable</span> <span class="o">+</span> <span class="p">(</span><span class="n">ordinal</span> <span class="o">-</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return RVA_to_FOA(fileBufferp,*(functionAddressTable + (ordinal - _image_export_directory-&gt;Base)));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%08X&#34;</span><span class="p">,</span> <span class="n">GetFunctionAddrByOrdinals</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span> <span class="c1">//使用LordPE看有哪些导出序号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="9-重定位表">9. 重定位表</h2>
<h3 id="91-引入重定位表">9.1 引入重定位表</h3>
<p>程序加载过程：</p>
<ul>
<li>每一个可执行程序运行都有一个独立的4GB虚拟内存（32位），地址从0x00000000到0xFFFFFFFF，低2G为用户程序空间、高2G为操作系统内核空间；且一个PE文件有很多个PE文件组成。</li>
<li>程序运行 &ndash;&gt; 操作系统会给程序分4GB虚拟内存 &ndash;&gt; 剩下的事情就像“拉伸贴图”一样（装载）：</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/9.1.png" srcset="../../imgs/pe/9.1.png, ../../imgs/pe/9.1.png 1.5x, ../../imgs/pe/9.1.png 2x" sizes="auto" data-title="&amp;ldquo;拉伸贴图&amp;rdquo;" data-alt="&amp;ldquo;拉伸贴图&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>先装载自身的.exe：如先把ipmsg.exe拉伸贴到ImageBase（0x00400000），分配空间大小为SizeOfImage（0x3D000）</li>
</ul>
<blockquote>
<p>但并不是所有文件的ImageBase都是0x400000，这个值是可以修改的：打开VC-&gt;右键你的项目-&gt;setting-&gt;选择Link-&gt;Category设置为Output-&gt;在Base address选项中就可以自定义ImageBase，之后这个程序编译以后，ImageBase就变了</p>
</blockquote>
<ul>
<li>再装载需要用到的.dll：如把<code>ws2help.dll</code>拉伸贴到它的ImageBase（0x71A10000），分配空间大小为SizeofImage（0x8000），其他.dll也是如此。</li>
<li>最后把EIP指向EOP（AddressOfEntryPoint），这个程序就可以执行了。</li>
</ul>
<h3 id="92-引发的问题">9.2 引发的问题</h3>
<h3 id="921-dll装载地址冲突">9.2.1 DLL装载地址冲突</h3>
<p>一般情况下一个PE文件自身的.exe的ImageBase很少会和别的PE文件ImageBase发生冲突</p>
<p>但是.dll就不一定了：默认情况下DLL的ImageBase为0x10000000，所以如果一个程序要用的DLL没有合理的修改分配装载起始地址，就可能出现多个DLL的ImageBase都是同一个地址，造成装载冲突。</p>
<p>解决办法：如果一个DLL在装载时，发现其他DLL已经占用这块空间了，那么这个DLL会依据模块对齐粒度，往后找空余的空间存入，所以此时这个DLL的装载起始地址和它的ImageBase就不一致了（通俗讲叫&quot;换位置&quot;）。</p>
<blockquote>
<p>模块对齐粒度：和结构体的字节对齐一样：为了提高搜索的速度（时间换空间），模块间地址也是要对齐的。模块对齐粒度为0x10000，也就是64K.</p>
</blockquote>
<h4 id="922-编译后的绝对地址">9.2.2 编译后的绝对地址</h4>
<p>一个.dll或.exePE文件中的全局变量，可能在编译完成后，全局变量的地址就写死了，即它生成硬编码时地址值为：ImageBase + RVA；相当于编译完成后，这个全局变量的绝对内存地址就写入PE文件了。如：这个文件中a（人为的全局变量）和%d（系统的全局变量），编译完后地址值都是写死的。</p>
<p><img loading="lazy" src="../../imgs/pe/9.2.2.jpg" srcset="../../imgs/pe/9.2.2.jpg, ../../imgs/pe/9.2.2.jpg 1.5x, ../../imgs/pe/9.2.2.jpg 2x" sizes="auto" data-title="&amp;ldquo;绝对地址&amp;rdquo;" data-alt="&amp;ldquo;绝对地址&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>那假设如果这个PE文件在装载，没有按照预定的ImageBase装入，而是出现了问题一的情况–“换位置”，但由于这个地址值写死了，程序执行时任然会按这个绝对地址去寻找使用，就会出现找不到这个全局变量！</p>
<p>不光是全局变量，DLL中有对外提供的函数，函数的地址在编译完后函数地址也是写死的，而如果此时DLL装载时ImageBase变了，这些写死的函数地址也就用不了。</p>
<h3 id="93-引入">9.3 引入</h3>
<p>所以如果一个PE文件可能会出现“换位置”的情况，那么就需要重定位表，来记录下来，有哪些地方的数据需要做修改、重新定位，保证“换位置”后，操作系统能正确找到这些数据。</p>
<p>比如<em>编译后的绝对地址</em>中：这个PE文件也没有按照ImageBase去装载，那么全局变量a的存储地址就会发生变化，但是由于硬编码已经生成：A1 30 4A 42 00，那么重定位表就会把30 4A 42 00这个数据的地址记下来，等到运行时操作系统会根据重定位表找到这个数据，做一个重定位修改，即把0x00424a30这个绝对地址做修改，进行重定位，保证全局变量a可以被准确找到（修改的操作全程有操作系统负责）。</p>
<p>为什么很多.exe不提供重定位表，.dll会提供？因为一个PE文件的.exe一般只有一个，且是最先装载，所以装载位置和ImageBase是一致的，也没人跟它抢；但是.dll有很多，就需要考虑装载的位置不是预期的位置，那么这个.dll就需要提供重定位表。</p>
<h3 id="94-重定位表">9.4 重定位表</h3>
<h4 id="941-重定位表位置">9.4.1 重定位表位置</h4>
<p>找到可选PE头中的数据目录项（结构体数组，有16个元素）：找到第6个结构体，就是重定位表的数据目录。</p>
<p><img loading="lazy" src="../../imgs/pe/_IMAGE_BASE_RELOCATION.jpg" srcset="../../imgs/pe/_IMAGE_BASE_RELOCATION.jpg, ../../imgs/pe/_IMAGE_BASE_RELOCATION.jpg 1.5x, ../../imgs/pe/_IMAGE_BASE_RELOCATION.jpg 2x" sizes="auto" data-title="&amp;ldquo;重定位表&amp;rdquo;" data-alt="&amp;ldquo;重定位表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>根据重定位表数据目录的<strong>VirtualAddress</strong>，将RVA转成FOA，得到重定位表在ImageBuffer中的起始地址。</p>
<h4 id="942-重定位表结构">9.4.2 重定位表结构</h4>
<p>重定位表的结构比较特殊：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_BASE_RELOCATION</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//一堆数据...（如果是最后一个这种结构，就只有RVA和SizeOfBlock，且都为0）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../../imgs/pe/_IMAGE_BASE_RELOCATION.png" srcset="../../imgs/pe/_IMAGE_BASE_RELOCATION.png, ../../imgs/pe/_IMAGE_BASE_RELOCATION.png 1.5x, ../../imgs/pe/_IMAGE_BASE_RELOCATION.png 2x" sizes="auto" data-title="&amp;ldquo;重定位表&amp;rdquo;" data-alt="&amp;ldquo;重定位表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>可以这么理解：一个重定位表中可能会有多个“块”，每个块的结构都是：4字节VirtualAddress，接着4字节SizeOfBlock，最后是一堆数据。</p>
<p>每个块的大小为SizeOfBlock（字节），最后一个块的RVA和SizeOfBlock都是0x00000000，表示重定位表结束。</p>
<ol>
<li>SizeOfBlock：表示每个块的大小，单位为字节。</li>
<li>具体项：
<ul>
<li>一堆数据中，每两个字节叫一个具体项。</li>
<li>一块中有多少个高4位为<code>0011</code>的具体项，就表示这个页当中有多少个地方需要做重定位修改。</li>
<li>具体项占2字节，高4位表示类型：值为3，代表 低12位 + 该块的VirtualAddress == 地址处的数据需要修改做重定位；值为0，代表这一2字节数据用来做数据对齐（填充用的），可以不用修改。</li>
<li>故我们只用关注高4位值为3的具体项就可以了。具体项的低12位表示要修改的地方相对于所在页的偏移地址（RVA）。</li>
<li>一块中一共有多少个具体项：用（此块的SizeofBlock - 4 - 4 ）/ 2</li>
</ul>
</li>
<li>VirtualAddress：
<ul>
<li>宽度为4字节</li>
<li>为什么需要这个值：假如现在有10000个地方需要重定位，又因为4GB虚拟内存地址需要32位二进制数才能表示的下，即4字节，所以10000个地方要修改，就需要记录下这10000个地方的地址，一个地址4字节，共需大小10000 * 4 = 40000字节空间，按照这种方法记录，重定位表就需要40000 + 8字节，太大了！！</li>
<li>现在如果把一个PE文件分页（操作系统确实会这么干），内存中一个页的大小为0x1000字节，相当于把文件分成了一小页一小页的。</li>
<li>那么一页中如果有要重定位的地方，重定位表就会给这个页安排一块，这个块的VirtualAddress存储此页的偏移起始地址（RVA），由于一页的大小只有0x1000字节（4096），每个字节内存用一个地址表示，即用12位二进制数就可以表示的下4096个地址（比上面的32位二进制数要少的多！），前面学过内存对齐的概念，所以把这个值用16位存放，故具体项占16位，多出来的高4位可以用来表示其他的含义，低12位表示需要修改的地方相对于所在页的偏移地址！</li>
<li>综上所述：一页中如果有要重定位的地方，重定位表给此页安排一块（<em>一块对应一页</em>）；<strong>此块的VirtualAddress存储此页的起始地址；具体项占16位，高4位表示类型，低12位表示要修改的地方相对于所在页的偏移地址</strong>。</li>
<li>每一个数据项低12位的值 + VirtualAddress才是真正需要修复重定位的数据的RVA</li>
</ul>
</li>
</ol>
<h3 id="95-页块节的关系">9.5 页、块、节的关系</h3>
<ul>
<li>一个PE文件（可执行程序）运行时，装入虚拟内存中会对程序进行分页。</li>
<li>重定位表会分块。</li>
<li>一个程序有不同的节，跟分页和分块没有任何关系。</li>
</ul>
<p>打开一个有重定位表的PE文件，查看重定位表，会发现这个重定位表分了很多块，第175块中记录的是偏移地址为0xAF000的页中要修改重定位的地方，这些要修改的地方在.text节中；第176块中记录的是偏移地址为0xB000的页中要修改重定位的地方，这些要修改的地方在.data节中。</p>
<p><img loading="lazy" src="../../imgs/pe/9.5.jpg" srcset="../../imgs/pe/9.5.jpg, ../../imgs/pe/9.5.jpg 1.5x, ../../imgs/pe/9.5.jpg 2x" sizes="auto" data-title="&amp;ldquo;重定位表的PE文件&amp;rdquo;" data-alt="&amp;ldquo;重定位表的PE文件&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="96-为什么学重定位表">9.6 为什么学重定位表</h3>
<ol>
<li>破解方面
<ul>
<li>加密壳：如果想对一个程序加加密壳之前，需要先将程序的各种表—导出表，导入表，重定位表等移动到新增的节当中，移走后对剩下的数据加密（所有的头和节表不能加密！DOS头，NT头，节表）。为什么呢？因为我们知道这些表其实分散在程序的某个节当中，如果直接对整个程序的数据加密，那么最后操作系统也找不到各种表了，无法加载用到的各种DLL了（比如找不到导入表，那么操作系统进行装载时，无法知道有哪些DLL要装到虚拟内存中），程序就无法执行；所以就需要对各种表非常熟悉，才知道从哪里移。</li>
</ul>
</li>
<li>反反调试
<ul>
<li>反调试：有些游戏公司为了避免别人调试，会在驱动层（0环）把很多函数加上钩子（hook），比如说有一个函数叫<code>openprocess()</code>，用来打开进程。而如果想调试任何进程，都需要先打开进程，像使用OD–&gt;点击附加，本质上就是使用了0环的<code>openprocess()</code>这个函数，那么由于游戏公司给这个函数加上了钩子，在调用这个函数时，游戏就会判断这个函数的参数是否是游戏进程本身，是的话就返回一个0（NULL），不让别人看到它。所以使用OD点击附加–&gt;找进程打开时，会发现游戏的进程根本不在这里面。</li>
<li>反反调试：即过游戏驱动，一个比较常用的方式叫&mdash;-内核重载，即把内核程序（0环）kernel.exe拉伸，把拉伸后的数据往内存中复制一份，只不过这个程序是0环的程序，用的是0环的语法，不能像我们平时在3环写程序用的语法。但是现在不允许把拉伸后的数据往内存复制，因为此时原来的kernel.exe已经把位置占着了，所以只能在它的后面一个模块中复制，这种情况不就和上文中的问题一一样，“换位置”了。那么这个程序中的所有绝对地址都不能用了，都必须要自己根据重定位表把要修正的数据修正重定位。那么我们再想用程序就不用它提供的加过钩子的内核，而使用我们自己复制的这一份。</li>
</ul>
</li>
</ol>
<h3 id="97-打印重定位表信息">9.7 打印重定位表信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;libpython2.7.dll&#34;;  //选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;Dll_project.dll&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BASE_RELOCATION</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//具体项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*打印重定位表函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：指定可执行文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">relocationTable_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span> <span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//指向数据目录结构体数组的第6个结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断是否有重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有重定位表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//找到重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//打印重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************重定位表****************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;*********第%d块*********</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;VirtualAddress:%08X   SizeOfBlock:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">,</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;类型</span><span class="se">\t</span><span class="s">RVA</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//这里使用右移12位的方式打印2字节宽度的高4位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//if ((*((WORD*)((char*)_image_base_relocation + 8 + j * 2)) &gt;&gt; 12) == 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//	printf(&#34;%d\n&#34;, *((WORD*)((char*)_image_base_relocation + 8 + j * 2)) &gt;&gt; 12);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//	//continue;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			
</span></span><span class="line"><span class="cl">			<span class="c1">//这里用与运算把高4位变成0后输出2字节宽度的值，即为低12位的值（别忘了还要加VirtualAddress）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">WORD</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">WORD</span><span class="o">*</span><span class="p">)((</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 选一个有重定位表的PE文件（控制台没法打印太多的数据，所以选一个重定位表小一点的PE文件）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">relocationTable_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-移动导出表和重定位表">10. 移动导出表和重定位表</h2>
<p>为什么要移动各种表：</p>
<ul>
<li>一个PE文件中有很多节，有的用来存储代码、有的存储数据，而PE文件的各种表也都分散存储在这些节当中，所以各种表的信息与程序的代码和数据都混在一起了，如果直接对整个程序进行加密，那系统在初始化程序时就会出问题！（比如：在程序启动的时候，这些表的数据被加密了，系统就无法根据这些表将用到的DLL中的函数地址存储到IAT表中），所以对程序加密或破解之前，会先移动各种表到程序新增的节当中，再对剩下的数据（DOS头、NT头等所有头和节表都不能加密，不然操作系统根本就不认这是一个Windows可执行程序了，程序就启动不起来了）进行加密。学会移动各种表，是对程序加密/破解的基础。</li>
</ul>
<h3 id="101-移动导出表">10.1 移动导出表</h3>
<p><img loading="lazy" src="../../imgs/pe/10.1.png" srcset="../../imgs/pe/10.1.png, ../../imgs/pe/10.1.png 1.5x, ../../imgs/pe/10.1.png 2x" sizes="auto" data-title="&amp;ldquo;移动导出表&amp;rdquo;" data-alt="&amp;ldquo;移动导出表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol>
<li>在PE文件中新增一个节，大小可以按照下面的长度求和对齐计算出来，但其实可以估算0x1000字节足够了。
<blockquote>
<p>新增节别忘了修改PE头当中的一些字段：NumberOfSections、SizeOfImage、重新开辟一个FileBuffer、新增节表、修改节表中的字段（Name、Misc.VirtualSize、VirtualAddress、SizeOfRawData、PointerToRawData、Characteristics）。</p>
</blockquote>
</li>
<li>复制AddressOfFunctions指向的函数地址表到新节中（步骤2、3、4别忘了RVA转FOA），长度为4 * NumberOfFunctions字节。</li>
<li>接着复制AddressOfNameOrdinals指向的函数序号表到新节中，长度为2 * NumberOfNames字节。</li>
<li>复制AddressOfNames指向的函数名称表到新节中，长度为4 * NumberOfNames字节。</li>
<li>还要复制函数名称表中元素所指向的函数名称字符串到新节中，长度可以遍历函数名称表，用strlen()函数依次求出每个字符串长度，再求和；每复制一个字符串到新节中，就修改对应的函数名称表中的地址值（而且要注意：函数名称表中存的是RVA，所以把字符串复制到新节后还需要把FOA转成RVA，再存入）。
<blockquote>
<p>为什么需要移动字符串？因为如果光移动函数名称表，对剩下的数据加密（字符串也包含其中），那么当需要根据函数名去调用导出函数时，只能根据函数名称表查到名称字符串所在地址，但是字符串被加密，就无法匹配了</p>
</blockquote>
</li>
<li>复制导出表IMAGE_EXPORT_DIRECTORY到新节中，大小固定40字节。</li>
<li>修改导出表中的成员值，指向三个子表在新节中的位置（下面三个值都是RVA，所以要根据此时三张子表在新节中的FOA转成RVA）。
<ul>
<li>AddressOfFunctions</li>
<li>AddressOfNameOrdinals</li>
<li>AddressOfNames</li>
</ul>
</li>
<li>最后修复导出表数据目录中的VirtualAddress，指向导出表IMAGE_EXPORT_DIRECTORY在新节中的位置（也要FOA转RVA）。</li>
</ol>
<p>代码编写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;libpython2.7.dll&#34;;  //选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;OllyDBG.EXE&#34;</span><span class="p">;</span>  <span class="c1">//选一个有导出表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;OllyDBG_new.EXE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BASE_RELOCATION</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//具体项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*文件偏移地址函数-&gt;虚拟内存偏移地址
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,FOA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FOA对应的RVA，返回0则表示非法FOA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">FOA_to_RVA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">FOA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//用来判断最终FOA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FOA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">tempSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">?</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="nl">VirtualSize</span> <span class="p">:</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">&amp;&amp;</span> <span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">tempSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">file_offset_from_section</span> <span class="o">=</span> <span class="n">FOA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">file_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数（直接在FileBuffer中操作）
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewFileBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section_inFileBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定义原来的FileBuffer几个指针（因为要用到几个值用于创建新的NewFileBuffer内存）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//先计算添加新节后的NewFileBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//DWORD expand_value = 0x3000; //这里0x3000字节足够了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="mh">0xF000</span><span class="p">;</span> <span class="c1">//如果对于重定位表很大的PE文件，要视情况而定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">fileBufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">fileBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newFileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">_image_section_header_new</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="n">fileBufferSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将PE文件导出表移到新增节中函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：PE文件的FileBuffer首地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节并且移动导出表后的NewFileBuffer首地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">move_ExportTable</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="n">add_one_section_inFileBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">_image_export_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newFileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有导出表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_export_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制函数地址表到新节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">functionAddressTablep</span> <span class="o">=</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newSectionp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">;</span>  <span class="c1">//newSectionp指向：向新节中复制的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">funcAddressTable_in_newSectionp</span> <span class="o">=</span> <span class="n">newSectionp</span><span class="p">;</span><span class="c1">//把函数地址表在新节中的首地址记下来，后面要用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="n">functionAddressTablep</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制函数序号表到新节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">functionOrdinalTablep</span> <span class="o">=</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">newSectionp</span> <span class="o">+=</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfFunctions</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">funcOrdinalTable_in_newSectionp</span> <span class="o">=</span> <span class="n">newSectionp</span><span class="p">;</span><span class="c1">//把函数序号表在新节中的首地址记下来，后面要用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="n">functionOrdinalTablep</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制函数名称表到新节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">functionNameTablep</span> <span class="o">=</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">newSectionp</span> <span class="o">+=</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">funcNameTable_in_newSectionp</span> <span class="o">=</span> <span class="n">newSectionp</span><span class="p">;</span><span class="c1">//把函数名称表在新节中的首地址记下来，后面要用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="n">functionNameTablep</span><span class="p">,</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制函数名称字符串到新节中，每复制一个就修改函数名称表中的对应地址值RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">newSectionp</span> <span class="o">+=</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span><span class="o">*</span> <span class="n">funcNameTable_in_newSectionp_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">funcNameTable_in_newSectionp</span><span class="p">;</span><span class="c1">//用于修改新节中的函数名称表中地址值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_export_directory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span><span class="o">*</span> <span class="n">nameStr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">functionNameTablep</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="n">nameStr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">nameStr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span><span class="c1">//字符串结尾的\0别忘了复制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">*</span><span class="n">funcNameTable_in_newSectionp_temp</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">));</span><span class="c1">//修改对应的函数名称表中的地址值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">newSectionp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">nameStr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">functionNameTablep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)((</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">functionNameTablep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">funcNameTable_in_newSectionp_temp</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制导出表到新节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_export_directory</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修正新节中导出表的成员值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">((</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">newSectionp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">funcAddressTable_in_newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">((</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">newSectionp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">funcOrdinalTable_in_newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">((</span><span class="n">_IMAGE_EXPORT_DIRECTORY</span><span class="o">*</span><span class="p">)</span><span class="n">newSectionp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">funcNameTable_in_newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修正导出表数据目录中的成员
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="n">move_ExportTable</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将移动导出表后的PE文件存盘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="102-移动重定位表">10.2 移动重定位表</h3>
<p><img loading="lazy" src="../../imgs/pe/10.2.png" srcset="../../imgs/pe/10.2.png, ../../imgs/pe/10.2.png 1.5x, ../../imgs/pe/10.2.png 2x" sizes="auto" data-title="&amp;ldquo;移动重定位表&amp;rdquo;" data-alt="&amp;ldquo;移动重定位表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol>
<li>新增节，大小可以循环遍历重定位表的每个块，把所有块的SizeOfBlock求和 + 结束标记8字节最后再对齐；也可以估算0x1000就满足大部分情况了。</li>
<li>复制重定位表到新节中，大小为所有块的SizeOfBlock求和 + 结束标记8字节。</li>
<li>修改重定位表数据目录中的VirtualAddress，指向重定位表在新节中的位置即可（FOA转RVA）。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;OllyDBG.EXE&#34;</span><span class="p">;</span>  <span class="c1">//选一个有重定位表的PE文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;OllyDBG_new.EXE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BASE_RELOCATION</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//具体项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">RVA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*文件偏移地址函数-&gt;虚拟内存偏移地址
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,FOA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FOA对应的RVA，返回0则表示非法FOA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">FOA_to_RVA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">FOA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//用来判断最终FOA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FOA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">tempSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">?</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="nl">VirtualSize</span> <span class="p">:</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">&amp;&amp;</span> <span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">tempSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">file_offset_from_section</span> <span class="o">=</span> <span class="n">FOA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">file_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数（直接在FileBuffer中操作）
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewFileBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section_inFileBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定义原来的FileBuffer几个指针（因为要用到几个值用于创建新的NewFileBuffer内存）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//先计算添加新节后的NewFileBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//DWORD expand_value = 0x3000; //这里0x3000字节足够了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="mh">0xF000</span><span class="p">;</span> <span class="c1">//如果对于重定位表很大的PE文件，要视情况而定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">fileBufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">fileBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newFileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">_image_section_header_new</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="n">fileBufferSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将PE文件重定位表移到新增节中函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：PE文件的FileBuffer首地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节并且移动重定位表后的NewFileBuffer首地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">move_RelocationTable</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="n">add_one_section_inFileBuffer</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span> <span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newFileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有重定位表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//复制重定位表到新节中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span> <span class="n">_image_base_relocation_temp</span> <span class="o">=</span> <span class="n">_image_base_relocation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newSectionp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">newFileBufferp</span><span class="p">;</span>  <span class="c1">//newSectionp指向：向新节中复制的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//计算重定位表的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">_image_base_relocation_temp</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">+=</span> <span class="n">_image_base_relocation_temp</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_base_relocation_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation_temp</span> <span class="o">+</span> <span class="n">_image_base_relocation_temp</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">size</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">//还要加上重定位表结束标记的8字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">newSectionp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修正重定位表数据目录的成员
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">FOA_to_RVA</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">newSectionp</span> <span class="o">-</span> <span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="n">move_RelocationTable</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将移动重定位表后的PE文件存盘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="103-修复重定位表">10.3 修复重定位表</h3>
<blockquote>
<p>注意：修复重定位表不是真的修复重定位表中的数据，而是根据重定位表的各个具体项，去修改具体项指向的地方的值（这个值可能是DLL中全局变量的绝对地址；或者是DLL中函数的绝对地址等）！！！</p>
</blockquote>
<p>应用场景：</p>
<ul>
<li>一般情况下一个PE文件自身的.exe的ImageBase很少会和别的PE文件ImageBase发生冲突；但是.dll就不一定了：day35写过自己发布的DLL，默认情况下DLL的ImageBase为0x10000000，所以如果一个程序要用的DLL没有合理的修改分配装载起始地址，就可能出现多个DLL的ImageBase都是同一个地址，造成装载冲突。所以如果一个DLL在装载时，发现其他DLL已经占用这块空间了，那么这个DLL会依据模块对齐粒度，往后找空余的空间存入，则此时这个DLL的装载起始地址和它的ImageBase就不一致了！这个时候操作系统如果访问DLL当中写死的绝对地址，就会访问出错。所以操作系统就会根据重定位表去修正这些写死的地址。</li>
</ul>
<p>要求：现在我们自己故意修改一个DLL文件的ImageBase，再根据其重定位表去修正，最后存盘，看此DLL文件是否可以正常使用（即手动模拟操作系统修复重定位表的过程）。</p>
<p>修正过程：比如DLL的ImageBase原来为0x400000，现在修改为0x500000；接着找到重定位表，遍历每个块中的具体项，根据具体项去找哪里的地址值需要修改重定位；找到后，将原来的地址值 + （0x500000 - 0x400000）即可。</p>
<p>注入：平时我们说的注入的本质就是将自己写的DLL复制“贴”到一个程序运行时的虚拟内存中，所以我可以找一个空闲位置，把DLL“贴”进去，接着手动修复重定位表，就实现了注入。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;PROCS.DLL&#34;</span><span class="p">;</span>  <span class="c1">// 选一个有重定位表的PE文件，选LordPE文件下的PROCS.DLL是因为这个DLL的重定位表的块比较少，方便我们验证是否可以正常解析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span> <span class="o">=</span> <span class="s">&#34;PROCS_new.DLL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导出表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>  <span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>	<span class="c1">//未使用		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//指向该导出表文件名字符串  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>  <span class="c1">//导出函数起始序号  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>  <span class="c1">//所有导出函数的个数  *		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>  <span class="c1">//以函数名字导出的函数个数  *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>  <span class="c1">//导出函数地址表RVA  *					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>  <span class="c1">//导出函数名称表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">//导出函数序号表RVA  *						
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BASE_RELOCATION</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//具体项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*NewBuffer存盘函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要写出数据的内存首地址，保存绝对路径，写出的数据大小(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：成功返回1，失败返回0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">save_to_disk</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">storagePath</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">newBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算NewBuffer大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：NewBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：unsigned int类型(单位：字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">compute_NewBuffer_size</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">newBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">last_image_section_header</span> <span class="o">=</span> <span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">sizeofNewBuffer</span> <span class="o">=</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">last_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sizeofNewBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">RVA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*文件偏移地址函数-&gt;虚拟内存偏移地址
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,FOA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FOA对应的RVA，返回0则表示非法FOA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">FOA_to_RVA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">FOA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//用来判断最终FOA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FOA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">tempSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">?</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="nl">VirtualSize</span> <span class="p">:</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FOA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">&amp;&amp;</span> <span class="n">FOA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">tempSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">file_offset_from_section</span> <span class="o">=</span> <span class="n">FOA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">file_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*在文件最后新增节函数（直接在FileBuffer中操作）
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要新增节的可执行文件的FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：新增节后的NewFileBuffer内存的起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">add_one_section_inFileBuffer</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//定义原来的FileBuffer几个指针（因为要用到几个值用于创建新的NewFileBuffer内存）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//先计算添加新节后的NewFileBuffer的大小，并初始化内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//DWORD expand_value = 0x3000; //这里0x3000字节足够了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">expand_value</span> <span class="o">=</span> <span class="mh">0xF000</span><span class="p">;</span> <span class="c1">//如果对于重定位表很大的PE文件，要视情况而定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">fileBufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">newFileBufferp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">memset</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fileBufferSize</span> <span class="o">+</span> <span class="n">expand_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">newFileBufferp</span><span class="p">,</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">fileBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">newFileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//判断节表末尾是否有空间新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfHeaders</span> <span class="o">-</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;空间不足，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;节表后80字节数据不全为0x00，有文件数据，无法新增节表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_SizeOfImage</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span><span class="p">;</span> <span class="c1">//记录下原来的SizeOfImage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">SizeOfImage</span> <span class="o">+=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//新增节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">_image_section_header_new</span><span class="p">,</span> <span class="n">_image_section_header</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//修改新增节表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#34;.newsec&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">=</span> <span class="n">original_SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">=</span> <span class="n">expand_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">=</span> <span class="n">fileBufferSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">=</span> <span class="n">_image_section_header_new</span><span class="o">-&gt;</span><span class="n">Characteristics</span> <span class="o">|</span> <span class="p">(</span><span class="n">_image_section_header</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">newFileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*修改ImageBase后修复重定位表函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：要修复重定位表的PE文件的FileBuffer
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">repair_RelocationTable</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span> <span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//指向数据目录结构体数组的第6个结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//判断是否有重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此PE文件没有重定位表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//找到重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)(</span><span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span> <span class="o">+</span> <span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//手动修改ImageBase（这里可以先查一下原ImageBase（0x20000000）是多少，方便修改）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">original_ImageBase</span> <span class="o">=</span> <span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">=</span> <span class="mh">0x30000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">ImageBase</span> <span class="o">-</span> <span class="n">original_ImageBase</span><span class="p">);</span><span class="c1">//现ImageBase比原ImageBase可能大也可能小，所以设置为有符号整型类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//根据重定位表中每个块的具体项去修复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//这里使用右移12位的方式2字节宽度的高4位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">((</span><span class="n">WORD</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//这里用与运算把高4位变成0后输出2字节宽度的值，即为低12位的值（别忘了还要加该块VirtualAddress）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">DWORD</span><span class="o">*</span> <span class="n">repairAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">WORD</span><span class="o">*</span><span class="p">)((</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">			<span class="o">*</span><span class="n">repairAddress</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_base_relocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BASE_RELOCATION</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_base_relocation</span> <span class="o">+</span> <span class="n">_image_base_relocation</span><span class="o">-&gt;</span><span class="n">SizeOfBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">repair_RelocationTable</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将修复重定位表后的PE文件存盘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_NewBuffer_size</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">save_to_disk</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">storagePath</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;存盘成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">free</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="11-iat表和导入表">11. IAT表和导入表</h2>
<h3 id="111-iat表">11.1 IAT表</h3>
<h3 id="112-导入表">11.2 导入表</h3>
<h4 id="1121-导入表是什么">11.2.1 导入表是什么</h4>
<p>导入表：即一个PE文件（.dll/.exe等），它如果需要使用使用别的PE文件的函数，就需要一个清单来记录使用的别的PE文件的函数相关信息（使用了哪些DLL、使用了这个DLL里的哪些函数、叫什么名、去哪找等）。</p>
<p>一般而言：<strong>程序通过导入表中的信息来装载DLL到虚拟内存中</strong>（比如通过导入表的所有Name成员，知道要装载哪些DLL；或者如果导入表的某个结构中OriginalFirstThunk和FirstThunk都为0，系统就不会加载这个导入表结构对应的DLL，因为操作系统知道你没有使用这个DLL中的任何函数）</p>
<blockquote>
<p>程序需要导入表中的一些信息来加载DLL，但修复导入表中的某些信息是在DLL装载完成后（比如修复IAT表），所以这些都是有过程的，不要混为一谈。</p>
</blockquote>
<p>.exe一般没有导出表、有导入表；.dll一般既有导出表、又有导入表（因为一个.dll可能也需要使用别的.dll提供的函数，且.dll也会提供函数给别的PE文件用）</p>
<h4 id="1122-定位导入表">11.2.2 定位导入表</h4>
<p>一个PE文件的导入表数据目录在PE文件第二个数据目录结构体，再根据导入表数据目录的VirtualAddress成员找到导出表（RVA转FOA）。</p>
<p><img loading="lazy" src="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR.jpg" srcset="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR.jpg, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR.jpg 1.5x, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR.jpg 2x" sizes="auto" data-title="&amp;ldquo;导入表&amp;rdquo;" data-alt="&amp;ldquo;导入表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="1123-导入表结构">11.2.3 导入表结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_IMPORT_DESCRIPTOR</span><span class="p">{</span>							
</span></span><span class="line"><span class="cl">    <span class="k">union</span><span class="p">{</span>							
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>           							
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">OriginalFirstThunk</span><span class="p">;</span>  <span class="c1">//RVA，指向IMAGE_THUNK_DATA结构数组（INT表）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>							
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳	（用于判断是否有绑定导入表/IAT表中是否已经绑定绝对地址）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">ForwarderChain</span><span class="p">;</span>              							
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//RVA，指向dll名字字符串存储地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">FirstThunk</span><span class="p">;</span>  <span class="c1">//RVA,指向IMAGE_THUNK_DATA结构数组（IAT表）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//导入表有很多个这种结构（成员全为0，表示结束）
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注意：导入表不可能就一个这种结构，因为一个PE文件可能会使用多个DLL中的多个函数，一个这样的结构只表示一个DLL中的函数；所以PE文件使用了多少个DLL中的函数，就有多少个这种结构。</p>
<p>当遇到有<code>sizeof(_IMAGE_IMPORT_DESCRIPTOR)</code>个0x00时，表示导出表结束（相当于一个导入表结构中的成员全为0x00000000，就表示导入表结束）</p>
<p>由于IAT表在程序运行前后是不一样的，所以导入表和IAT表的具体关系结构图示如下：</p>
<ol>
<li><strong>PE文件运行前</strong>：</li>
</ol>
<p><img loading="lazy" src="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_before.png" srcset="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_before.png, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_before.png 1.5x, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_before.png 2x" sizes="auto" data-title="&amp;ldquo;PE文件运行前：导入表&amp;rdquo;" data-alt="&amp;ldquo;PE文件运行前：导入表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="2">
<li><strong>PE文件运行后</strong>：</li>
</ol>
<p><img loading="lazy" src="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_after.png" srcset="../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_after.png, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_after.png 1.5x, ../../imgs/pe/_IMAGE_IMPORT_DESCRIPTOR_after.png 2x" sizes="auto" data-title="&amp;ldquo;PE文件运行后：导入表&amp;rdquo;" data-alt="&amp;ldquo;PE文件运行后：导入表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ul>
<li>OriginalFirstThunk：RVA，指向INT表（导入名称表），如果想得到内存地址，即用ImageBase + RVA即可；如果想得到文件地址，即把RVA转FOA即可。</li>
<li>Name：RVA，指向DLL名字字符串所在地址；比如Name指向的DLL名称为“user32.dll\0”，那么这个结构中记录的就是user32.dll中函数的相关信息；所以一个PE文件的导入表有多少中这种结构，就使用了多少个其他DLL中的函数。</li>
<li>FirstThunk：RVA，指向IAT表（导入地址表）。</li>
<li>TimeDataStamp：时间戳字段
<ul>
<li><strong>为0（即0x00000000）</strong>：表示这个导入表结构对应的DLL中的函数绝对地址没有绑定到IAT表中。</li>
<li><strong>为-1(即0xFFFFFFFF）</strong>：表示这个导入表结构对应的DLL中函数绝对地址已经绑定到IAT表中。</li>
</ul>
</li>
</ul>
<h4 id="1124-iat表和int表">11.2.4 IAT表和INT表</h4>
<p>定位IAT表和INT表：</p>
<ol>
<li>第一种方法：通过导入表中的FirstThunk（RVA）成员，找到IAT表；通过OriginalFirstThunk找到INT表。</li>
<li>第二种方法：直接通过PE文件的第13个数据目录结构体中的VirtualAddress（RVA）成员，找到IAT表。</li>
</ol>
<p>INT表（导入名称表）：</p>
<p><img loading="lazy" src="../../imgs/pe/INT.png" srcset="../../imgs/pe/INT.png, ../../imgs/pe/INT.png 1.5x, ../../imgs/pe/INT.png 2x" sizes="auto" data-title="&amp;ldquo;INT表（导入名称表）&amp;rdquo;" data-alt="&amp;ldquo;INT表（导入名称表）&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>由于有的DLL中的函数可以以函数名称导出，也可以只以序号（<code>NONAME</code>）导出，所以当一个PE文件使用别的DLL中的函数时要考虑函数有名字和函数只有序号两种情况：故INT表中的元素有<strong>IMAGE_THUNK_DATA</strong>和<strong>序号</strong>两种（都是32位，4字节），判断方法如下：</p>
<ul>
<li>如果INT表的元素最高位为1：那么除去最高位剩下31位的值，就是函数的导出序号。</li>
<li>如果INT表的元素最高位为0：那么这整个值是一个RVA，指向IMAGE_IMPORT_BY_NAME表中对应的函数名称结构体。</li>
</ul>
<p><strong>IMAGE_THUNK_DATA32结构体</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_THUNK_DATA32</span><span class="p">{</span>								
</span></span><span class="line"><span class="cl">    <span class="k">union</span><span class="p">{</span>								
</span></span><span class="line"><span class="cl">        <span class="n">BYTE</span> <span class="n">ForwarderString</span><span class="p">;</span>								
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">Function</span><span class="p">;</span>								
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">Ordinal</span><span class="p">;</span>  <span class="c1">//序号		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_IMAGE_IMPORT_BY_NAME</span><span class="o">*</span> <span class="n">AddressOfData</span><span class="p">;</span>  <span class="c1">//RVA，指向IMAGE_IMPORT_BY_NAME		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>								
</span></span><span class="line"><span class="cl"><span class="p">};</span>						
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个结构体中就是一个联合体，占4字节；所以可以直接把INT表中的元素全部当成DWORD宽度即可（当成DWORD宽度的话，遍历INT表或者读取当中元素要方便很多）。</p>
<p><strong>_IMAGE_IMPORT_BY_NAME结构体</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_IMPORT_BY_NAME</span><span class="p">{</span>							
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">Hint</span><span class="p">;</span>  <span class="c1">//可能为空（编译器决定）；如果不为空，表示函数在导出表中的索引	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="c1">//函数名称，以0结尾	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>							
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Hint：这个值不能作为查找函数的手段，很多编译器都会把这个值设置为0x0000，表示为空</li>
<li>Name：因为这里要找一个结构来存储函数名称，一般都会想到字符数组，但是函数名称的字符个数是不确定的，那么到底定义多大的字符数组合适呢？为了解决这个问题，干脆定义一个1字节的字符数组，只存储函数名称的第一个字符！那么通过Name就可以得到该字符串的首地址！再依次往后遍历，直到遇到字符串的结尾字符\0，整个函数名称就取到了。</li>
</ul>
<p>IAT表（导入地址表）：</p>
<ul>
<li>PE文件运行前：IAT表中的内容和INT表的一模一样！</li>
<li>PE文件运行后：IAT表中的内容就变成了对应DLL中的函数在内存中的绝对地址。</li>
<li>IAT表修改过程：当PE文件运行后，先装载.exe，再装载各个使用到的.dll到PE文件的虚拟内存中；等所有DLL装载完成后，再修改IAT表：遍历导出表中每个结构的INT表，无论遍历到的是函数名还是序号，都会作为其中一个参数传给系统函数：<code>GetProcAddress()</code>，此函数根据函数名或序号返回对应函数在内存中的绝对地址，接着把绝对地址存入到IAT表的对应位置。</li>
</ul>
<p><img loading="lazy" src="../../imgs/pe/11.2.4.png" srcset="../../imgs/pe/11.2.4.png, ../../imgs/pe/11.2.4.png 1.5x, ../../imgs/pe/11.2.4.png 2x" sizes="auto" data-title="&amp;ldquo;IAT表修改过程&amp;rdquo;" data-alt="&amp;ldquo;IAT表修改过程&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>当IAT表修改完成后，系统会把程序中调用DLL函数的call语句后面的地址也改了！改成什么？&mdash;&mdash;程序的call后面跟的是间接寻址，即call [0x&hellip;.]，实际上这里的地址改成了IAT表中对应函数绝对地址值的地址！</p>
<blockquote>
<p>即运行前：<code>call [0x....]</code>后面间接寻址的地址0x&hellip;.是INT表中某个元素的地址；而运行后：<code>call [0x....]</code>后面间接寻址的地址0x&hellip;.，改成了IAT表中某个元素的地址；</p>
</blockquote>
<p>为什么有IAT表了，还需要INT表？</p>
<ul>
<li>原因之一是PE文件加载后，INT表作为函数名字的备份。运行前后INT表中的元素永远都指向函数名称或者序号，所以如果需要按照名字来查找该程序使用的别的DLL中的函数地址，就可以先通过遍历该程序导出表的INT表（别忘了导出表是由多个相同的结构构成的，每一个结构都对应一个DLL，每一个结构中都有INT表），最终在某一个导出表结构中的INT表中匹配到函数名称（或序号），那么把函数名称和所属结构的DLL通过<code>LoadLibrary()</code>返回的句柄（即所属DLL的ImageBase）传入<code>GetProcAddress()</code>函数，就可以得到该函数地址。</li>
<li>如果没有INT表，那么当程序运行后，IAT表中的元素变成了函数的绝对地址，就无法通过函数名来查找了。</li>
</ul>
<p><strong>小结</strong>：一个PE文件的导入表有很多个<code>_IMAGE_IMPORT_DESCRIPTOR</code>这种结构构成，每一个这种结构都对应一个DLL以及该DLL中的函数，通过每个结构中的Name可以知道该PE文件使用了哪些DLL中的函数，再通过这个结构中的INT表和IAT表可以知道该PE文件使用了这个DLL中的哪些函数。</p>
<h3 id="113-打印程序运行前的导入表">11.3 打印程序运行前的导入表</h3>
<p>要求：打印ipmsg.exe和notepad.exe运行前的导入表，以及INT表、IAT表和函数名称或序号，最后对比两个PE文件的IAT表在运行前有什么不同。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;fg.exe&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;notepad.exe&#34;;		// 没有导入表？？？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;InjectDll.dll&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//导入表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_IMPORT_DESCRIPTOR</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">OriginalFirstThunk</span><span class="p">;</span>  <span class="c1">//RVA，指向IMAGE_THUNK_DATA结构数组（INT表）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ForwarderChain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>  <span class="c1">//RVA，指向dll名字字符串存储地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FirstThunk</span><span class="p">;</span>  <span class="c1">//RVA,指向IMAGE_THUNK_DATA结构数组（IAT表）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span><span class="c1">//导入表有很多个这种结构（成员全为0，表示结束）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//INT表中元素指向的函数名称表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_IMPORT_BY_NAME</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Hint</span><span class="p">;</span>  <span class="c1">//可能为空（编译器决定）；如果不为空，表示函数在导出表中的索引	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="c1">//函数名称，以0结尾	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//INT表和运行前IAT表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_THUNK_DATA32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BYTE</span> <span class="n">ForwarderString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">Function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">Ordinal</span><span class="p">;</span>  <span class="c1">//序号		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">_IMAGE_IMPORT_BY_NAME</span><span class="o">*</span> <span class="n">AddressOfData</span><span class="p">;</span>  <span class="c1">//RVA，指向IMAGE_IMPORT_BY_NAME		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">RVA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*打印导入表、INT表、运行前IAT表、函数名称或序号
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要打印的PE文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">importTable_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_IMPORT_DESCRIPTOR</span><span class="o">*</span> <span class="n">_image_import_descriptor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_THUNK_DATA32</span><span class="o">*</span> <span class="n">_image_thunk_data32</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//指向INT表或IAT表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_IMPORT_BY_NAME</span><span class="o">*</span> <span class="n">_image_import_by_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//指向函数名称表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此文件没有导入表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">_image_import_descriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_IMPORT_DESCRIPTOR</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***************导入表***************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//根据导入表结构中是否为全0判断导入表是否结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_image_import_descriptor</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_import_descriptor</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_image_import_descriptor</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//打印导入表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">char</span><span class="o">*</span> <span class="n">dllName</span> <span class="o">=</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Name:%08X---&gt;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">dllName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TimeDateStamp:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;OriginalFirstThunk:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;FirstThunk:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//打印INT表和函数名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;-----------------INT表-----------------</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_thunk_data32</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_THUNK_DATA32</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">_image_thunk_data32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//直接把INT表中元素当成DWORD来判断即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="p">((</span><span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(以序号方式导出)序号:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">_image_import_by_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_IMPORT_BY_NAME</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(以函数名方式导出)函数名RVA:%08X---&gt;(hint:%04X)%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">_image_import_by_name</span><span class="o">-&gt;</span><span class="n">Hint</span><span class="p">,</span> <span class="n">_image_import_by_name</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="n">_image_thunk_data32</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;无INT表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//打印运行前的IAT表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;***********运行前IAT表***********</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_thunk_data32</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_THUNK_DATA32</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_import_descriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">_image_thunk_data32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(以序号方式导出)序号:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">_image_import_by_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_IMPORT_BY_NAME</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Ordinal</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;(以函数名方式导出)函数名RVA:%08X---&gt;(hint:%04X)%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_thunk_data32</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">_image_import_by_name</span><span class="o">-&gt;</span><span class="n">Hint</span><span class="p">,</span> <span class="n">_image_import_by_name</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_thunk_data32</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//导出表后移一个结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">_image_import_descriptor</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  <span class="c1">//在这里加断点可以方便导出表一个结构一个结构的打印
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">importTable_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-绑定导入表">12. 绑定导入表</h2>
<h3 id="121-引入绑定导入表">12.1 引入绑定导入表</h3>
<p>notepad.exe在运行前IAT表和INT表中的内容不一样，且通过观察，<strong>运行前notepad.exe的IAT表中存储的数据直接就是函数在虚拟内存中的绝对地址</strong>，而不是像ipmsg.exe程序：在程序运行时&mdash;-程序的.exe和使用到的DLL加载完成后，再把使用到的DLL中函数的绝对地址写到IAT表中。</p>
<p>为什么Windows32位系统自带的一些程序在运行前就把使用到的DLL中的函数的绝对地址绑定到IAT表中呢？</p>
<ul>
<li>优点：程序启动速度变快。
<blockquote>
<p>因为双击程序后，系统会给程序分配一个4GB虚拟内存，接着把程序的.exe和使用的.dll装载到虚拟内存中，装载完成后再遍历INT表，通过系统API得到对应函数的绝对地址，再写到IAT表中；而如果在程序运行前就已经把函数绝对地址绑定到IAT表中，程序启动时就无需上述修改IAT表的步骤，节省时间。</p>
</blockquote>
</li>
<li>缺点：如果程序使用到的DLL装载时没有按照ImageBase位置装载；或者当程序使用到的DLL中的函数被修改了导致函数地址发生变化，那么IAT表中的地址数据就不准确了</li>
</ul>
<p>综上：系统自带程序之所以敢这样做，可能就是因为这些程序使用的DLL都是设计好的，会按照ImageBase装载，不会出现冲突；且这些DLL不经常修改，函数地址不经常发生变化。</p>
<p>程序加载后，系统如何判断一个IAT表中数据是已经绑定好的绝对地址呢？还是指向对应函数名字符串地址的RVA或序号呢？</p>
<p>因为导入表有多个<code>_IMAGE_IMPORT_DESCRIPTOR</code>这种结构，每一个结构对应一个程序使用到的DLL；比如这个导入表结构对应的DLL是user32.dll，那么根据这个导入表结构中的<strong>TimeDataStamp</strong>字段，就可以判断此导入表结构的IAT表中的数据是绝对地址还是RVA。</p>
<p><img loading="lazy" src="../../imgs/pe/12.1.png" srcset="../../imgs/pe/12.1.png, ../../imgs/pe/12.1.png 1.5x, ../../imgs/pe/12.1.png 2x" sizes="auto" data-title="&amp;ldquo;判断此导入表结构的IAT表中的数据是绝对地址还是RVA&amp;rdquo;" data-alt="&amp;ldquo;判断此导入表结构的IAT表中的数据是绝对地址还是RVA&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>可以通过导入表的时间戳(TimeDataStamp)，判断是否有绑定导入表：</p>
<ul>
<li>为0（即0x00000000）：表示这个导入表结构对应的DLL中的函数绝对地址没有绑定到IAT表中。</li>
<li>为-1（即0xFFFFFFFF）：表示这个导入表结构对应的DLL中函数绝对地址已经绑定到IAT表中。</li>
</ul>
<p>如果一个导入表结构的TimeDataStamp为-1，说明绝对地址已经绑定到IAT表中，那如何知道对应DLL中函数的绝对地址什么时间绑定的？就需要另一个表&mdash;-绑定导入表，绑定导入表中的TimeDataStamp时间戳，才表示函数地址真正的绑定时间。</p>
<h3 id="122-绑定导入表">12.2 绑定导入表</h3>
<p>数据目录的第12个结构，就是绑定导入表数据目录项；再通过绑定导入表数据目录中<code>VirtualAddress</code>字段，RVA转成FOA，定位到绑定导入表地址。</p>
<p><img loading="lazy" src="../../imgs/pe/_IMAGE_BOUND_IMPORT_DESCRIPTOR.jpg" srcset="../../imgs/pe/_IMAGE_BOUND_IMPORT_DESCRIPTOR.jpg, ../../imgs/pe/_IMAGE_BOUND_IMPORT_DESCRIPTOR.jpg 1.5x, ../../imgs/pe/_IMAGE_BOUND_IMPORT_DESCRIPTOR.jpg 2x" sizes="auto" data-title="&amp;ldquo;绑定导入表&amp;rdquo;" data-alt="&amp;ldquo;绑定导入表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>绑定导入表结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class="p">{</span>						
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">OffsetModuleName</span><span class="p">;</span>	<span class="c1">//DLL的名字RVA（加第一个结构中RVA才是字符串真正RVA，详见下面）	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">NumberOfModuleForwarderRefs</span><span class="p">;</span>  <span class="c1">//这个绑定导入表结构后面还有几个_IMAGE_BOUND_FORWARDER_REF这种结构					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>  <span class="c1">//绑定导入表有很多这种结构或者_IMAGE_BOUND_FORWARDER_REF这种结构，最后如果有sizeof(_IMAGE_BOUND_IMPORT_DESCRIPTOR)个0，表示绑定导入表结束	
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>TimeDateStamp</code>：绑定导入表的时间戳：表示程序使用到的DLL中的函数绝对地址真正绑定到IAT表中的时间。</p>
<p>作用：系统通过程序使用到的DLL对应的<strong>绑定导入表结构中TimeDateStamp和该DLL的可选PE头中的TimeDateStamp</strong>对比。</p>
<ul>
<li>如果两个时间戳一样：表明DLL的创建时间和把DLL中的函数绝对地址绑定到IAT表的时间是一样，则在绑定以后，DLL没有更新或者修改。</li>
<li>如果两个时间戳不一样：表明在绑定以后，此DLL又被更新或者修改了，那么绑定到IAT表中的地址可能不准确了！（因为DLL中的函数地址可能变了，但绑定到IAT中的数据可能是以前的函数地址）</li>
</ul>
<p><code>OffsetModuleName</code>：对应DLL的名字：因为一个程序的导入表结构对应一个使用到的DLL；一个程序的绑定导入表结构也对应一个程序使用到的DLL，这个绑定导入表结构记录了该DLL中函数绝对地址绑定到IAT表的时间戳、该DLL的名字、还有该DLL使用到别的DLL的个数。</p>
<blockquote>
<p>注意：不管是<code>_IMAGE_BOUND_IMPORT_DESCRIPTOR</code>结构中的<code>OffsetModuleName</code>、还是后面要讲的<code>_IMAGE_BOUND_FORWARDER_REF</code> 结构中的<code>OffsetModuleName</code>，都<strong>必须加上绑定导入表起始RVA值</strong>，才是这个结构对应DLL名字的真正RVA。</p>
</blockquote>
<p>因为通过Winhex打开notepad.exe发现：绑定导入表的起始地址是在节表后面！！而上述DLL名字字符串紧跟在绑定导入表后面！（这就解决了以前学新增节时，为什么说节表后面如果有数据，不要随便动！）</p>
<p><code>NumberOfModuleForwarderRefs</code>：因为一个DLL可能还会使用到别的DLL中的函数，所以<code>NumberOfModuleForwarderRefs</code>字段的值是多少，就表明当前绑定导入表对应的DLL还使用了多少个别的DLL，同样表示这个绑定导入表结构后面跟了多少个<code>_IMAGE_BOUND_FORWARDER_REF</code>这种结构。</p>
<p><code>_IMAGE_BOUND_FORWARDER_REF</code>结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">_IMAGE_BOUND_FORWARDER_REF</span> <span class="p">{</span>			
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">OffsetModuleName</span><span class="p">;</span>  <span class="c1">//对应DLL的名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">Reserved</span><span class="p">;</span>  <span class="c1">//保留（未使用）	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TimeDataStamp：和绑定导入表结构中的时间戳含义和用途是一样的。</li>
<li>OffsetModuleName：加上绑定导入表起始RVA，才是真正对应DLL的名字。</li>
<li>Reserved：保留字段（未使用），没有任何含义。</li>
</ul>
<p>具体结构关系如下：比如一个程序的绑定导入表先是一个<code>_IMAGE_BOUND_IMPORT_DESCRIPTOR</code>结构，该结构中<code>NumberOfModuleForwarderRefs</code>字段值为2（表示该DLL使用了另外两个DLL中的函数），则该结构后面跟了两个<code>_IMAGE_BOUND_FORWARDER_REF</code>结构（每一个REF结构对应一个DLL）；后面以此类推，直到有8字节个0x00表示绑定导入表结束。</p>
<p><img loading="lazy" src="../../imgs/pe/12.2.png" srcset="../../imgs/pe/12.2.png, ../../imgs/pe/12.2.png 1.5x, ../../imgs/pe/12.2.png 2x" sizes="auto" data-title="&amp;ldquo;绑定导入表&amp;rdquo;" data-alt="&amp;ldquo;绑定导入表&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>综上：当<code>IMAGE_BOUND_IMPORT_DESCRIPTOR</code>结构中的<code>TimeDateStamp</code>与DLL文件标准PE头中的<code>TimeDateStamp</code>值不相符时（或者DLL需要重定位的时候），程序在装载完成后才会修改对应DLL的导入表结构中的IAT表中的数据。</p>
<h3 id="123-打印绑定导入表">12.3 打印绑定导入表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma warning(disable : 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MZ 0x5A4D
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PE 0x4550
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//const char* filePath = &#34;notepad.exe&#34;;	// 此文件没有绑定导入表？？？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&#34;CRACKME.EXE&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//DOS头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DOS_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_magic</span><span class="p">;</span>  <span class="c1">//MZ标记
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">e_cblp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_crlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cparhdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_minalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_maxalloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_csum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_lfarlc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_ovno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oemid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_oeminfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">e_lfanew</span><span class="p">;</span>  <span class="c1">//PE文件真正开始的偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//标准PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>  <span class="c1">//文件运行平台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span>  <span class="c1">//节数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//可选PE头大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//特征值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//可选PE头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span>  <span class="c1">//文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>   <span class="c1">//代码节文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>  <span class="c1">//初始化数据文件对齐后的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span>  <span class="c1">//未初始化数据文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>  <span class="c1">//程序入口点(偏移量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>  <span class="c1">//代码基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>  <span class="c1">//数据基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>   <span class="c1">//内存镜像基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span>  <span class="c1">//内存对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>  <span class="c1">//文件对齐粒度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>  <span class="c1">//文件装入虚拟内存后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span>  <span class="c1">//DOS、NT头和节表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>  <span class="c1">//校验和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>  <span class="c1">//预留堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆栈大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>  <span class="c1">//预留堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>  <span class="c1">//实际分配堆大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>  <span class="c1">//目录项数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">//数据目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//NT头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>  <span class="c1">//PE签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">_IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//节表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>  <span class="c1">//节表名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span>  <span class="c1">//内存中未对齐大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span><span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>  <span class="c1">//该节在内存中偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span>  <span class="c1">//该节在硬盘上文件对齐后偏移地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>  <span class="c1">//该节特征属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//绑定导入表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BOUND_IMPORT_DESCRIPTOR</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">OffsetModuleName</span><span class="p">;</span>	<span class="c1">//DLL的名字RVA（加第一个结构中RVA才是字符串真正RVA，详见下面）	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">NumberOfModuleForwarderRefs</span><span class="p">;</span>  <span class="c1">//这个绑定导入表结构后面还有几个_IMAGE_BOUND_FORWARDER_REF这种结构					
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>  <span class="c1">//绑定导入表有很多这种结构或者_IMAGE_BOUND_FORWARDER_REF这种结构，最后如果有sizeof(_IMAGE_BOUND_IMPORT_DESCRIPTOR)个0，表示绑定导入表结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">_IMAGE_BOUND_FORWARDER_REF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">//时间戳		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">OffsetModuleName</span><span class="p">;</span>  <span class="c1">//对应DLL的名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">WORD</span> <span class="n">Reserved</span><span class="p">;</span>  <span class="c1">//保留（未使用）	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*计算文件大小函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：返回文件大小(单位字节)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">compute_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//fseek(fp,0,0); 单纯计算文件大小，就不需要还原指针了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*将文件读入FileBuffer函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：FileBuffer起始地址
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="nf">to_FileBuffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;打开文件失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">compute_file_size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>  <span class="c1">//分配内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;分配空间失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">isSucceed</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSucceed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;读取数据失败&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">free</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*虚拟内存偏移地址-&gt;文件偏移地址函数
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：FileBuffer起始地址,RVA地址值
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：RVA对应的FOA，返回0则表示非法RVA
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">RVA_to_FOA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">RVA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span> <span class="n">_image_section_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_section_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_SECTION_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_optional_header</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">SizeOfOptionalHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">RVA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA 在那个节区中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">RVA</span> <span class="o">&gt;=</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span>
</span></span><span class="line"><span class="cl">			<span class="o">&amp;&amp;</span> <span class="n">RVA</span> <span class="o">&lt;</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_image_section_header</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来判断最终RVA值是否在节中的非空白区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">_image_file_header</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 确定RVA在该节区的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">mem_offset_from_section</span> <span class="o">=</span> <span class="n">RVA</span> <span class="o">-</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">_image_section_header</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">mem_offset_from_section</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*打印绑定导入表
</span></span></span><span class="line"><span class="cl"><span class="cm">参数：需要打印的PE文件绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">返回值：无
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">boundImportTable_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">fileBufferp</span> <span class="o">=</span> <span class="n">to_FileBuffer</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span> <span class="n">_image_dos_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span> <span class="n">_image_file_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span> <span class="n">_image_optional_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span> <span class="n">_image_data_directory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class="o">*</span> <span class="n">_image_bound_import_descriptor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_IMAGE_BOUND_FORWARDER_REF</span><span class="o">*</span> <span class="n">_image_bound_forwarder_ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_dos_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">fileBufferp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_file_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_FILE_HEADER</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">_image_dos_header</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_optional_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_OPTIONAL_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_file_header</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">_image_data_directory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_DATA_DIRECTORY</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_optional_header</span><span class="o">-&gt;</span><span class="n">DataDirectory</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>  <span class="c1">//指向绑定导入表数据目录项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;此文件没有绑定导入表</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_image_bound_import_descriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class="o">*</span><span class="p">)(</span><span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">bound_import_table_RVA</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">_image_data_directory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">;</span> <span class="c1">//记录下绑定导入表起始RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//打印绑定导入表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">***************绑定导入表***************</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//根据绑定导入表结构中是否为全0判断绑定导入表是否结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_image_bound_import_descriptor</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_image_bound_import_descriptor</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_image_bound_import_descriptor</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;OffsetModuleName:%04X---&gt;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">OffsetModuleName</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">OffsetModuleName</span> <span class="o">+</span> <span class="n">bound_import_table_RVA</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TimeDateStamp:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;NumberOfModuleForwarderRefs:%04X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">NumberOfModuleForwarderRefs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//打印_IMAGE_BOUND_FORWARDER_REF结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">NumberOfModuleForwarderRefs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;-----ModuleForwarders-----</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">NumberOfModuleForwarderRefs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">_image_bound_forwarder_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BOUND_FORWARDER_REF</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_bound_import_descriptor</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;OffsetModuleName:%04X---&gt;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_forwarder_ref</span><span class="o">-&gt;</span><span class="n">OffsetModuleName</span><span class="p">,</span> <span class="n">fileBufferp</span> <span class="o">+</span> <span class="n">RVA_to_FOA</span><span class="p">(</span><span class="n">fileBufferp</span><span class="p">,</span> <span class="n">_image_bound_forwarder_ref</span><span class="o">-&gt;</span><span class="n">OffsetModuleName</span> <span class="o">+</span> <span class="n">bound_import_table_RVA</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TimeDateStamp:%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_forwarder_ref</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Reserved(未使用):%04X</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_image_bound_forwarder_ref</span><span class="o">-&gt;</span><span class="n">Reserved</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">_image_bound_import_descriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class="o">*</span><span class="p">)(</span><span class="n">_image_bound_import_descriptor</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">_image_bound_import_descriptor</span><span class="o">-&gt;</span><span class="n">NumberOfModuleForwarderRefs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">boundImportTable_print</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-导入表注入">13. 导入表注入</h2>
<p>一个游戏辅助（.exe）：有自动打怪、加血、自动任务等功能。那么当点击自动打怪按钮时，怎么让游戏（.exe）去执行这个功能呢？游戏的打怪功能就是一个函数，传入相关的参数、调用打怪函数就可以实现打怪，只不过我们用鼠标或者键盘是一种快捷键的方式操作，而不是直接操控代码。</p>
<p>如果我们把①定位游戏打怪函数的call、②传入相关参数、③执行这部分代码等功能封装到一个DLL中，把这个DLL注入到游戏运行时的虚拟空间中，接着去调用执行这个DLL，不就实现了自动打怪的功能。（上述过程就是我们提过的<strong>DLL注入</strong>）</p>
<p>那么如何指挥这个DLL去做事呢？就需要知道进程通信，即游戏辅助（.exe）与游戏（.exe）之间进行通信。（所以需要学习进程通信相关API，即Win32API，以及线程相关概念）</p>
<p><img loading="lazy" src="../../imgs/pe/13.png" srcset="../../imgs/pe/13.png, ../../imgs/pe/13.png 1.5x, ../../imgs/pe/13.png 2x" sizes="auto" data-title="&amp;ldquo;进程通信&amp;rdquo;" data-alt="&amp;ldquo;进程通信&amp;rdquo;" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="131-注入">13.1 注入</h3>
<p>在操作系统3环层面有8种常见注入方式：</p>
<ol>
<li>注册表注入；</li>
<li>导入表注入；</li>
<li>特洛伊注入；</li>
<li>远程线程注入；</li>
<li>无DLL注入；</li>
<li>Apc注入；</li>
<li>Windows挂钩注入DLL；</li>
<li>输入法注入</li>
</ol>
<p>当exe被加载时，系统会根据exe的导入表信息来加载此程序需要用到的DLL。比如通过导入表的所有Name成员，知道要装载哪些DLL，接着操作系统会去程序所在当前文件夹下查找DLL去装载，找不到再去系统盘中找；或者如果导入表的某个结构中OriginalFirstThunk和FirstThunk都为0，系统就不会加载这个导入表结构对应的DLL，因为操作系统知道你没有使用这个DLL中的任何函数，加载没有意义。所以在下面导入表注入实操时，一定要创建一个完整的“链”：<strong>新增一个导入表结构的同时，还需要新增对应的INT表以及IAT表、以及函数名称表，不能只创建一个导入表结构</strong>。</p>
<p>导入表注入的原理就是：修改exe导入表，将自己写的DLL相关信息添加到exe的导入表中，这样exe运行时就可以将自己的DLL加载到exe的进程虚拟内存中。</p>
<h3 id="132-移动导入表">13.2 移动导入表</h3>
<p><strong>为什么要移动导入表？</strong></p>
<p>结合导入表注入的原理思考：由于一个导入表结构对应一个DLL，所以你把DLL添加到.exe进程空间中，就需要在.exe的导入表中新增一个导入表结构（还要新增对应INT表、IAT表和函数名称表），但是原来的导入表结构是一个紧挨着一个存储的，最后有sizeof(导入表结构体)个0结尾，再后面的数据肯定都是有用的。所以我们没办法直接在导入表个结构中插入一个新的导入表结构，也没办法在原有的导入表结尾处新增导入表结构，那就只能把导入表移走！再在它结尾处新增导入表结构和全0结尾即可。</p>
<p>但是注意：<strong>只用把原来的导入表结构移走即可</strong>，不需要移走原来各个导入表结构对应的INT表和IAT表，也就<strong>不需要修改原来导入表结构中的OriginalFirstThunk和FirstThunk等字段</strong>。而且<strong>IAT表是一定不能移动的</strong>！因为当程序运行时，系统会把程序中调用DLL函数的call语句后面的地址也改了！改成什么？&mdash;&mdash;程序的call后面跟的是间接寻址，即<code>call [0x....]</code>，实际上这里的地址改成了IAT表中对应函数绝对地址值的地址！即运行前：<code>call [0x....]</code>后面间接寻址的地址<code>0x....</code>是INT表中某个元素的地址；而运行后：<code>call [0x....]</code>后面间接寻址的地址<code>0x....</code>，改成了IAT表中某个元素的地址；所以，要是移动IAT表，IAT表地址变了，那么你就要把程序中所有调用DLL函数的call语句后面的间接寻址的地址也改掉！但是这个工作量是非常大的！</p>
<p><strong>导入表注入步骤</strong>：</p>
<ol>
<li>设计要注入的DLL</li>
<li>先找到可选PE头中最后一个成员数据目录，第二个结构就是导入表数据目录，<strong>通过VirtualAddress定位到导入表地址</strong></li>
<li>依次<strong>移动原来导入表所有结构</strong>到新增节或者节与节之间的空白区或者扩大节中（哪种方法都行）</li>
<li>在移动后的导入表后面，<strong>新增一个导入表结构</strong>（别忘了还要在结尾留下sizeof(导入表结构体)个0）</li>
<li>再<strong>新增一个至少8字节的INT表和IAT表</strong>，并且<strong>修正新增导入表结构中的<code>OriginalFirstThunk</code>和<code>FirstThunk</code></strong></li>
</ol>
<blockquote>
<p>因为导入表结构中的OriginalFirstThunk和FirstThunk字段不能为0，即必须要使用对应DLL中的至少一个函数才行，不然系统不会加载此DLL到程序虚拟内存中的。所以INT表和IAT表中至少要有一个函数信息还有4字节0表示结束（具体大小为多少，还是要看你的DLL有多少函数给程序使用）</p>
</blockquote>
<ol start="6">
<li>还要<strong>新增至少一个<code>IMAGE_IMPORT_BY_NAME</code>结构</strong>，即函数名称表：前两个字节为0即可，后面是函数名称字符串</li>
<li><strong>修改INT表和IAT表（运行前）中的元素值</strong>，指向<code>IMAGE_IMPORT_BY_NAME</code>结构中元素。</li>
<li>再在后面分配空间<strong>存储此DLL名称字符串</strong>，并将该字符串的起始<code>RVA</code>赋值给导入表结构中的<code>Name</code></li>
<li>最后修正导入表数据目录中的<code>VirtualAddress</code>和<code>Size</code></li>
</ol>
<h3 id="133-设计要注入的dll">13.3 设计要注入的DLL</h3>
<p>我们先自己编写一个DLL，用于后面导入表注入实验，先用vs 2019创建一个DLL：名为InjectDll，接着在InjectDll.h头文件中声明三个函数，前两个DLL内部使用，最后一个为导出函数供别的程序使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// InjectDll.h: interface for the InjectDll class.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if !defined(AFX_INJECTDLL_H__0713C052_B98E_4101_AB64_77B2AE5596C8__INCLUDED_)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define AFX_INJECTDLL_H__0713C052_B98E_4101_AB64_77B2AE5596C8__INCLUDED_
</span></span></span><span class="line"><span class="cl"><span class="cp">#if _MSC_VER &gt; 1000
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// _MSC_VER &gt; 1000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Init</span><span class="p">();</span>  <span class="c1">//这两个函数不用导出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="n">_declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">ExportFunction</span><span class="p">();</span>  <span class="c1">//这个函数要导出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// !defined(AFX_INJECTDLL_H__0713C052_B98E_4101_AB64_77B2AE5596C8__INCLUDED_)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再在InjectDll.cpp中定义三个函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// InjectDll.cpp: implementation of the InjectDll class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&#34;InjectDll.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Init</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#34;Init&#34;</span><span class="p">,</span><span class="s">&#34;Init&#34;</span><span class="p">,</span><span class="n">MB_OK</span><span class="p">);</span> <span class="c1">//简单的一个弹窗功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Destroy</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#34;Destroy&#34;</span><span class="p">,</span><span class="s">&#34;Destroy&#34;</span><span class="p">,</span><span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ExportFunction</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#34;ExportFunction&#34;</span><span class="p">,</span><span class="s">&#34;ExportFunction&#34;</span><span class="p">,</span><span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后定义DLL入口函数：即当程序运行、装载此DLL时以及程序退出、卸载此DLL时会调用<code>DllMain()</code>函数，调用<code>DllMain()</code>方法后，如果传入的<code>ul_reason_for_call</code>参数为<code>DLL_PROCESS_ATTACH</code>（这是一个宏），表示正在装载DLL，则会调用<code>Init()</code>方法；如果传入的<code>ul_reason_for_call</code>参数为<code>DLL_PROCESS_DETACH</code>，表示正在卸载DLL，则会调用<code>Destroy()</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hModule</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span><span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">){</span>  <span class="c1">//定义DllMain方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span><span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">DLL_PROCESS_ATTACH</span><span class="p">:</span>  <span class="c1">//当程序运行，装载DLL时会调用一次DllMain方法，执行Init()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">DLL_PROCESS_DETACH</span><span class="p">:</span>  <span class="c1">//当程序结束，卸载DLL时会调用一次DllMain方法，执行Destroy()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">Destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-04-25 00:00:00">Updated on 2023-04-25&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://cui-jiang-tao.github.io/posts/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F/" data-title="PE" data-hashtags="PE"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://cui-jiang-tao.github.io/posts/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F/" data-hashtag="PE"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://cui-jiang-tao.github.io/posts/%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F/" data-title="PE"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/pe/' class="post-tag">PE</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/bash%E8%84%9A%E6%9C%AC%E5%85%A5%E9%97%A8/" class="post-nav-item" rel="prev" title="Bash脚本入门"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Bash脚本入门</a>
      <a href="/posts/c&#43;&#43;%E5%8F%8D%E6%B1%87%E7%BC%96%E6%8F%AD%E7%A7%98/" class="post-nav-item" rel="next" title="c&#43;&#43;反汇编揭秘">c&#43;&#43;反汇编揭秘<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":-1},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-desktop":"Home","typeit-header-title-mobile":"Home"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},"duration":-1,"loop":false,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
