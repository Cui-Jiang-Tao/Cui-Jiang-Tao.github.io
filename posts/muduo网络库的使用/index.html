<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>muduo网络库的使用 - 学习记录</title><meta name="author" content="cjt">
<meta name="author-link" content="">
<meta name="description" content="1. echo服务的实现 muduo的使用非常简单，不需要从指定的类派生，也不用覆写虚函数，只需要注册几个回调函数去处理&quot;三个半的事件&" /><meta name="keywords" content='muduo' /><meta itemprop="name" content="muduo网络库的使用">
<meta itemprop="description" content="1. echo服务的实现 muduo的使用非常简单，不需要从指定的类派生，也不用覆写虚函数，只需要注册几个回调函数去处理&quot;三个半的事件&"><meta itemprop="datePublished" content="2022-12-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-12-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="14361">
<meta itemprop="keywords" content="muduo," /><meta property="og:title" content="muduo网络库的使用" />
<meta property="og:description" content="1. echo服务的实现 muduo的使用非常简单，不需要从指定的类派生，也不用覆写虚函数，只需要注册几个回调函数去处理&quot;三个半的事件&" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cui-jiang-tao.github.io/posts/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo网络库的使用"/>
<meta name="twitter:description" content="1. echo服务的实现 muduo的使用非常简单，不需要从指定的类派生，也不用覆写虚函数，只需要注册几个回调函数去处理&quot;三个半的事件&"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://cui-jiang-tao.github.io/posts/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" /><link rel="prev" href="https://cui-jiang-tao.github.io/posts/linux%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" /><link rel="next" href="https://cui-jiang-tao.github.io/posts/makefile/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "muduo网络库的使用",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/cui-jiang-tao.github.io\/posts\/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8\/"
    },"genre": "posts","keywords": "muduo","wordcount":  14361 ,
    "url": "https:\/\/cui-jiang-tao.github.io\/posts\/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8\/","datePublished": "2022-12-16T00:00:00+00:00","dateModified": "2022-12-16T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "cjt"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="学习记录"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span><span id="typeit-header-desktop" class="typeit"></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="学习记录"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span><span id="typeit-header-title-mobile" class="typeit"></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><main class="container" data-page-style="wide"><aside class="toc" id="toc-auto"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>muduo网络库的使用</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="https://www.gravatar.com/avatar/736cc0685dbd22dd674add9c481fc755?s=32&amp;d="
    data-srcset="https://www.gravatar.com/avatar/736cc0685dbd22dd674add9c481fc755?s=32&amp;d=, https://www.gravatar.com/avatar/736cc0685dbd22dd674add9c481fc755?s=32&amp;d= 1.5x, https://www.gravatar.com/avatar/736cc0685dbd22dd674add9c481fc755?s=32&amp;d= 2x"
    data-sizes="auto"
    alt="cjt"
    title="cjt"/>&nbsp;cjt</span></span>
          <span class="post-category">included in <a href="/categories/c/c++/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> c/c++</a></span></div>
      <div class="post-meta-line"><span title=2022-12-16&#32;00:00:00><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-16">2022-12-16</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 14361 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 29 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-echo服务的实现">1. echo服务的实现</a></li>
    <li><a href="#2-七步实现finger服务">2. 七步实现finger服务</a>
      <ul>
        <li><a href="#21-拒绝连接">2.1 拒绝连接</a></li>
        <li><a href="#22-接受新连接">2.2 接受新连接</a></li>
        <li><a href="#23-主动断开连接">2.3 主动断开连接</a></li>
        <li><a href="#24-读取用户名然后断开连接">2.4 读取用户名，然后断开连接</a></li>
        <li><a href="#25-读取用户名输出错误信息然后断开连接">2.5 读取用户名、输出错误信息，然后断开连接</a></li>
        <li><a href="#26-从空的usermap-里查找用户">2.6 从空的UserMap 里查找用户</a></li>
        <li><a href="#27-往usermap里添加一个用户">2.7 往UserMap里添加一个用户</a></li>
      </ul>
    </li>
    <li><a href="#3-五个简单tcp示例">3. 五个简单TCP示例</a>
      <ul>
        <li><a href="#31-discard">3.1 discard</a></li>
        <li><a href="#32-daytime">3.2 daytime</a></li>
        <li><a href="#33-time">3.3 time</a></li>
        <li><a href="#34-echo">3.4 echo</a></li>
        <li><a href="#35-chargen">3.5 chargen</a></li>
        <li><a href="#36-五合一">3.6 五合一</a></li>
      </ul>
    </li>
    <li><a href="#4-文件传输">4. 文件传输</a>
      <ul>
        <li><a href="#41-版本1">4.1 版本1</a></li>
        <li><a href="#42-版本2">4.2 版本2</a></li>
        <li><a href="#43-版本3">4.3 版本3</a></li>
        <li><a href="#44-为什么tcpconnectionshutdown没有直接关闭tcp连接">4.4 为什么TcpConnection::shutdown()没有直接关闭TCP连接？</a></li>
      </ul>
    </li>
    <li><a href="#5-boostasio的聊天服务器">5. Boost.Asio的聊天服务器</a>
      <ul>
        <li><a href="#51-tcp分包">5.1 TCP分包</a></li>
        <li><a href="#52-消息格式">5.2 消息格式</a></li>
        <li><a href="#53-编解码器">5.3 编解码器</a></li>
        <li><a href="#54-服务端的实现">5.4 服务端的实现</a></li>
        <li><a href="#55-客户端的实现">5.5 客户端的实现</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="1-echo服务的实现">1. echo服务的实现</h2>
<p>muduo的使用非常简单，不需要从指定的类派生，也不用覆写虚函数，只需要注册几个回调函数去处理&quot;三个半的事件&quot;就行了。</p>
<p>以经典的echo回显服务为例，定义EchoServer class，不需要派生自任何基类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#ifndef MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// RFC 862
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">EchoServer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">EchoServer</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">EventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">listenAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span> <span class="c1">// calls server_.start();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;echo.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Logging.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// using namespace muduo;
</span></span></span><span class="line"><span class="cl"><span class="c1">// using namespace muduo::net;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">EchoServer</span><span class="o">::</span><span class="n">EchoServer</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">EventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">listenAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;EchoServer&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span> <span class="p">{</span> <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EchoServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; echo &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes, &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="s">&#34;data received at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先EchoServer会在构造函数内注册回调函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>EchoServer::onMessage函数是echo服务的&quot;业务逻辑&quot;：把收到的数据原封不动地发回客户端。注意我们不用担心conn-&gt;send(msg)是否完整地发送了数据，因为muduo网络库会帮我们管理发送缓冲区。</p>
<p>EchoServer::onConnection和EchoServer::onMessage这两个函数体现了&quot;基于事件编程&quot;的经典做法，即程序主体是被动等待事件发生，事件发生之后网络库会调用(回调的方式)事先注册的事件处理函数(event handler)。</p>
<p>在EchoServer::onConnection函数中，conn参数是TcpConnection对象的shared_ptr，TcpConnection::connected函数返回一个bool值，表明目前连接是建立还是断开，TcpConnection 的 peerAddress() 和 localAddress()成员函数分别返回对方和本地的地址(以InetAddress 对象表示的IP和port)。</p>
<p>在onMessage()函数中，conn 参数是收到数据的那个TCP 连接;buf 是已经收到的数据，buf 的数据会累积，直到用户从中取走 (retrieve )数。注意 buf是指针，表明用户代码可以修改 (消费) buffer; time 是收到数据的确切时间，即epoll_wait(2)返回的时间，注意这个时间通常比 read(2)发生的时间略早，可以用于正确测量程序的消息处理延迟。<em>另外，Timestamp 对象采用 pass-by-value，而不是pass-by-(const)reference，这是有意的，因为在 x86-64 上可以直接通过寄存器传参</em>。</p>
<p>在main() 里用 EventLoop 让整个程序跑起来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;echo.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Logging.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// using namespace muduo;
</span></span></span><span class="line"><span class="cl"><span class="c1">// using namespace muduo::net;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2007</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">EchoServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-七步实现finger服务">2. 七步实现finger服务</h2>
<h3 id="21-拒绝连接">2.1 拒绝连接</h3>
<p>什么都不做，程序空等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-接受新连接">2.2 接受新连接</h3>
<p>在1079端口侦听新连接，接受连接之后什么都不做，程序空muduo会自动丢弃收到的数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-主动断开连接">2.3 主动断开连接</h3>
<p>接受新连接之后主动断开。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-读取用户名然后断开连接">2.4 读取用户名，然后断开连接</h3>
<p>如果读到一行以\r\n 结尾的消息，就开连接。注意这段代码有安全问题，如果恶意客户端不断发送数据而不换行，会撑爆服务端的内存。另外，Buffer::findCRLF()是线性查找，如果客户端每次发一个字节，服务端的时间复杂度为 O(N2)，会消耗 CPU资源。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">onMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="25-读取用户名输出错误信息然后断开连接">2.5 读取用户名、输出错误信息，然后断开连接</h3>
<p>如果读到一行以\r\n 结尾的消息，就发送一条出错信息，然后断开连接。安全问题同上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;No such user</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">onMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="26-从空的usermap-里查找用户">2.6 从空的UserMap 里查找用户</h3>
<p>从一行消息中拿到用户名(user)在 UserMap里查找，然后返回结果。安全问题同上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">UserMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UserMap</span> <span class="n">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">string</span> <span class="nf">getUser</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;No such user&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">UserMap</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">users</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">user</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">onMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="27-往usermap里添加一个用户">2.7 往UserMap里添加一个用户</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;EventLoop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;TcpServer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">UserMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UserMap</span> <span class="n">users</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">string</span> <span class="nf">getUser</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;No such user&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">UserMap</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">users</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">user</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">users</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="s">&#34;cjt&#34;</span><span class="p">,</span> <span class="s">&#34;super vip&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">1079</span><span class="p">),</span> <span class="s">&#34;Finger&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">onMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-五个简单tcp示例">3. 五个简单TCP示例</h2>
<p>本节将介绍五个简单TCP 网络服务程序，包括 echo(RFC 862)、discard (RFC863)、chargen (RFC 864)、daytime (RFC 867)、time (RFC 868)这五个协议，以及 time 协议的客户端。各程序的协议简介如下：</p>
<ul>
<li>discard:丢弃所有收到的数据。</li>
<li>daytime:服务端accept 连接之后，以字符串形式发送当前时间，然后主动断开连接。</li>
<li>time:服务端accept 连接之后，以二进制形式发送当前时间 (从Epoch 到现在的秒数)，然后主动断开连接;我们需要一个客户程序来把收到的时间转换为字符串。</li>
<li>echo:回显服务，把收到的数据发回客户端。</li>
<li>chargen:服务端accept 连接之后，不停地发送测试数据。</li>
</ul>
<p>以上五个协议使用不同的端口，可以放到同一个进程中实现，且不必使用多线程。</p>
<h3 id="31-discard">3.1 discard</h3>
<p>discard 恐怕算是最简单的长连接 TCP 应用层协议，它只需要关注&quot;三个半事件&quot;中的&quot;消息/数据到达&quot;事件，事件处理函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DiscardServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">string</span> <span class="nf">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; discards &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes received at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-daytime">3.2 daytime</h3>
<p>daytime 是短连接协议，在发送完当前时间后，由服务端主动断开连接。它只需要关注&quot;三个半事件&quot;中的&quot;连接已建立&quot;事件，事件处理函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DaytimeServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;DaytimeServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">toFormattedString</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果连接已建立，发送时间字符串，主动断开连接。</p>
<p>用netcat扮演客户端，运行结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ nc 127.0.0.1 <span class="m">2013</span>
</span></span><span class="line"><span class="cl"><span class="m">20221224</span> 15:43:38.226748    <span class="c1"># 服务器返回的事件字符串，UTC 时区</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-time">3.3 time</h3>
<p>time 协议与 daytime极为类似，只不过它返回的不是日期时间字符串，而是一个32-bit 整数，表示从1970-01-01 00:00:00Z 到现在的秒数。当然，这个协议有&quot;2038年问题&quot;。服务端只需要关注&quot;三个半事件&quot;中的&quot;连接已建立&quot;事件，事件处理函数如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">TimeServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TimeServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="o">::</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当连接已建立，取当前时间并转换为网络字节序(Big Endian)，发送32-bit整数后主动断开连接。</p>
<p>安装hexdump：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># Step 1: Update system</span>
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2: Install: libdata-hexdump-perl Architecture: all Version: 0.02-1</span>
</span></span><span class="line"><span class="cl">sudo apt-get install libdata-hexdump-perl
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以使用netcat 扮演客户端，并用hexdump来打印二进制数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 暂不清楚什么原因，没效果</span>
</span></span><span class="line"><span class="cl">nc 127.0.0.1 <span class="m">2037</span> <span class="p">|</span> hexdump -C
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>time客户端：</strong></p>
<p>因为 time 服务端发送的是二进制数据，不便直接阅读，我们编写一个客户端来解析并打印收到的4个字节数据。这个程序只需要关注&quot;三个半事件&quot;中的&quot;消息/数据到达&quot;事件，事件处理函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_t</span> <span class="n">time</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Timestamp</span> <span class="n">ts</span><span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Timestamp</span><span class="o">::</span><span class="n">kMicroSecondsPerSecond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Server time = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ts</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; no enough data &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">&lt;&lt;</span> <span class="s">&#34; at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">receiveTime</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意其中考虑到了如果数据没有一次性收全，已经收到的数据会累积在 Buffer里(在else 分支里没有调用 Buffer::retrieve* 系列函数)，以等待后续数据到达程序也不会阻寨。这样即便服务器一个字节一个字节地发送数据，代码还是能正常工作，这也是非阻塞网络编程必须在用户态使用接收缓冲的主要原因。</p>
<p>完整代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TimeClient</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">TimeClient</span><span class="p">(</span><span class="n">EventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span> <span class="n">client_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">,</span> <span class="s">&#34;TimeClient&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TimeClient</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TimeClient</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// client_.enableRetry();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span> <span class="n">client_</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="o">*</span><span class="n">loop_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpClient</span> <span class="n">client_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">time_t</span> <span class="n">time</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Timestamp</span> <span class="n">ts</span><span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">                   <span class="n">Timestamp</span><span class="o">::</span><span class="n">kMicroSecondsPerSecond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Server time = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ts</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; no enough data &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">&lt;&lt;</span> <span class="s">&#34; at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">receiveTime</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2037</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">TimeClient</span> <span class="n">timeClient</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeClient</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s host_ip</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果连接断开了，就退出事件循环，程序也就结束了。</p>
<blockquote>
<p>注意 TcpConnection 对象表示&quot;一次&quot;TCP 连接，连接断开之后不能重建Tcpclient 重试之后新建的连接会是另一个 TcpConnection 对象。</p>
</blockquote>
<h3 id="34-echo">3.4 echo</h3>
<p>前面几个协议都是单向接收或发送数据，echo 是我们遇到的第一个双向的协议:服务端把客户端发过来的数据原封不动地传回去。它只需要关注&quot;三个半事件&quot;中的&quot;消息/数据到达&quot;事件，事件处理函数已在前面列出，这里复制一遍。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; echo &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes, &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="s">&#34;data received at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码实现的不是行回显 (line echo)服务，而是有一点数据就发送一点数据。这样可以避免客户端恶意地不发送换行字符，而服务端又必须缓存已经收到的数据，导致服务器内存暴涨。但这个程序还是有一个安全漏洞，即如果客户端故意不断发送数据，但从不接收，那么服务端的发送缓冲区会一直堆积，导致内存暴涨。解决办法可以参考下面的 chargen 协议，或者在发送缓冲区累积到一定大小时主动断开连接。一般来说，非阻塞网络编程中正确处理数据发送比接收数据要困难，因为要应对对方接收缓慢的情况。</p>
<h3 id="35-chargen">3.5 chargen</h3>
<p>Chargen 协议很特殊，它只发送数据，不接收数据。而且，<strong>它发送数据的速度不能快过客户端接收的速度</strong>，因此需要关注&quot;三个半事件&quot;中的半个&quot;消息/数据发送完毕&quot;事件(onWriteComplete)，事件处理函数如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ChargenServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ChargenServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setTcpNoDelay</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ChargenServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">string</span> <span class="nf">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; discards &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes received at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ChargenServer</span><span class="o">::</span><span class="n">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">transferred_</span> <span class="o">+=</span> <span class="n">message_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在连接建立时发送一次数据，在数据发送完成事件触发时再发送一次数据。</p>
<h3 id="36-五合一">3.6 五合一</h3>
<p>前面五个程序都用到了 EventLoop。这其实是个 Reactor，用于注册和分发IO事件。muduo 遵循 one loop per thread 模型，多个服务端(TcpServer)和客户端(Tcpclient)可以共享同一个EventLoop，也可以分配到多个EventLoop 上以发挥多核多线程的好处。这里我们把五个服务端用同一个EventLoop 跑起来，程序还是单线程的，功能却强大了很多:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span> <span class="c1">// one loop shared by multiple servers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ChargenServer</span> <span class="n">chargenServer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">2019</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">chargenServer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DaytimeServer</span> <span class="n">daytimeServer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">2013</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">daytimeServer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DiscardServer</span> <span class="n">discardServer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">2009</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">discardServer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EchoServer</span> <span class="n">echoServer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">2007</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">echoServer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">TimeServer</span> <span class="n">timeServer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">2037</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">timeServer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个例子充分展示了 Reactor 模式复用线程的能力，让一个单线程程序同时具备多个网络服务功能。一个容易想到的例子是 httpd 同时侦听 80 端口和43 端口，另一个例子是程序中有多个 Tcpclient，分别和数据库、Redis、Sudoku Solver 等后台服务打交道。对于初次接触这种编程模型的读者，值得跟踪代码运行的详细过程，弄清楚每个事件每个回调发生的时机与条件。</p>
<p>以上几个协议的消息格式都非常简单，没有涉及 TCP 网络编程中常见的分包处理，在后文 Boost.Asio 的聊天服务器时我们再来讨论这个问题。</p>
<h2 id="4-文件传输">4. 文件传输</h2>
<p>本节用发送文件的例子来说明 TcpConnection::send()的使用。到目前为止我们用到了 TcpConnection::send() 的两个重载，分别是 send(const string&amp;)和send(const void* message， size_t len)。</p>
<p>TcpConnection 目前提供了三个 send() 重载函数，原型如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// TCP connection, for both client and server usage.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">TcpConnection</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span> <span class="c1">// this one will swap data without copying
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// void send(string&amp;&amp; message); // C++11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// void send(Buffer&amp;&amp; message); // C++11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在非阻塞网络编程中，发送消息通常是由网络库完成的，用户代码不会直接调用write(2)或 send(2) 等系统调用。原因是&quot;Tcponnection 必须要有 outputbuffer&quot;。在使用 TpConnection::send() 时值得注意的有点：</p>
<ul>
<li>send() 的返回类型是 void，意味着用户不必关心调用 send() 时成功发送了多少字节，muduo 库会保证把数据发送给对方。</li>
<li>send() 是非阻塞的。意味着客户代码只管把一条消息准备好，调用 send()来发送，即便 TCP 的发送窗口满了，也绝对不会阻塞当前调用线程。</li>
<li>send() 是线程安全、原子的。多个线程可以同时调用 send()，消息之间不会混叠或交织。但是多个线程同时发送的消息的先后顺序是不确定的，muduo只能保证每个消息本身的完整性。另外，send()在多线程下仍然是非阻塞的。</li>
<li>send(const void* message，size_t en)这个重载最平淡无奇，可以发送任意字节序列。</li>
<li>send(const StringPiece&amp; message)这个重载可以发送std::string利constchar*，其中StringPiece是Google 发明的专门用于传递字符串参数的 class,这样程序里就不必为 const char* 和 const std::string&amp; 提供两份重载了。</li>
<li>send(Buffer*) 有点特殊，它以指针为参数，而不是常见的 const 引用，因为函数中可能用 Buffer::swap()来高效地交换数据，避免内存拷贝，起到类似C++ 右值引用的效果。</li>
<li>如果将来支持 C++11，那么可以增加对右值引用的重载，这样可以用 move 语义来避免内存拷贝。</li>
</ul>
<p>下面我们来实现一个发送文件的命令行小工具，这个工具的协议很简单，在启动时通过命令行参数指定要发送的文件，然后在 2021 端口侦听，每当有新连接进来就把文件内容完整地发送给对方。</p>
<p>如果不考虑并发，那么这个功能用 netcat 加重定向就能实现。这里展示的版本更加健壮，比方说发送 100MB 的文件，支持上万个并发客户连接;内存消耗只与并发连接数有关，跟文件大小无关;任何连接可以在任何时候断开，程序不会有内存泄漏或崩溃。</p>
<p>一共写了三个版本：</p>
<ol>
<li>一次性把文件读入内存，一次性调用 send(const string&amp;)发送完毕。这个版本满足除了&quot;内存消耗只与并发连接数有关，跟文件大小无关&quot;之外的健壮性要求。</li>
<li>一块一块地发送文件，减少内存使用，用到了 writeCompleteCallback。这个版本满足了上述全部健壮性要求。</li>
<li>同2，但是采用 shared_ptr 来管理 FILE*，避免手动调用 ::fclose(3)。</li>
</ol>
<h3 id="41-版本1">4.1 版本1</h3>
<p>在建立好连接之后，把文件的全部内容读入一个 string，一次性调用 TcpConnection::send() 发送。不用担心文件发送不完整。也不用担心 send() 之后立刻shutdown()会有什么问题，见下一节的说明。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// FIXME: use FileUtil::readFile()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">string</span> <span class="nf">readFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">string</span> <span class="n">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// inefficient!!!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">iobuf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">::</span><span class="n">setbuffer</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">iobuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">content</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">fileContent</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">(</span><span class="n">g_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fileContent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意每次建立连接的时候我们都去重新读一遍文件，这是考虑到文件有可能被其他程序修改。如果文件是 immutable 的，整个程序就可以共享同一个 fileContent对象。</p>
<p>这个版本有一个明显的缺陷，即内存消耗与(并发连接数  文件大小)成正比文件越大内存消耗越多，如果文件大小上 GB，那几乎就是灾难了。只需要建立少量并发连接就能把服务器的内存耗尽，因此我们有了版本2。</p>
<h3 id="42-版本2">4.2 版本2</h3>
<p>为了解决版本一占用内存过多的问题，我们采用流水线的思路，当新建连接时,先发送文件的前 64KiB 数据，等这块数据发送完毕时再继续发送下64KiB 数据，如此往复直到文件内容全部发送完毕。代码中使用了 TcpConnection::setContext()和getContext()来保存 Tcponnection 的用户上下文(这里是 FILE*)，因此不必使用额外的std::map&lt;TcponnectionPtr，FILE*&gt;来记住每个连接的当前文件位置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="n">kBufSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - no such file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">FILE</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">FILE</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 会触发onWriteComplete回调函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">onWriteComplete</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在onWriteComplete()回调函数中读取下一块文件数据，继续发送。</p>
<p>注意每次建立连接的时候我们都去重新打开那个文件，使得程序中文件描述符的数量翻倍(每个连接占一个 socket fd 和一个 file fd )，这是考到文件有可能被其他程序修改。如果文件是immutable 的，一种改进措施是：整个程序可以共享同一个文件描述符，然后每个连接记住自已当前的偏移量，在onWriteComplete() 回调函数里用 pread(2)来读取数据。</p>
<p>这个版本也存在一个问题，如果客户端故意只发起连接，不接收数据，那么要么把服务器进程的文件描述符耗尽，要么占用很多服务端内存(因为每个连接有 64KiB的发送缓冲区)。解决办法可参考后文&quot;限制服器的最并发连接数&quot;和&quot;用timing wheel踢掉空闲连接&quot;。必须说明的是，muduo并不是设计来编写面向公网的网络服务程序，这种服务程序需要在安全性方面下很多工夫，我个人对此不在行，我更关心实现内网(不一定是局域网 )的高效服务程序。</p>
<h3 id="43-版本3">4.3 版本3</h3>
<p>用 shared_ptr的custom deleter 来减轻资源管理负担，使得 FILE* 的生命期和TcpConnection 一样长，代码也更简单了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FILE</span><span class="o">&gt;</span> <span class="n">FilePtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="n">kBufSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">FilePtr</span> <span class="n">ctx</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">::</span><span class="n">fclose</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - no such file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">FilePtr</span> <span class="o">&amp;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">FilePtr</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">get_pointer</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">onWriteComplete</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上代码体现了现代 C++ 的资源管理思路，即无须手动释放资源，而是通过将资源与对象生命期绑定，在对象析构的时候自动释放资源，从而把资源管理转换为对象生命期管理，而后者是早已解决了的问题。这正是 C++ 最重要的编程技法:RAII。</p>
<h3 id="44-为什么tcpconnectionshutdown没有直接关闭tcp连接">4.4 为什么TcpConnection::shutdown()没有直接关闭TCP连接？</h3>
<p>&ldquo;在simple的daytime示例中，服务端主动关闭时调用的是如下函数序列，这不是只是关闭了连接上的写操作吗，怎么是关闭了整个连接?&rdquo;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DaytimeServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">toFormattedString</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdown</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// FIXME: use compare and swap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnecting</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// FIXME: shared_from_this()?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果当前没有发送数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// we are not writing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">shutdownWrite</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">shutdownWrite</span><span class="p">()</span> <span class="p">{</span> <span class="n">sockets</span><span class="o">::</span><span class="n">shutdownWrite</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 只关闭写的这一半，进入半关闭状态(close SHUT_WR)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">sockets</span><span class="o">::</span><span class="n">shutdownWrite</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">shutdown</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">SHUT_WR</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;sockets::shutdownWrite&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>muduo TcpConnection 没有提供 close()，而只提供 shutdown()，这么做是为了收发数据的完整性</strong>。</p>
<p>TCP 是一个全双工协议，同一个文件描述符既可读又可写，shutdownWrite()关闭了&quot;写&quot;方向的连接，保留了&quot;读&quot;方向，这称为 TCP half-close。如果直接close(socket_fd)，那么 socket_fd 就不能读或写了。</p>
<p>用 shutdown 而不用close 的效果是，如果对方已经发送了数据，这些数据还&quot;在路上&quot;，那么muduo 不会漏收这些数据。换句话说，muduo 在 TCP这一层面解决了&quot;当你打算关闭网络连接的时候，如何得知对方是否发了一些数据而你还没有收到?这一问题。当然，这个问题也可以在上面的协议层解决，双方商量好不再互发数据就可以直接断开连接。</p>
<p>也就是说 muduo 把&quot;主动关闭连接&quot;这件事情分成两步来做，如果要主动关闭连接，它会先关本地&quot;写&quot;端，等对方关闭之后，再关本地&quot;读&quot;端。</p>
<p>另外，如果当前 output buffer 里还有数据尚未发出的话，muduo 也不会立刻调用 shutdownWrite，而是等到数据发送完毕再shutdown，可以避免对方漏收数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 内核发送缓冲区有空间了，回调该函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleWrite</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span> <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">peek</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                               <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// 发送缓冲区已清空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableWriting</span><span class="p">();</span> <span class="c1">// 停止关注POLLOUT事件，以免出现busy loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">)</span> <span class="c1">// 回调writeCompleteCallback_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 应用层发送缓冲区被清空，就回调用writeCompleteCallback_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 发送缓冲区已清空并且连接状态是kDisconnecting，要关闭连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">shutdownInLoop</span><span class="p">();</span> <span class="c1">// 只关闭写的这一半，进入半关闭状态(close SHUT_WR)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;I am going to write more data&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::handleWrite&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// if (state_ == kDisconnecting)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//   shutdownInLoop();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connection fd = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">&lt;&lt;</span> <span class="s">&#34; is down, no more writing&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>思考题：为什么sockets::write只写一次？</p>
<p>这是因为当应用层发送缓冲区的数据没全部写到内核发送缓冲区中，就不会停止关注POLLOUT事件；所以当内核发送缓冲区有空间了，回调TcpConnection::handleWrite()函数，直至应用层发送缓冲区的数据全都写入到了内核发送缓冲区里。</p>
<p>muduo这种关闭连接的方式对对方也有要求，那就是对方 read()到0字节之后会主动关闭连接(无论 shutdownWrite()还是close())，一般的网络序都会这样不是什么问题。当然，这么做有一个潜在的安全漏洞，万一对方故意不关闭连接，那么muduo 的连接就一直半开着，消耗系统资源。必要时可以调用 TcpConnection::handleClose()来强行关闭连接，这需要将 handleClose() 改为 public 成员函数。</p>
<p>完整的流程见下图。我们发完了数据，于是 shutdownWrite，发送TCP FIN 分节，对方会读到0字节，然后对方通常会关闭连接。这样 muduo 会读到0字节，然后muduo 关闭连接。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="../../imgs/muduo/shutdown.png"
    data-srcset="../../imgs/muduo/shutdown.png, ../../imgs/muduo/shutdown.png 1.5x, ../../imgs/muduo/shutdown.png 2x"
    data-sizes="auto"
    alt="muduo关闭连接"
    title="muduo关闭连接"/></p>
<p>思考题:在 shutdown()之后，muduo 回调 connection callback的时间间隔大约是一个round-trip time，为什么?</p>
<p>如果有必要，对方可以在 read() 返回 0之后继续发送数据，这是直接利用了half-close TCP连接。muduo 不会漏收这些数据。</p>
<p>那么muduo什么时候真正 close socket 呢?在 TcpConnection 对象析构的时候。TcpConnection持有一个Socket 对象，Socket 是一个RAIIhandler，它的析构函数会close(sockfd_)。这样，如果发生 TcpConnection 对象泄漏，那么我们从/proc/pid/fd/就能找到没有关闭的文件描述符，便于查错。</p>
<p>muduo 在 read() 返回0的时候会回调 connection callback，TcpServer 或 Tcp-client 把 TcpConnection 的引用计数减一。如果引用计数降到零，则表明用户代码也不持有 TcpConnection，它就会析构了。</p>
<h2 id="5-boostasio的聊天服务器">5. Boost.Asio的聊天服务器</h2>
<p>本节将介绍一个与 Boost.Asio 的示例代码中的聊天服务器功能类似的网络服务程序，包括客户端与服务端的 muduo 实现。这个例子的主要目的是介绍如何处理分包，并初步涉及muduo的多线程功能。</p>
<h3 id="51-tcp分包">5.1 TCP分包</h3>
<p>&ldquo;五个简单TCP示例&quot;中处理的协议没有涉及分包，在TCP这种字节流协议上做应用层分包是网络编程的基本需求。分包指的是在发生一个消息 (message或一帧 (frame) 数据时，通过一定的处理，让接收方能从字节流中识别并截取(还原)出一个个消息。&ldquo;粘包问题&quot;是个伪问题。</p>
<p>对于短连接的 TCP 服务，分包不是一个问题，只要发送方主动关闭连接，就表示一条消息发送完毕，接收方 read() 返回0从而知道消息的结尾。例如daytime 和 time 协议。</p>
<p>对于长连接的 TCP 服务，分包有四种方法:</p>
<ol>
<li>消息长度固定，比如 muduo 的roundtrip 示例就采用了固定的 16 字节消息。</li>
<li>使用特殊的字符或字符串作为消息的边界，例如 HTTP 协议的 headers 以&quot;r\n&quot;为字段的分隔符。</li>
<li>在每条消息的头部加一个长度字段，这恐怕是最常见的做法，本文的聊天协议也采用这一办法。</li>
<li>利用消息本身的格式来分包，例如XML 格式的消息中 <root>&hellip;</root>的配对，或者JSON 格式中的{ &hellip; }的配对。解析这种消息格式通常会用到状态机 ( state machine )</li>
</ol>
<p>在后文的代码讲解中还会仔细讨论用长度字段分包的常见陷阱。</p>
<p><strong>聊天服务</strong></p>
<p>本节实现的聊天服务非常简单，由服务端程序和客户端程序组成，协议如下：</p>
<ul>
<li>服务端程序在某个端口侦听(listen)新的连接。</li>
<li>客户端向服务端发起连接。</li>
<li>连接建立之后，客户端随时准备接收服务端的消息并在屏幕上显示出来.</li>
<li>客户端接受键盘输入，以回车为界，把消息发送给服务端。</li>
<li>服务端接收到消息之后，依次发送给每个连接到它的客户端;原来发送消息的客户端进程也会收到这条消息。</li>
<li>一个服务端进程可以同时服务多个客户端进程。当有消息到达服务端后，每个客户端进程都会收到同一条消息，服务端广播发送消息的顺序是任意的，不一定哪个客户端会先收到这条消息。</li>
<li>(可选)如果消息A 先于消息 B 到达服务端，那每个客户端都会先收到A再收到 B。</li>
</ul>
<p>这实际上是一个简单的基于 TCP 的应用层广播协议，由服务端负责把消息发送给每个连接到它的客户端。参与&quot;聊天&quot;的既可以是人，也可以是程序。在后文，我将介绍一个稍微复杂一点的例子 hub，它有&quot;聊天室&quot;的功能，客户端可以注册特定的 topic(s)，并往某个 topic 发送消息，这样代码更有意思。</p>
<p>我在&quot;谈一谈网络编程学习经验&rdquo;(附录A)中把聊天服务列为&quot;最主要的三个例子&quot;之一，其与前面的&quot;五个简单 TCP 协议&quot;不同，聊天服务的特点是&quot;连接之间的数据有交流，从a 连接收到的数据要发给 b 连接。这样对连接管理提出了更高的要求:如何用一个程序同时处理多个连接?fork()-per-connection 似乎是不行的。如何防止串话?b 有可能随时断开连接，而新建立的连接 可能恰好复用了 b的文件描述符，那么 a 会不会错误地把消息发给 c?&ldquo;muduo 的这个例子充分展示了解决以上问题的手法。</p>
<h3 id="52-消息格式">5.2 消息格式</h3>
<p>本聊天服务的消息格式非常简单，&ldquo;消息&quot;本身是一个字符串，每条消息有一个4 字节的头部，以网络序存放字符串的长度。消息之间没有间隙，字符串也不要求以&rsquo;结尾。比方说有两条消息&quot;hello&quot;和&quot;chenshuo&rdquo;，那么打包后的字节流共有21字节:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x05</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">e</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">o</span><span class="err">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x08</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">c</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">e</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">n</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">s</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">u</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">o</span><span class="err">&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>打包的代码</strong> 这段代码把 string message 打包为muduo::net::Buffer，并通过conn发送。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// codec.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">StringPiece</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>muduo Buffer 有一个很好的功能，它在头部预留了8 个字节的空间，这样prepend()操作就不需要移动已有的数据，效率较高。</p>
<p><strong>分包的代码</strong> 解析数据往往比生成数据更复杂，分包、打包也不例外。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// codec.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">kHeaderLen</span><span class="p">)</span> <span class="c1">// kHeaderLen == 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// FIXME: use Buffer::peekInt32()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="c1">// SIGBUS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Invalid length &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span> <span class="c1">// FIXME: disable reading
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 代表一组消息已到达
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">kHeaderLen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">kHeaderLen</span><span class="p">);</span> <span class="c1">//移动4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">messageCallback_</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">receiveTime</span><span class="p">);</span> <span class="c1">//处理读取的消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>onMessage()中构造完整的消息，通过 messageCallback_回调用户代码。有潜在的问题，在某些不支持非对齐内存访问的体系结构上会造成SIGBUScore dump，读取消息长度应该改用 Buffer::peekInt32()。上面这段代码用了 while 循环来反复读取数据，直到 Buffer 中的数据不够一条完整的消息。请读者思考，(如果换成 if (buf-&gt;readableBytes() &gt;= kHeaderLen) 会有什么后果。</p>
<p>以前面提到的两条消息的字节流为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x05</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">e</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">o</span><span class="err">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x00</span><span class="p">,</span> <span class="mi">0x08</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">c</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">e</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">n</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">s</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">h</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">u</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">o</span><span class="err">&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>假设数据最终都全部到达，onMessage()至少要能正确处理以下各种数据到达的次序每种情况下messageCallback_都应该被调用两次:</p>
<ol>
<li>每次收到一个字节的数据，onMessage() 被调用21次;</li>
<li>数据分两次到达，第一次收到 2个字节，不足消息的度字段;</li>
<li>数据分两次到达，第一次收到4 个字节，刚好够长度字段，但是没有 body;</li>
<li>数据分两次到达，第一次收到8 个字节，长度完整，但 body 不完整;</li>
<li>数据分两次到达，第一次收到9 个字节，长度完整，body 也完整;</li>
<li>数据分两次到达，第一次收到 10 个字节，第一条消息的长度完整、body 也完整，第二条消息长度不完整;</li>
<li>请自行移动和增加分点，验证各种情况：一共有超过 100 万种可能(2^21-1)。</li>
<li><strong>数据一次就全部到达，这时必须用 while 循环来读出两条消息，否则消息会堆积在Buffer中</strong>。</li>
</ol>
<p>请读者验证 onMessage() 是否做到了以上几点。这个例子充分说明了 nonblocking read 必须和input buffer 一起使用。而且在写 decoder 的时候一定要在收到完整的消息之后再 retrieve 整条消息，除非接收方使用复杂的状态机来解码。</p>
<h3 id="53-编解码器">5.3 编解码器</h3>
<p>有人评论 muduo 的接收缓冲区不能设置回调函数的触发条件，确实如此。每当 socket 可读时，muduo 的TpConnection 会读取数据并存 input buffer，然后回调用户的函数。不过，一个简单的间接层就能解决问题，让用户代码只关心&quot;消息到达&quot;而不是&quot;数据到达&rdquo;，如本例中的 LengthHeaderCodec 所展示的那样。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// codec.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">LengthHeaderCodec</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="n">StringMessageCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">explicit</span> <span class="nf">LengthHeaderCodec</span><span class="p">(</span><span class="k">const</span> <span class="n">StringMessageCallback</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">messageCallback_</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">kHeaderLen</span><span class="p">)</span> <span class="c1">// kHeaderLen == 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// FIXME: use Buffer::peekInt32()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="c1">// SIGBUS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Invalid length &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span> <span class="c1">// FIXME: disable reading
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 代表一组消息已到达
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">kHeaderLen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">kHeaderLen</span><span class="p">);</span> <span class="c1">//移动4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">messageCallback_</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">receiveTime</span><span class="p">);</span> <span class="c1">//处理读取的消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// FIXME: TcpConnectionPtr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">StringPiece</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">StringMessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="k">static</span> <span class="n">size_t</span> <span class="n">kHeaderLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码把以 Buffer* 为参数的 MessageCallback 转换成了以const string&amp;为参数的 StringMessageCallback，让用户代码不必关心分包操作。如果编程语言相同，客户端和服务端可以(应该)共享同一个codec，这样既节省工作量，又避免因对协议理解不一致而导致的错误。</p>
<h3 id="54-服务端的实现">5.4 服务端的实现</h3>
<p>聊天服务器的服务端代码小于 100 行，不到 asio 的一半。</p>
<p>除了经常见到的 EventLoop 和TcpServer，ChatServer 还定义了 codec_和 connections_作为成员，后者存放目前已建立的客户连接。在收到消息之后，服务器会遍历整个容器，把消息广播给其中的每一个TCP连接(onStringMessage())。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ChatServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">ChatServer</span><span class="p">(</span><span class="n">EventLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">listenAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;ChatServer&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">codec_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onStringMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LengthHeaderCodec</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span> <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">connections_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">Timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LengthHeaderCodec</span> <span class="n">codec_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ConnectionList</span> <span class="n">connections_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先，在构造函数里注册回调;</p>
<p>这里有儿点值得注意，在以往的代码里是直接把本 class 的 onMessage() 注册给 server_; 这里我们把 LengthHeaderCodec::onMessage()注册给 server_，然后向codec_注册了 ChatServer::onStringMessage()，等于说让 codec_负责解析消息，然后把完整的消息回调给 chatServer。这正是我前面提到的&quot;一个简单的间接层&rdquo;，在不增加 muduo 库的复杂度的前提下，提供了足够的灵活性让我们在用户代码里完成
需要的工作。</p>
<p>另外，server_.start() 绝对不能在构造函数里调用，这么做将来会有线程安全的问题。</p>
<p>以下是处理连接的建立和断开的代码，注意它把新建的连接加人到 connections_容器中，把已断开的连接从容器中删除。这么做是为了避免内存和资源泄漏，TcpConnectionPtr是boost::shared_ptr<TcpConnection>，是muduo 里唯一一个默认采用 shared_ptr 来管理生命期的对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">connections_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下是服务端处理消息的代码，它遍历整个 connections_容器，把消息打包发送给各个客户连接。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">Timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="55-客户端的实现">5.5 客户端的实现</h3>
<p>我有时觉得服务端的程序常常比客户端的更容易写，聊天服务器再次验证了我的看法。客户端的复杂性来自于它要读取键盘输人，而 EventLoop 是独占线程的，所以我用了两个线程:main()函数所在的线负责读键盘，另外用一个EventLoopThread来处理网络IO。</p>
<p>现在来看代码，首先，在构造函数里注册回调，并使用了跟前面一样的 LengthHeaderCodec 作为中间层，负责打包、分包。</p>
<p>write()会由 main 线程调用，所以要加锁，这个锁不是为了保护TcpConnection而是为了保护shared_ptr。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">connection_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="n">connection_</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>onConnection()会由 EventLoop 线程调用，所以要加锁以保护 shared_ptr。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">connection_</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">connection_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>把收到的消息打印到屏幕，这个函数由 EventLoop 线程调用，但是不用加锁，因为 printf() 是线程安全的。注意这里不能用 std::cout&laquo;，它不是线程安全的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span> <span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">Timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;&lt;&lt;&lt; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>main()函数里除了例行公事，还要启动 EventLoop 线程和读取键盘输人。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopThread</span> <span class="n">loopThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">port</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChatClient</span> <span class="n">client</span><span class="p">(</span><span class="n">loopThread</span><span class="p">.</span><span class="n">startLoop</span><span class="p">(),</span> <span class="n">serverAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">client</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">);</span> <span class="c1">// 发送数据行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span><span class="p">.</span><span class="n">disconnect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">CurrentThread</span><span class="o">::</span><span class="n">sleepUsec</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">// wait for disconnect, see ace/logging/client.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s host_ip port</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Chatclient 使用 EventLoopThread 的 EventLoop，而不是通常的主线程的EventLoop。</p>
<p><strong>简单测试</strong></p>
<p>打开三个命令行窗口，在第一个窗口运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./asio_chat_server <span class="m">3000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在第二个窗口运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./asio_chat_client 127.0.0.1 <span class="m">3000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在第三个窗口运行同样的命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./asio_chat_client 127.0.0.1 <span class="m">3000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样就有两个客户端进程参与聊天。在第二个窗口里输人一些字符并回车，字符会出现在本窗口和第三个窗口中。</p>
<p>代码示例中还有另外三个 server 程序，都是多线程的，详细介绍在 p.260。</p>
<ul>
<li>server_threaded.cc 使用多线程 TcpServer，并用mutex 来保护共享数据。</li>
<li>server_threaded_eficient.cc 对共享数据以&quot;借 shared_ptr 实现 copy-on-write&quot;的手法来降低锁竞争。</li>
<li>server_threaded_highperformance.cc 采用thread local变量，实现多线程高效转发，这个例子值得仔细阅读理解。</li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-12-16&#32;00:00:00>Updated on 2022-12-16&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://cui-jiang-tao.github.io/posts/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" data-title="muduo网络库的使用" data-hashtags="muduo"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://cui-jiang-tao.github.io/posts/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" data-hashtag="muduo"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://cui-jiang-tao.github.io/posts/muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" data-title="muduo网络库的使用"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/muduo/' class="post-tag">muduo</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/linux%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" class="post-nav-item" rel="prev" title="Linux入门学习"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Linux入门学习</a>
      <a href="/posts/makefile/" class="post-nav-item" rel="next" title="makefile的简单例子">makefile的简单例子<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":-1},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-desktop":"Home","typeit-header-title-mobile":"Home"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},"duration":-1,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
